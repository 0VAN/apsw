<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content="HTML Tidy for Linux (vers 6 November 2007), see www.w3.org" />

  <title>APSW - Another Python SQLite Wrapper</title>
  <style type="text/css">
/*<![CDATA[*/
  body { 
  font-family: verdana, arial, helvetica, sans-serif;
  margin: 20px;
  background-color: #ffcc99;
  padding: 7px;
  }
  .pynumber    { color: #0080C0;}
  .pyoperator  { color: #0000C0;}
  .pystring    { color: #004080;}
  .pycomment   { color: #008000;}
  .pyname      { color: #000000;}
  .pyerror     { color: #FF8080;}
  .pykeyword   { color: #C00000;}
  .pytext      { color: #000000;}
  .pyoutput    { color: #0000FF;}

  }
  /*]]>*/
  </style>
</head>

<body>
  <h1 class="notoc">APSW - Another Python SQLite Wrapper</h1>

  <p><font size="-1">apsw-3.6.3-r1 31st July 2008</font> (Use with SQLite 3.6.2 or later, Python 2.3 or later including
  Python 3)</p>

  <p>APSW provides an SQLite 3 wrapper that provides the thinnest layer over <a href="http://www.sqlite.org">SQLite
  3</a> possible. Everything you can do from the <a href="http://www.sqlite.org/c3ref/intro.html">C API</a> to SQLite
  3, you can do from Python. Although APSW looks vaguely similar to the <a href=
  "http://www.python.org/peps/pep-0249.html">DBAPI</a>, it is <a href="#dbapinotes">not compliant</a> with that API and
  instead works the way SQLite 3 does. (<a href="http://www.pysqlite.org">pysqlite</a> is DBAPI compliant - <a href=
  "#pysqlitediffs">differences between apsw and pysqlite 2</a>).</p>

  <h1 class="notoc">Table of contents</h1>

  <table cellspacing="5" cellpadding="5" summary="Table of contents">
    <tr>
      <td valign="top">
        <!--toc-->

        <ul>
          <li>
            <a href="#Download">Download</a>

            <ul>
              <li><a href="#Source">Source and binaries</a></li>

              <li><a href="#Sourcecode">Source code control</a></li>
            </ul>
          </li>

          <li><a href="#SQLiteVersionCompatibilityAndBenchmarking">SQLite version compatibility and
          benchmarking</a></li>

          <li><a href="#Example">Example</a></li>

          <li>
            <a href="#Building">Building</a>

            <ul>
              <li><a href="#Finding">Finding SQLite 3</a></li>

              <li><a href="#Recommended">Recommended</a></li>

              <li><a href="#testing">Testing</a></li>
            </ul>
          </li>

          <li>
            <a href="#APIReference">API Reference</a>

            <ul>
              <li><a href="#module-methods">Module methods</a></li>

              <li><a href="#Module_variables">Module variables</a></li>

              <li><a href="#Module_constants">Module constants</a></li>

              <li><a href="#Connection_class">Connection class</a></li>

              <li><a href="#blobio">Blob I/O</a></li>

              <li><a href="#Cursor">Cursor class</a></li>

              <li><a href="#VirtualTables">Virtual Tables</a></li>

              <li><a href="#VFS">VFS</a></li>
            </ul>
          </li>

          <li>
            <a href="#Exceptions">Exceptions</a>

            <ul>
              <li><a href="#augmentedstacktraces">Augmented stack traces</a></li>
            </ul>
          </li>

          <li><a href="#Types">Types</a></li>

          <li><a href="#Unicode">Unicode</a></li>

          <li><a href="#threading">Multi-threading and re-entrancy</a></li>

          <li>
            <a href="#tracers">Tracing</a>

            <ul>
              <li><a href="#executiontracer">Execution Tracer</a></li>

              <li><a href="#rowtracer">Row Tracer</a></li>
            </ul>
          </li>

          <li><a href="#64bitpy25">64 bit hosts, Python 2.5+</a></li>

          <li><a href="#executionmodel">Execution model</a></li>
        </ul>
      </td>

      <td valign="top">
        <ul>
          <li>
            <a href="#dbapinotes">DBAPI notes</a>

            <ul>
              <li><a href="#dbapimodiface">Module Interface</a></li>

              <li><a href="#dpapiconnectioniface">Connection Objects</a></li>

              <li><a href="#dbapicursoriface">Cursor Objects</a></li>

              <li><a href="#dpapitypes">Type objects</a></li>

              <li><a href="#dbapiextensions">Optional DB API Extensions</a></li>
            </ul>
          </li>

          <li><a href="#pysqlitediffs">pysqlite differences</a></li>

          <li><a href="#copyrightlicense">Copyright and License</a></li>

          <li>
            <a href="#verhistory">Version History</a>

            <ul>
              <li><a href="#363r1">3.6.3-r1</a></li>

              <li><a href="#359r2">3.5.9-r2</a></li>

              <li><a href="#359r1">3.5.9-r1</a></li>

              <li><a href="#3313r1">3.3.13-r1</a></li>

              <li><a href="#3310r1">3.3.10-r1</a></li>

              <li><a href="#339r1">3.3.9-r1</a></li>

              <li><a href="#338r1">3.3.8-r1</a></li>

              <li><a href="#337r1">3.3.7-r1</a></li>

              <li><a href="#335r1">3.3.5-r1</a></li>

              <li><a href="#327r1">3.2.7-r1</a></li>

              <li><a href="#322r1">3.2.2-r1</a></li>

              <li><a href="#321r1">3.2.1-r1</a></li>

              <li><a href="#313r1">3.1.3-r1</a></li>

              <li><a href="#308r3">3.0.8-r3</a></li>

              <li><a href="#308r2">3.0.8-r2</a></li>

              <li><a href="#308r1">3.0.8-r1</a></li>
            </ul>
          </li>
        </ul><!--endtoc-->
      </td>
    </tr>
  </table>

  <h1><a name="Download" id="Download">Download</a></h1>

  <h2><a name="Source" id="Source">Source and binaries</a></h2>

  <p>You can download this release in source or binary form.</p>

  <ul>
    <li><a href="http://apsw.googlecode.com/files/apsw-3.5.9-r2.zip">apsw-3.5.9-r2.zip</a> (source)</li>

    <li><a href="http://apsw.googlecode.com/files/apsw-3.5.9-r2.win32-py2.3.exe">apsw-3.5.9-r2.win32-py2.3.exe</a>
    (Windows Python 2.3)</li>

    <li><a href="http://apsw.googlecode.com/files/apsw-3.5.9-r2.win32-py2.4.exe">apsw-3.5.9-r2.win32-py2.4.exe</a>
    (Windows Python 2.4)</li>

    <li><a href="http://apsw.googlecode.com/files/apsw-3.5.9-r2.win32-py2.5.exe">apsw-3.5.9-r2.win32-py2.5.exe</a>
    (Windows Python 2.5)</li>
  </ul>

  <p>Some Linux distributions also have packages. Debian/Ubuntu users can grab the package <a href=
  "http://packages.debian.org/python-apsw">python-apsw</a>. Gentoo users can grab the package <a href=
  "http://www.gentoo-portage.com/dev-python/apsw">dev-python/apsw</a>.</p>

  <h2><a name="Sourcecode" id="Sourcecode">Source code control</a></h2>

  <p>The source is controlled by Subversion documented at <a href=
  "http://code.google.com/p/apsw/source/checkout">http://code.google.com/p/apsw/source/checkout</a></p>

  <h1><a name="SQLiteVersionCompatibilityAndBenchmarking" id="SQLiteVersionCompatibilityAndBenchmarking">SQLite version
  compatibility and benchmarking</a></h1>

  <p>APSW binds to the C interface of SQLite. That interface is stable for each major version of SQLite (ie the C
  interface for any SQLite 3.x is stable, but SQLite 4.x would be an incompatible change). Consequently you can use
  APSW against any revision of SQLite with the same major version number. There are small enhancements to the C api
  over time, and APSW adds support for them as appropriate. The version number of APSW covers the version these
  enhancements were added. The vast majority of changes to SQLite are in the SQL syntax and engine. Those will be
  picked up with any version of APSW. The one exception to this is experimental features in SQLite which may change API
  between revisions. Consequently you will need to turn them off if you want to work against a variety of versions of
  SQLite (see EXPERIMENTAL in <code>setup.py</code>). I strongly recommend you embed the SQLite library into APSW which
  will put you in control of versions.</p>

  <p>Before you do any benchmarking with APSW or other ways of accessing SQLite, you must understand how and when
  SQLite does transactions. See section 7.0, <i>Transaction Control At The SQL Level</i> of <a href=
  "http://sqlite.org/lockingv3.html">sqlite.org/lockingv3.html</a>. <b>APSW does not alter SQLite's behaviour with
  transactions.</b> Some access layers try to interpret your SQL and manage transactions behind your back, which may or
  may not work well with SQLite also do its own transactions. You should always manage your transactions yourself. For
  example to insert 1,000 rows wrap it in a single transaction else you will have 1,000 transactions. The best clue
  that you have one transaction per statement is having a maximum of 60 statements per second. You need two drive
  rotations to do a transaction - the data has to be committed to the main file and the journal - and 7200 RPM drives
  do 120 rotations a second. On the other hand if you don't put in the transaction boundaries yourself and get more
  than 60 statements a second, then your access mechanism is silently starting transactions for you. This topic also
  comes up fairly frequently in the SQLite mailing list archives.</p>

  <h1><a name="Example" id="Example">Example</a></h1>

  <p>This is an example of how to use apsw, and also demonstrates all the features.</p>

  <blockquote>
    <pre>
<!--sourcestart-->
<font face="Lucida,Courier New,monospace"><span class="pykeyword">import </span><span class=
"pyname">os</span><span class="pyoperator">, </span><span class="pyname">sys</span><span class=
"pyoperator">, </span><span class="pyname">time
</span><span class="pykeyword">import </span><span class="pyname">apsw

</span><span class="pycomment">###
### Check we have the expected version of apsw and sqlite
###

</span><span class="pykeyword">print </span><span class="pystring">"      Using APSW file"</span><span class=
"pyoperator">,</span><span class="pyname">apsw</span><span class="pyoperator">.</span><span class=
"pyname">__file__                </span><span class="pycomment"># from the extension module
</span><span class="pykeyword">print </span><span class="pystring">"         APSW version"</span><span class=
"pyoperator">,</span><span class="pyname">apsw</span><span class="pyoperator">.</span><span class=
"pyname">apswversion</span><span class="pyoperator">()           </span><span class=
"pycomment"># from the extension module
</span><span class="pykeyword">print </span><span class="pystring">"   SQLite lib version"</span><span class=
"pyoperator">,</span><span class="pyname">apsw</span><span class="pyoperator">.</span><span class=
"pyname">sqlitelibversion</span><span class="pyoperator">()      </span><span class=
"pycomment"># from the sqlite library code
</span><span class="pykeyword">print </span><span class="pystring">"SQLite header version"</span><span class=
"pyoperator">,</span><span class="pyname">apsw</span><span class="pyoperator">.</span><span class=
"pyname">SQLITE_VERSION_NUMBER   </span><span class="pycomment"># from the sqlite header file at compile time

</span><span class="pyoutput">         Using APSW file /space/apsw/apsw.so
            APSW version 3.6.3-r1
      SQLite lib version 3.6.3
   SQLite header version 3006003
</span>
<span class="pycomment">###
### Opening/creating database
###

</span><span class="pykeyword">if </span><span class="pyname">os</span><span class="pyoperator">.</span><span class=
"pyname">path</span><span class="pyoperator">.</span><span class="pyname">exists</span><span class=
"pyoperator">(</span><span class="pystring">"dbfile"</span><span class="pyoperator">): </span><span class=
"pyname">os</span><span class="pyoperator">.</span><span class="pyname">remove</span><span class=
"pyoperator">(</span><span class="pystring">"dbfile"</span><span class="pyoperator">)
</span><span class="pyname">connection</span><span class="pyoperator">=</span><span class=
"pyname">apsw</span><span class="pyoperator">.</span><span class="pyname">Connection</span><span class=
"pyoperator">(</span><span class="pystring">"dbfile"</span><span class="pyoperator">)
</span><span class="pyname">cursor</span><span class="pyoperator">=</span><span class=
"pyname">connection</span><span class="pyoperator">.</span><span class="pyname">cursor</span><span class=
"pyoperator">()

</span><span class="pycomment">###
### simple statement
###

</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"create table foo(x,y,z)"</span><span class="pyoperator">)

</span><span class="pycomment">###
### using different types
###

</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into foo values(?,?,?)"</span><span class="pyoperator">, (</span><span class=
"pynumber">1</span><span class="pyoperator">, </span><span class="pynumber">1.1</span><span class=
"pyoperator">, </span><span class="pyname">None</span><span class="pyoperator">))  </span><span class=
"pycomment"># integer, float/real, Null
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into foo(x) values(?)"</span><span class="pyoperator">, (</span><span class=
"pystring">"abc"</span><span class="pyoperator">, ))        </span><span class=
"pycomment"># string (note trailing comma to ensure tuple!)
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into foo(x) values(?)"</span><span class="pyoperator">,                   </span><span class=
"pycomment"># a blob (binary data)
                    </span><span class="pyoperator">(</span><span class="pyname">buffer</span><span class=
"pyoperator">(</span><span class="pystring">"abc\xff\xfe"</span><span class=
"pyoperator">), ))                   </span><span class="pycomment"># Use b"abc\xff\xfe" for Python 3

###
### multiple statements
###

</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"delete from foo; insert into foo values(1,2,3); create table bar(a,b,c) ; insert into foo values(4, 'five', 6.0)"</span><span class="pyoperator">)

</span><span class="pycomment">###
### iterator
###

</span><span class="pykeyword">for </span><span class="pyname">x</span><span class="pyoperator">,</span><span class=
"pyname">y</span><span class="pyoperator">,</span><span class="pyname">z </span><span class=
"pykeyword">in </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select x,y,z from foo"</span><span class="pyoperator">):
    </span><span class="pykeyword">print </span><span class="pyname">cursor</span><span class=
"pyoperator">.</span><span class="pyname">getdescription</span><span class="pyoperator">()  </span><span class=
"pycomment"># shows column names and declared types
    </span><span class="pykeyword">print </span><span class="pyname">x</span><span class=
"pyoperator">,</span><span class="pyname">y</span><span class="pyoperator">,</span><span class="pyname">z

</span><span class="pycomment">###        
### iterator - multiple statements
###

</span><span class="pykeyword">for </span><span class="pyname">m</span><span class="pyoperator">,</span><span class=
"pyname">n</span><span class="pyoperator">,</span><span class="pyname">o </span><span class=
"pykeyword">in </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select x,y,z from foo ; select a,b,c from bar"</span><span class="pyoperator">):
    </span><span class="pykeyword">print </span><span class="pyname">m</span><span class=
"pyoperator">,</span><span class="pyname">n</span><span class="pyoperator">,</span><span class="pyname">o

</span><span class="pycomment">###
### bindings - sequence
###

</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into foo values(?,?,?)"</span><span class="pyoperator">, (</span><span class=
"pynumber">7</span><span class="pyoperator">, </span><span class="pystring">'eight'</span><span class=
"pyoperator">, </span><span class="pyname">False</span><span class="pyoperator">))
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into foo values(?,?,?1)"</span><span class="pyoperator">, (</span><span class=
"pystring">'one'</span><span class="pyoperator">, </span><span class="pystring">'two'</span><span class=
"pyoperator">))  </span><span class="pycomment"># nb sqlite does the numbers from 1

###
### bindings - dictionary
###

</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into foo values(:alpha, :beta, :gamma)"</span><span class="pyoperator">, {</span><span class=
"pystring">'alpha'</span><span class="pyoperator">: </span><span class="pynumber">1</span><span class=
"pyoperator">, </span><span class="pystring">'beta'</span><span class="pyoperator">: </span><span class=
"pynumber">2</span><span class="pyoperator">, </span><span class="pystring">'gamma'</span><span class=
"pyoperator">: </span><span class="pystring">'three'</span><span class="pyoperator">})

</span><span class="pycomment">###
### <a name="example-exectrace" id="example-exectrace">tracing execution</a> 
###

</span><span class="pykeyword">def </span><span class="pyname">mytrace</span><span class=
"pyoperator">(</span><span class="pyname">statement</span><span class="pyoperator">, </span><span class=
"pyname">bindings</span><span class="pyoperator">):
    </span><span class="pystring">"Called just before executing each statement"
    </span><span class="pykeyword">print </span><span class="pystring">"SQL:"</span><span class=
"pyoperator">,</span><span class="pyname">statement
    </span><span class="pykeyword">if </span><span class="pyname">bindings</span><span class="pyoperator">:
        </span><span class="pykeyword">print </span><span class="pystring">"Bindings:"</span><span class=
"pyoperator">,</span><span class="pyname">bindings
    </span><span class="pykeyword">return </span><span class="pyname">True  </span><span class=
"pycomment"># if you return False then execution is aborted

</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">setexectrace</span><span class="pyoperator">(</span><span class="pyname">mytrace</span><span class=
"pyoperator">)
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"drop table bar ; create table bar(x,y,z); select * from foo where x=?"</span><span class=
"pyoperator">, (</span><span class="pynumber">3</span><span class="pyoperator">,))

</span><span class="pyoutput">   SQL: drop table bar ;
   SQL:  create table bar(x,y,z);
   SQL:  select * from foo where x=?
   Bindings: (3,)
</span>
<span class="pycomment">###
### <a name="example-rowtrace" id="example-rowtrace">tracing results</a> 
###

</span><span class="pykeyword">def </span><span class="pyname">rowtrace</span><span class=
"pyoperator">(*</span><span class="pyname">results</span><span class="pyoperator">):
    </span><span class=
"pystring">"""Called with each row of results before they are handed off.  You can return None to
    cause the row to be skipped or a different set of values to return"""
    </span><span class="pykeyword">print </span><span class="pystring">"Row:"</span><span class=
"pyoperator">,</span><span class="pyname">results
    </span><span class="pykeyword">return </span><span class="pyname">results

cursor</span><span class="pyoperator">.</span><span class="pyname">setrowtrace</span><span class=
"pyoperator">(</span><span class="pyname">rowtrace</span><span class="pyoperator">)
</span><span class="pykeyword">for </span><span class="pyname">row </span><span class=
"pykeyword">in </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select x,y from foo where x&gt;3"</span><span class="pyoperator">):
     </span><span class="pykeyword">pass

</span><span class="pyoutput">   SQL: select x,y from foo where x&gt;3
   Row: (4, u'five')
   Row: (7, u'eight')
   Row: (u'one', u'two')
</span>
<span class="pycomment"># Clear tracers
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">setrowtrace</span><span class="pyoperator">(</span><span class="pyname">None</span><span class="pyoperator">)
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">setexectrace</span><span class="pyoperator">(</span><span class="pyname">None</span><span class="pyoperator">)

</span><span class="pycomment">###
### executemany
###

# (This will work correctly with multiple statements, as well as statements that
# return data.  The second argument can be anything that is iterable.)
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">executemany</span><span class="pyoperator">(</span><span class=
"pystring">"insert into foo (x) values(?)"</span><span class="pyoperator">, ( [</span><span class=
"pynumber">1</span><span class="pyoperator">], [</span><span class="pynumber">2</span><span class=
"pyoperator">], [</span><span class="pynumber">3</span><span class="pyoperator">] ) )

</span><span class="pycomment"># You can also use it for statements that return data
</span><span class="pykeyword">for </span><span class="pyname">row </span><span class=
"pykeyword">in </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">executemany</span><span class="pyoperator">(</span><span class=
"pystring">"select * from foo where x=?"</span><span class="pyoperator">, ( [</span><span class=
"pynumber">1</span><span class="pyoperator">], [</span><span class="pynumber">2</span><span class=
"pyoperator">], [</span><span class="pynumber">3</span><span class="pyoperator">] ) ):
    </span><span class="pykeyword">print </span><span class="pyname">row

</span><span class="pycomment">###
### defining your own functions
###

</span><span class="pykeyword">def </span><span class="pyname">ilove7</span><span class=
"pyoperator">(*</span><span class="pyname">args</span><span class="pyoperator">):
    </span><span class="pystring">"a scalar function"
    </span><span class="pykeyword">print </span><span class="pystring">"ilove7 got"</span><span class=
"pyoperator">,</span><span class="pyname">args</span><span class="pyoperator">,</span><span class=
"pystring">"but I love 7"
    </span><span class="pykeyword">return </span><span class="pynumber">7

</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">createscalarfunction</span><span class="pyoperator">(</span><span class="pystring">"seven"</span><span class=
"pyoperator">, </span><span class="pyname">ilove7</span><span class="pyoperator">)

</span><span class="pykeyword">for </span><span class="pyname">row </span><span class=
"pykeyword">in </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select seven(x,y) from foo"</span><span class="pyoperator">):
    </span><span class="pykeyword">print </span><span class="pyname">row

</span><span class="pycomment">###
### aggregate functions are more complex
###

# here we return the longest item when represented as a string

</span><span class="pykeyword">def </span><span class="pyname">longeststep</span><span class=
"pyoperator">(</span><span class="pyname">context</span><span class="pyoperator">, *</span><span class=
"pyname">args</span><span class="pyoperator">):
    </span><span class="pystring">"are any of the arguments longer than our current candidate"
    </span><span class="pykeyword">for </span><span class="pyname">arg </span><span class=
"pykeyword">in </span><span class="pyname">args</span><span class="pyoperator">:
        </span><span class="pykeyword">if </span><span class="pyname">len</span><span class=
"pyoperator">( </span><span class="pyname">str</span><span class="pyoperator">(</span><span class=
"pyname">arg</span><span class="pyoperator">) ) &gt; </span><span class="pyname">len</span><span class=
"pyoperator">( </span><span class="pyname">context</span><span class="pyoperator">[</span><span class=
"pystring">'longest'</span><span class="pyoperator">] ):
            </span><span class="pyname">context</span><span class="pyoperator">[</span><span class=
"pystring">'longest'</span><span class="pyoperator">]=</span><span class="pyname">str</span><span class=
"pyoperator">(</span><span class="pyname">arg</span><span class="pyoperator">)

</span><span class="pykeyword">def </span><span class="pyname">longestfinal</span><span class=
"pyoperator">(</span><span class="pyname">context</span><span class="pyoperator">):
    </span><span class="pystring">"return the winner"
    </span><span class="pykeyword">return </span><span class="pyname">context</span><span class=
"pyoperator">[</span><span class="pystring">'longest'</span><span class="pyoperator">]

</span><span class="pykeyword">def </span><span class="pyname">longestfactory</span><span class="pyoperator">():
    </span><span class="pystring">"""called for a new query.  The first item returned can be
    anything and is passed as the context to the step
    and final methods.  We use a dict."""
    </span><span class="pykeyword">return </span><span class="pyoperator">( { </span><span class=
"pystring">'longest'</span><span class="pyoperator">: </span><span class="pystring">'' </span><span class=
"pyoperator">}, </span><span class="pyname">longeststep</span><span class="pyoperator">, </span><span class=
"pyname">longestfinal</span><span class="pyoperator">)

</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">createaggregatefunction</span><span class="pyoperator">(</span><span class=
"pystring">"longest"</span><span class="pyoperator">, </span><span class="pyname">longestfactory</span><span class=
"pyoperator">)

</span><span class="pykeyword">for </span><span class="pyname">row </span><span class=
"pykeyword">in </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select longest(x) from foo"</span><span class="pyoperator">):
    </span><span class="pykeyword">print </span><span class="pyname">row

</span><span class="pycomment">###
### Defining collations.  
###

# The default sorting mechanisms don't understand numbers at the end of strings
# so here we define a collation that does

</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class="pystring">"create table s(str)"</span><span class=
"pyoperator">)
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">executemany</span><span class="pyoperator">(</span><span class=
"pystring">"insert into s values(?)"</span><span class="pyoperator">,
                  ( [</span><span class="pystring">"file1"</span><span class="pyoperator">], [</span><span class=
"pystring">"file7"</span><span class="pyoperator">], [</span><span class="pystring">"file17"</span><span class=
"pyoperator">], [</span><span class="pystring">"file20"</span><span class="pyoperator">], [</span><span class=
"pystring">"file3"</span><span class="pyoperator">] ) )

</span><span class="pykeyword">for </span><span class="pyname">row </span><span class=
"pykeyword">in </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select * from s order by str"</span><span class="pyoperator">):
    </span><span class="pykeyword">print </span><span class="pyname">row

</span><span class="pyoutput">   (u'file1',)
   (u'file17',)
   (u'file20',)
   (u'file3',)
   (u'file7',)
</span>
<span class="pykeyword">def </span><span class="pyname">strnumcollate</span><span class=
"pyoperator">(</span><span class="pyname">s1</span><span class="pyoperator">, </span><span class=
"pyname">s2</span><span class="pyoperator">):
    </span><span class="pycomment"># return -1 if s1&lt;s2, +1 if s1&gt;s2 else 0

    # split values into two parts - the head and the numeric tail
    </span><span class="pyname">values</span><span class="pyoperator">=[</span><span class=
"pyname">s1</span><span class="pyoperator">, </span><span class="pyname">s2</span><span class="pyoperator">]
    </span><span class="pykeyword">for </span><span class="pyname">vn</span><span class=
"pyoperator">,</span><span class="pyname">v </span><span class="pykeyword">in </span><span class=
"pyname">enumerate</span><span class="pyoperator">(</span><span class="pyname">values</span><span class="pyoperator">):
        </span><span class="pykeyword">for </span><span class="pyname">i </span><span class=
"pykeyword">in </span><span class="pyname">range</span><span class="pyoperator">(</span><span class=
"pyname">len</span><span class="pyoperator">(</span><span class="pyname">v</span><span class=
"pyoperator">), </span><span class="pynumber">0</span><span class="pyoperator">, -</span><span class=
"pynumber">1</span><span class="pyoperator">):
            </span><span class="pykeyword">if </span><span class="pyname">v</span><span class=
"pyoperator">[</span><span class="pyname">i</span><span class="pyoperator">-</span><span class=
"pynumber">1</span><span class="pyoperator">] </span><span class="pykeyword">not in </span><span class=
"pystring">"01234567890"</span><span class="pyoperator">:
                </span><span class="pykeyword">break
        try</span><span class="pyoperator">:
            </span><span class="pyname">v</span><span class="pyoperator">=( </span><span class=
"pyname">v</span><span class="pyoperator">[:</span><span class="pyname">i</span><span class=
"pyoperator">], </span><span class="pyname">int</span><span class="pyoperator">(</span><span class=
"pyname">v</span><span class="pyoperator">[</span><span class="pyname">i</span><span class="pyoperator">:]) )
        </span><span class="pykeyword">except </span><span class="pyname">ValueError</span><span class="pyoperator">:
            </span><span class="pyname">v</span><span class="pyoperator">=( </span><span class=
"pyname">v</span><span class="pyoperator">[:</span><span class="pyname">i</span><span class=
"pyoperator">], </span><span class="pyname">None </span><span class="pyoperator">)
        </span><span class="pyname">values</span><span class="pyoperator">[</span><span class=
"pyname">vn</span><span class="pyoperator">]=</span><span class="pyname">v
    </span><span class="pycomment"># compare
    </span><span class="pykeyword">if </span><span class="pyname">values</span><span class=
"pyoperator">[</span><span class="pynumber">0</span><span class="pyoperator">]&lt;</span><span class=
"pyname">values</span><span class="pyoperator">[</span><span class="pynumber">1</span><span class="pyoperator">]:
        </span><span class="pykeyword">return </span><span class="pyoperator">-</span><span class="pynumber">1
    </span><span class="pykeyword">if </span><span class="pyname">values</span><span class=
"pyoperator">[</span><span class="pynumber">0</span><span class="pyoperator">]&gt;</span><span class=
"pyname">values</span><span class="pyoperator">[</span><span class="pynumber">1</span><span class="pyoperator">]:
        </span><span class="pykeyword">return </span><span class="pynumber">1
    </span><span class="pykeyword">return </span><span class="pynumber">0

</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">createcollation</span><span class="pyoperator">(</span><span class="pystring">"strnum"</span><span class=
"pyoperator">, </span><span class="pyname">strnumcollate</span><span class="pyoperator">)

</span><span class="pykeyword">for </span><span class="pyname">row </span><span class=
"pykeyword">in </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select * from s order by str collate strnum"</span><span class="pyoperator">):
    </span><span class="pykeyword">print </span><span class="pyname">row

</span><span class="pyoutput">   (u'file1',)
   (u'file3',)
   (u'file7',)
   (u'file17',)
   (u'file20',)
</span>
<span class="pycomment">###
### Authorizer (eg if you want to control what user supplied SQL can do)
###

</span><span class="pykeyword">def </span><span class="pyname">authorizer</span><span class=
"pyoperator">(</span><span class="pyname">operation</span><span class="pyoperator">, </span><span class=
"pyname">paramone</span><span class="pyoperator">, </span><span class="pyname">paramtwo</span><span class=
"pyoperator">, </span><span class="pyname">databasename</span><span class="pyoperator">, </span><span class=
"pyname">triggerorview</span><span class="pyoperator">):
    </span><span class="pystring">"""Called when each operation is prepared.  We can return SQLITE_OK, SQLITE_DENY or
    SQLITE_IGNORE"""
    </span><span class="pycomment"># find the operation name
    </span><span class="pykeyword">print </span><span class="pyname">apsw</span><span class=
"pyoperator">.</span><span class="pyname">mapping_authorizer_function</span><span class=
"pyoperator">[</span><span class="pyname">operation</span><span class="pyoperator">],
    </span><span class="pykeyword">print </span><span class="pyname">paramone</span><span class=
"pyoperator">, </span><span class="pyname">paramtwo</span><span class="pyoperator">, </span><span class=
"pyname">databasename</span><span class="pyoperator">, </span><span class="pyname">triggerorview
    </span><span class="pykeyword">if </span><span class="pyname">operation</span><span class=
"pyoperator">==</span><span class="pyname">apsw</span><span class="pyoperator">.</span><span class=
"pyname">SQLITE_CREATE_TABLE </span><span class="pykeyword">and </span><span class="pyname">paramone</span><span class=
"pyoperator">.</span><span class="pyname">startswith</span><span class="pyoperator">(</span><span class=
"pystring">"private"</span><span class="pyoperator">):
        </span><span class="pykeyword">return </span><span class="pyname">apsw</span><span class=
"pyoperator">.</span><span class="pyname">SQLITE_DENY  </span><span class=
"pycomment"># not allowed to create tables whose names start with private

    </span><span class="pykeyword">return </span><span class="pyname">apsw</span><span class=
"pyoperator">.</span><span class="pyname">SQLITE_OK  </span><span class="pycomment"># always allow

</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">setauthorizer</span><span class="pyoperator">(</span><span class="pyname">authorizer</span><span class=
"pyoperator">)
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into s values('foo')"</span><span class="pyoperator">)
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select str from s limit 1"</span><span class="pyoperator">)

</span><span class="pyoutput">   SQLITE_INSERT s None main None
   SQLITE_SELECT None None None None
   SQLITE_READ s str main None
</span>
<span class="pycomment"># Cancel authorizer
</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">setauthorizer</span><span class="pyoperator">(</span><span class="pyname">None</span><span class=
"pyoperator">)

</span><span class="pycomment">###
### progress handler (SQLite 3 experimental feature)
###

# something to give us large numbers of random numbers
</span><span class="pykeyword">import </span><span class="pyname">random
</span><span class="pykeyword">def </span><span class="pyname">randomintegers</span><span class=
"pyoperator">(</span><span class="pyname">howmany</span><span class="pyoperator">):
    </span><span class="pykeyword">for </span><span class="pyname">i </span><span class=
"pykeyword">in </span><span class="pyname">xrange</span><span class="pyoperator">(</span><span class=
"pyname">howmany</span><span class="pyoperator">):
        </span><span class="pykeyword">yield </span><span class="pyoperator">(</span><span class=
"pyname">random</span><span class="pyoperator">.</span><span class="pyname">randint</span><span class=
"pyoperator">(</span><span class="pynumber">0</span><span class="pyoperator">,</span><span class=
"pynumber">9999999999</span><span class="pyoperator">),)

</span><span class="pycomment"># create a table with 100 random numbers
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"begin ; create table bigone(x)"</span><span class="pyoperator">)
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">executemany</span><span class="pyoperator">(</span><span class=
"pystring">"insert into bigone values(?)"</span><span class="pyoperator">, </span><span class=
"pyname">randomintegers</span><span class="pyoperator">(</span><span class="pynumber">100</span><span class=
"pyoperator">))
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class="pystring">"commit"</span><span class=
"pyoperator">)

</span><span class="pycomment"># display an ascii spinner
</span><span class="pyname">_phcount</span><span class="pyoperator">=</span><span class="pynumber">0
</span><span class="pyname">_phspinner</span><span class="pyoperator">=</span><span class="pystring">"|/-\\"
</span><span class="pykeyword">def </span><span class="pyname">progresshandler</span><span class="pyoperator">():
    </span><span class="pykeyword">global </span><span class="pyname">_phcount
    sys</span><span class="pyoperator">.</span><span class="pyname">stdout</span><span class=
"pyoperator">.</span><span class="pyname">write</span><span class="pyoperator">(</span><span class=
"pyname">_phspinner</span><span class="pyoperator">[</span><span class="pyname">_phcount</span><span class=
"pyoperator">%</span><span class="pyname">len</span><span class="pyoperator">(</span><span class=
"pyname">_phspinner</span><span class="pyoperator">)]+</span><span class="pyname">chr</span><span class=
"pyoperator">(</span><span class="pynumber">8</span><span class="pyoperator">)) </span><span class=
"pycomment"># chr(8) is backspace
    </span><span class="pyname">sys</span><span class="pyoperator">.</span><span class=
"pyname">stdout</span><span class="pyoperator">.</span><span class="pyname">flush</span><span class="pyoperator">()
    </span><span class="pyname">_phcount</span><span class="pyoperator">+=</span><span class="pynumber">1
    </span><span class="pyname">time</span><span class="pyoperator">.</span><span class=
"pyname">sleep</span><span class="pyoperator">(</span><span class="pynumber">0.1</span><span class=
"pyoperator">) </span><span class=
"pycomment"># deliberate delay so we can see the spinner (SQLite is too fast otherwise!)
    </span><span class="pykeyword">return </span><span class="pynumber">0  </span><span class=
"pycomment"># returning non-zero aborts

# register progresshandler every 20 instructions
</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">setprogresshandler</span><span class="pyoperator">(</span><span class=
"pyname">progresshandler</span><span class="pyoperator">, </span><span class="pynumber">20</span><span class=
"pyoperator">)

</span><span class="pycomment"># see it in action - sorting 100 numbers to find the biggest takes a while
</span><span class="pykeyword">print </span><span class="pystring">"spinny thing -&gt; "</span><span class=
"pyoperator">,
</span><span class="pykeyword">for </span><span class="pyname">i </span><span class="pykeyword">in </span><span class=
"pyname">cursor</span><span class="pyoperator">.</span><span class="pyname">execute</span><span class=
"pyoperator">(</span><span class="pystring">"select max(x) from bigone"</span><span class="pyoperator">):
    </span><span class="pykeyword">print </span><span class="pycomment"># newline
    </span><span class="pykeyword">print </span><span class="pyname">i </span><span class=
"pycomment"># and the maximum number

</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">setprogresshandler</span><span class="pyoperator">(</span><span class="pyname">None</span><span class=
"pyoperator">)

</span><span class="pycomment">###
### commit hook (SQLite3 experimental feature)
###

</span><span class="pykeyword">def </span><span class="pyname">mycommithook</span><span class="pyoperator">():
    </span><span class="pykeyword">print </span><span class="pystring">"in commit hook"
    </span><span class="pyname">hour</span><span class="pyoperator">=</span><span class=
"pyname">time</span><span class="pyoperator">.</span><span class="pyname">localtime</span><span class=
"pyoperator">()[</span><span class="pynumber">3</span><span class="pyoperator">]
    </span><span class="pykeyword">if </span><span class="pyname">hour</span><span class=
"pyoperator">&lt;</span><span class="pynumber">8 </span><span class="pykeyword">or </span><span class=
"pyname">hour</span><span class="pyoperator">&gt;</span><span class="pynumber">17</span><span class="pyoperator">:
        </span><span class="pykeyword">print </span><span class="pystring">"no commits out of hours"
        </span><span class="pykeyword">return </span><span class="pynumber">1  </span><span class=
"pycomment"># abort commits outside of 8am through 6pm
    </span><span class="pykeyword">print </span><span class="pystring">"commits okay at this time"
    </span><span class="pykeyword">return </span><span class="pynumber">0  </span><span class=
"pycomment"># let commit go ahead

</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">setcommithook</span><span class="pyoperator">(</span><span class="pyname">mycommithook</span><span class=
"pyoperator">)
</span><span class="pykeyword">try</span><span class="pyoperator">:
    </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"begin; create table example(x,y,z); insert into example values (3,4,5) ; commit"</span><span class=
"pyoperator">)
</span><span class="pykeyword">except </span><span class="pyname">apsw</span><span class=
"pyoperator">.</span><span class="pyname">ConstraintError</span><span class="pyoperator">:
    </span><span class="pykeyword">print </span><span class="pystring">"commit was not allowed"

</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">setcommithook</span><span class="pyoperator">(</span><span class="pyname">None</span><span class=
"pyoperator">)

</span><span class="pycomment">###
### <a name="example-blobio" id="example-blobio">Blob I/O</a> 
###

</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"create table blobby(x,y)"</span><span class="pyoperator">)
</span><span class="pycomment"># Add a blob we will fill in later
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into blobby values(1,zeroblob(10000))"</span><span class="pyoperator">)
</span><span class="pycomment"># Or as a binding
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into blobby values(2,?)"</span><span class="pyoperator">, (</span><span class=
"pyname">apsw</span><span class="pyoperator">.</span><span class="pyname">zeroblob</span><span class=
"pyoperator">(</span><span class="pynumber">20000</span><span class="pyoperator">),))
</span><span class="pycomment"># Open a blob for writing.  We need to know the rowid
</span><span class="pyname">rowid</span><span class="pyoperator">=</span><span class="pyname">cursor</span><span class=
"pyoperator">.</span><span class="pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select ROWID from blobby where x=1"</span><span class="pyoperator">).</span><span class=
"pyname">next</span><span class="pyoperator">()[</span><span class="pynumber">0</span><span class="pyoperator">]
</span><span class="pyname">blob</span><span class="pyoperator">=</span><span class=
"pyname">connection</span><span class="pyoperator">.</span><span class="pyname">blobopen</span><span class=
"pyoperator">(</span><span class="pystring">"main"</span><span class="pyoperator">, </span><span class=
"pystring">"blobby"</span><span class="pyoperator">, </span><span class="pystring">"y"</span><span class=
"pyoperator">, </span><span class="pyname">rowid</span><span class="pyoperator">, </span><span class=
"pynumber">1</span><span class="pyoperator">) </span><span class="pycomment"># 1 is for read/write
</span><span class="pyname">blob</span><span class="pyoperator">.</span><span class="pyname">write</span><span class=
"pyoperator">(</span><span class="pystring">"hello world"</span><span class="pyoperator">)
</span><span class="pyname">blob</span><span class="pyoperator">.</span><span class="pyname">seek</span><span class=
"pyoperator">(</span><span class="pynumber">2000</span><span class="pyoperator">)
</span><span class="pyname">blob</span><span class="pyoperator">.</span><span class="pyname">write</span><span class=
"pyoperator">(</span><span class="pystring">"hello world, again"</span><span class="pyoperator">)
</span><span class="pyname">blob</span><span class="pyoperator">.</span><span class="pyname">close</span><span class=
"pyoperator">()

</span><span class="pycomment">###
### Virtual tables
###

# This virtual table stores information about files in a set of
# directories so you can execute SQL queries

</span><span class="pykeyword">def </span><span class="pyname">getfiledata</span><span class=
"pyoperator">(</span><span class="pyname">directories</span><span class="pyoperator">):
    </span><span class="pyname">columns</span><span class="pyoperator">=</span><span class="pyname">None
    data</span><span class="pyoperator">=[]
    </span><span class="pyname">counter</span><span class="pyoperator">=</span><span class="pynumber">1
    </span><span class="pykeyword">for </span><span class="pyname">directory </span><span class=
"pykeyword">in </span><span class="pyname">directories</span><span class="pyoperator">:
        </span><span class="pykeyword">for </span><span class="pyname">f </span><span class=
"pykeyword">in </span><span class="pyname">os</span><span class="pyoperator">.</span><span class=
"pyname">listdir</span><span class="pyoperator">(</span><span class="pyname">directory</span><span class=
"pyoperator">):
            </span><span class="pykeyword">if not </span><span class="pyname">os</span><span class=
"pyoperator">.</span><span class="pyname">path</span><span class="pyoperator">.</span><span class=
"pyname">isfile</span><span class="pyoperator">(</span><span class="pyname">os</span><span class=
"pyoperator">.</span><span class="pyname">path</span><span class="pyoperator">.</span><span class=
"pyname">join</span><span class="pyoperator">(</span><span class="pyname">directory</span><span class=
"pyoperator">,</span><span class="pyname">f</span><span class="pyoperator">)):
                </span><span class="pykeyword">continue
            </span><span class="pyname">counter</span><span class="pyoperator">+=</span><span class="pynumber">1
            </span><span class="pyname">st</span><span class="pyoperator">=</span><span class=
"pyname">os</span><span class="pyoperator">.</span><span class="pyname">stat</span><span class=
"pyoperator">(</span><span class="pyname">os</span><span class="pyoperator">.</span><span class=
"pyname">path</span><span class="pyoperator">.</span><span class="pyname">join</span><span class=
"pyoperator">(</span><span class="pyname">directory</span><span class="pyoperator">,</span><span class=
"pyname">f</span><span class="pyoperator">))
            </span><span class="pykeyword">if </span><span class="pyname">columns </span><span class=
"pykeyword">is </span><span class="pyname">None</span><span class="pyoperator">:
                </span><span class="pyname">columns</span><span class="pyoperator">=[</span><span class=
"pystring">"rowid"</span><span class="pyoperator">, </span><span class="pystring">"name"</span><span class=
"pyoperator">, </span><span class="pystring">"directory"</span><span class="pyoperator">]+[</span><span class=
"pyname">x </span><span class="pykeyword">for </span><span class="pyname">x </span><span class=
"pykeyword">in </span><span class="pyname">dir</span><span class="pyoperator">(</span><span class=
"pyname">st</span><span class="pyoperator">) </span><span class="pykeyword">if </span><span class=
"pyname">x</span><span class="pyoperator">.</span><span class="pyname">startswith</span><span class=
"pyoperator">(</span><span class="pystring">"st_"</span><span class="pyoperator">)]
            </span><span class="pyname">data</span><span class="pyoperator">.</span><span class=
"pyname">append</span><span class="pyoperator">( [</span><span class="pyname">counter</span><span class=
"pyoperator">, </span><span class="pyname">f</span><span class="pyoperator">, </span><span class=
"pyname">directory</span><span class="pyoperator">] + [</span><span class="pyname">getattr</span><span class=
"pyoperator">(</span><span class="pyname">st</span><span class="pyoperator">,</span><span class=
"pyname">x</span><span class="pyoperator">) </span><span class="pykeyword">for </span><span class=
"pyname">x </span><span class="pykeyword">in </span><span class="pyname">columns</span><span class=
"pyoperator">[</span><span class="pynumber">3</span><span class="pyoperator">:]] )
    </span><span class="pykeyword">return </span><span class="pyname">columns</span><span class=
"pyoperator">, </span><span class="pyname">data

</span><span class="pycomment"># This gets registered with the Connection
</span><span class="pykeyword">class </span><span class="pyname">Source</span><span class="pyoperator">:
    </span><span class="pykeyword">def </span><span class="pyname">Create</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, </span><span class=
"pyname">db</span><span class="pyoperator">, </span><span class="pyname">modulename</span><span class=
"pyoperator">, </span><span class="pyname">dbname</span><span class="pyoperator">, </span><span class=
"pyname">tablename</span><span class="pyoperator">, *</span><span class="pyname">args</span><span class="pyoperator">):
        </span><span class="pyname">columns</span><span class="pyoperator">,</span><span class=
"pyname">data</span><span class="pyoperator">=</span><span class="pyname">getfiledata</span><span class=
"pyoperator">([</span><span class="pyname">eval</span><span class="pyoperator">(</span><span class=
"pyname">a</span><span class="pyoperator">.</span><span class="pyname">replace</span><span class=
"pyoperator">(</span><span class="pystring">"\\"</span><span class="pyoperator">, </span><span class=
"pystring">"\\\\"</span><span class="pyoperator">)) </span><span class="pykeyword">for </span><span class=
"pyname">a </span><span class="pykeyword">in </span><span class="pyname">args</span><span class=
"pyoperator">]) </span><span class="pycomment"># eval strips off layer of quotes
        </span><span class="pyname">schema</span><span class="pyoperator">=</span><span class=
"pystring">"create table foo("</span><span class="pyoperator">+</span><span class="pystring">','</span><span class=
"pyoperator">.</span><span class="pyname">join</span><span class="pyoperator">([</span><span class=
"pystring">"'%s'" </span><span class="pyoperator">% (</span><span class="pyname">x</span><span class=
"pyoperator">,) </span><span class="pykeyword">for </span><span class="pyname">x </span><span class=
"pykeyword">in </span><span class="pyname">columns</span><span class="pyoperator">[</span><span class=
"pynumber">1</span><span class="pyoperator">:]])+</span><span class="pystring">")"
        </span><span class="pykeyword">return </span><span class="pyname">schema</span><span class=
"pyoperator">,</span><span class="pyname">Table</span><span class="pyoperator">(</span><span class=
"pyname">columns</span><span class="pyoperator">,</span><span class="pyname">data</span><span class="pyoperator">)
    </span><span class="pyname">Connect</span><span class="pyoperator">=</span><span class="pyname">Create

</span><span class="pycomment"># Represents a table
</span><span class="pykeyword">class </span><span class="pyname">Table</span><span class="pyoperator">:
    </span><span class="pykeyword">def </span><span class="pyname">__init__</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, </span><span class=
"pyname">columns</span><span class="pyoperator">, </span><span class="pyname">data</span><span class="pyoperator">):
        </span><span class="pyname">self</span><span class="pyoperator">.</span><span class=
"pyname">columns</span><span class="pyoperator">=</span><span class="pyname">columns
        self</span><span class="pyoperator">.</span><span class="pyname">data</span><span class=
"pyoperator">=</span><span class="pyname">data

    </span><span class="pykeyword">def </span><span class="pyname">BestIndex</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, *</span><span class=
"pyname">args</span><span class="pyoperator">):
        </span><span class="pykeyword">return </span><span class="pyname">None

    </span><span class="pykeyword">def </span><span class="pyname">Open</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">):
        </span><span class="pykeyword">return </span><span class="pyname">Cursor</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">)

    </span><span class="pykeyword">def </span><span class="pyname">Disconnect</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">):
        </span><span class="pykeyword">pass

    </span><span class="pyname">Destroy</span><span class="pyoperator">=</span><span class="pyname">Disconnect

</span><span class="pycomment"># Represents a cursor
</span><span class="pykeyword">class </span><span class="pyname">Cursor</span><span class="pyoperator">:
    </span><span class="pykeyword">def </span><span class="pyname">__init__</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, </span><span class=
"pyname">table</span><span class="pyoperator">):
        </span><span class="pyname">self</span><span class="pyoperator">.</span><span class=
"pyname">table</span><span class="pyoperator">=</span><span class="pyname">table

    </span><span class="pykeyword">def </span><span class="pyname">Filter</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, *</span><span class=
"pyname">args</span><span class="pyoperator">):
        </span><span class="pyname">self</span><span class="pyoperator">.</span><span class=
"pyname">pos</span><span class="pyoperator">=</span><span class="pynumber">0

    </span><span class="pykeyword">def </span><span class="pyname">Eof</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">):
        </span><span class="pykeyword">return </span><span class="pyname">self</span><span class=
"pyoperator">.</span><span class="pyname">pos</span><span class="pyoperator">&gt;=</span><span class=
"pyname">len</span><span class="pyoperator">(</span><span class="pyname">self</span><span class=
"pyoperator">.</span><span class="pyname">table</span><span class="pyoperator">.</span><span class=
"pyname">data</span><span class="pyoperator">)

    </span><span class="pykeyword">def </span><span class="pyname">Rowid</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">):
        </span><span class="pykeyword">return </span><span class="pyname">self</span><span class=
"pyoperator">.</span><span class="pyname">table</span><span class="pyoperator">.</span><span class=
"pyname">data</span><span class="pyoperator">[</span><span class="pyname">self</span><span class=
"pyoperator">.</span><span class="pyname">pos</span><span class="pyoperator">][</span><span class=
"pynumber">0</span><span class="pyoperator">]

    </span><span class="pykeyword">def </span><span class="pyname">Column</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, </span><span class=
"pyname">col</span><span class="pyoperator">):
        </span><span class="pykeyword">return </span><span class="pyname">self</span><span class=
"pyoperator">.</span><span class="pyname">table</span><span class="pyoperator">.</span><span class=
"pyname">data</span><span class="pyoperator">[</span><span class="pyname">self</span><span class=
"pyoperator">.</span><span class="pyname">pos</span><span class="pyoperator">][</span><span class=
"pynumber">1</span><span class="pyoperator">+</span><span class="pyname">col</span><span class="pyoperator">]

    </span><span class="pykeyword">def </span><span class="pyname">Next</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">):
        </span><span class="pyname">self</span><span class="pyoperator">.</span><span class=
"pyname">pos</span><span class="pyoperator">+=</span><span class="pynumber">1

    </span><span class="pykeyword">def </span><span class="pyname">Close</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">):
        </span><span class="pykeyword">pass

</span><span class="pycomment"># Register the module as filesource
</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">createmodule</span><span class="pyoperator">(</span><span class="pystring">"filesource"</span><span class=
"pyoperator">, </span><span class="pyname">Source</span><span class="pyoperator">())

</span><span class="pycomment"># Arguments to module - all directories in sys.path
</span><span class="pyname">sysdirs</span><span class="pyoperator">=</span><span class=
"pystring">","</span><span class="pyoperator">.</span><span class="pyname">join</span><span class=
"pyoperator">([</span><span class="pystring">"'%s'" </span><span class="pyoperator">% (</span><span class=
"pyname">x</span><span class="pyoperator">,) </span><span class="pykeyword">for </span><span class=
"pyname">x </span><span class="pykeyword">in </span><span class="pyname">sys</span><span class=
"pyoperator">.</span><span class="pyname">path</span><span class="pyoperator">[</span><span class=
"pynumber">1</span><span class="pyoperator">:] </span><span class="pykeyword">if </span><span class=
"pyname">len</span><span class="pyoperator">(</span><span class="pyname">x</span><span class=
"pyoperator">) </span><span class="pykeyword">and </span><span class="pyname">os</span><span class=
"pyoperator">.</span><span class="pyname">path</span><span class="pyoperator">.</span><span class=
"pyname">isdir</span><span class="pyoperator">(</span><span class="pyname">x</span><span class="pyoperator">)])
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"create virtual table sysfiles using filesource("</span><span class="pyoperator">+</span><span class=
"pyname">sysdirs</span><span class="pyoperator">+</span><span class="pystring">")"</span><span class="pyoperator">)

</span><span class="pycomment"># Which 3 files are the biggest?
</span><span class="pykeyword">for </span><span class="pyname">size</span><span class="pyoperator">,</span><span class=
"pyname">directory</span><span class="pyoperator">,</span><span class="pyname">file </span><span class=
"pykeyword">in </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select st_size,directory,name from sysfiles order by st_size desc limit 3"</span><span class=
"pyoperator">):
    </span><span class="pykeyword">print </span><span class="pyname">size</span><span class=
"pyoperator">,</span><span class="pyname">file</span><span class="pyoperator">,</span><span class="pyname">directory

</span><span class="pyoutput">   511686 unicodedata_d.so /usr/lib/python2.5/lib-dynload
   481008 unicodedata.so /usr/lib/python2.5/lib-dynload
   457585 pyexpat_d.so /usr/lib/python2.5/lib-dynload
</span>
<span class="pycomment"># Which 3 files are the oldest?
</span><span class="pykeyword">for </span><span class="pyname">ctime</span><span class=
"pyoperator">,</span><span class="pyname">directory</span><span class="pyoperator">,</span><span class=
"pyname">file </span><span class="pykeyword">in </span><span class="pyname">cursor</span><span class=
"pyoperator">.</span><span class="pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"select st_ctime,directory,name from sysfiles order by st_ctime limit 3"</span><span class="pyoperator">):
    </span><span class="pykeyword">print </span><span class="pyname">ctime</span><span class=
"pyoperator">,</span><span class="pyname">file</span><span class="pyoperator">,</span><span class="pyname">directory

</span><span class="pyoutput">   1194713443.0 GnuPGInterface-0.3.2.egg-info /var/lib/python-support/python2.5
   1194713443.0 GnuPGInterface.py /var/lib/python-support/python2.5
   1194713447.0 sexy.so /usr/lib/python2.5/site-packages/gtk-2.0
</span>
<span class="pycomment">### <a name="example-vfs" id="example-vfs"> </a> 
### A VFS that "obfuscates" the database file contents.  The scheme
### used is to xor all bytes with 0xa5.  This scheme honours that used
### for MAPI and SQL Server.
###

</span><span class="pykeyword">def </span><span class="pyname">encryptme</span><span class=
"pyoperator">(</span><span class="pyname">data</span><span class="pyoperator">):
    </span><span class="pykeyword">if not </span><span class="pyname">data</span><span class=
"pyoperator">: </span><span class="pykeyword">return </span><span class="pyname">data
    </span><span class="pykeyword">return </span><span class="pystring">""</span><span class=
"pyoperator">.</span><span class="pyname">join</span><span class="pyoperator">([</span><span class=
"pyname">chr</span><span class="pyoperator">(</span><span class="pyname">ord</span><span class=
"pyoperator">(</span><span class="pyname">x</span><span class="pyoperator">)^</span><span class=
"pynumber">0xa5</span><span class="pyoperator">) </span><span class="pykeyword">for </span><span class=
"pyname">x </span><span class="pykeyword">in </span><span class="pyname">data</span><span class="pyoperator">])

</span><span class="pycomment"># Inheriting from a base of "" means the default vfs
</span><span class="pykeyword">class </span><span class="pyname">ObfuscatedVFS</span><span class=
"pyoperator">(</span><span class="pyname">apsw</span><span class="pyoperator">.</span><span class=
"pyname">VFS</span><span class="pyoperator">):
    </span><span class="pykeyword">def </span><span class="pyname">__init__</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, </span><span class=
"pyname">vfsname</span><span class="pyoperator">=</span><span class="pystring">"obfu"</span><span class=
"pyoperator">, </span><span class="pyname">basevfs</span><span class="pyoperator">=</span><span class=
"pystring">""</span><span class="pyoperator">):
        </span><span class="pyname">self</span><span class="pyoperator">.</span><span class=
"pyname">vfsname</span><span class="pyoperator">=</span><span class="pyname">vfsname
        self</span><span class="pyoperator">.</span><span class="pyname">basevfs</span><span class=
"pyoperator">=</span><span class="pyname">basevfs
        apsw</span><span class="pyoperator">.</span><span class="pyname">VFS</span><span class=
"pyoperator">.</span><span class="pyname">__init__</span><span class="pyoperator">(</span><span class=
"pyname">self</span><span class="pyoperator">, </span><span class="pyname">self</span><span class=
"pyoperator">.</span><span class="pyname">vfsname</span><span class="pyoperator">, </span><span class=
"pyname">self</span><span class="pyoperator">.</span><span class="pyname">basevfs</span><span class="pyoperator">)

    </span><span class="pycomment"># We want to return our own file implmentation, but also
    # want it to inherit
    </span><span class="pykeyword">def </span><span class="pyname">xOpen</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, </span><span class=
"pyname">name</span><span class="pyoperator">, </span><span class="pyname">flags</span><span class="pyoperator">):
        </span><span class="pykeyword">return </span><span class="pyname">ObfuscatedVFSFile</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">.</span><span class=
"pyname">basevfs</span><span class="pyoperator">, </span><span class="pyname">name</span><span class=
"pyoperator">, </span><span class="pyname">flags</span><span class="pyoperator">)

</span><span class="pycomment"># The file implementation where we override xRead and xWrite to call our
# encryption routine
</span><span class="pykeyword">class </span><span class="pyname">ObfuscatedVFSFile</span><span class=
"pyoperator">(</span><span class="pyname">apsw</span><span class="pyoperator">.</span><span class=
"pyname">VFSFile</span><span class="pyoperator">):
    </span><span class="pykeyword">def </span><span class="pyname">__init__</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, </span><span class=
"pyname">inheritfromvfsname</span><span class="pyoperator">, </span><span class="pyname">filename</span><span class=
"pyoperator">, </span><span class="pyname">flags</span><span class="pyoperator">):
        </span><span class="pyname">apsw</span><span class="pyoperator">.</span><span class=
"pyname">VFSFile</span><span class="pyoperator">.</span><span class="pyname">__init__</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, </span><span class=
"pyname">inheritfromvfsname</span><span class="pyoperator">, </span><span class="pyname">filename</span><span class=
"pyoperator">, </span><span class="pyname">flags</span><span class="pyoperator">)

    </span><span class="pykeyword">def </span><span class="pyname">xRead</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, </span><span class=
"pyname">amount</span><span class="pyoperator">, </span><span class="pyname">offset</span><span class="pyoperator">):
        </span><span class="pykeyword">return </span><span class="pyname">encryptme</span><span class=
"pyoperator">(</span><span class="pyname">super</span><span class="pyoperator">(</span><span class=
"pyname">ObfuscatedVFSFile</span><span class="pyoperator">, </span><span class="pyname">self</span><span class=
"pyoperator">).</span><span class="pyname">xRead</span><span class="pyoperator">(</span><span class=
"pyname">amount</span><span class="pyoperator">, </span><span class="pyname">offset</span><span class="pyoperator">))

    </span><span class="pykeyword">def </span><span class="pyname">xWrite</span><span class=
"pyoperator">(</span><span class="pyname">self</span><span class="pyoperator">, </span><span class=
"pyname">data</span><span class="pyoperator">, </span><span class="pyname">offset</span><span class="pyoperator">):
        </span><span class="pyname">super</span><span class="pyoperator">(</span><span class=
"pyname">ObfuscatedVFSFile</span><span class="pyoperator">, </span><span class="pyname">self</span><span class=
"pyoperator">).</span><span class="pyname">xWrite</span><span class="pyoperator">(</span><span class=
"pyname">encryptme</span><span class="pyoperator">(</span><span class="pyname">data</span><span class=
"pyoperator">), </span><span class="pyname">offset</span><span class="pyoperator">)

</span><span class="pycomment"># To register the VFS we just instantiate it
</span><span class="pyname">obfuvfs</span><span class="pyoperator">=</span><span class=
"pyname">ObfuscatedVFS</span><span class="pyoperator">()
</span><span class="pycomment"># Lets see what vfs are now availabe?
</span><span class="pykeyword">print </span><span class="pyname">apsw</span><span class=
"pyoperator">.</span><span class="pyname">vfsnames</span><span class="pyoperator">()

</span><span class="pyoutput">   [u'unix', u'obfu']
</span>
<span class="pycomment"># Make an obfuscated db
</span><span class="pyname">obfudb</span><span class="pyoperator">=</span><span class="pyname">apsw</span><span class=
"pyoperator">.</span><span class="pyname">Connection</span><span class="pyoperator">(</span><span class=
"pystring">"myobfudb"</span><span class="pyoperator">, </span><span class="pyname">vfs</span><span class=
"pyoperator">=</span><span class="pyname">obfuvfs</span><span class="pyoperator">.</span><span class=
"pyname">vfsname</span><span class="pyoperator">)
</span><span class="pycomment"># Check it works
</span><span class="pyname">obfudb</span><span class="pyoperator">.</span><span class=
"pyname">cursor</span><span class="pyoperator">().</span><span class="pyname">execute</span><span class=
"pyoperator">(</span><span class="pystring">"create table foo(x,y); insert into foo values(1,2)"</span><span class=
"pyoperator">)

</span><span class="pycomment"># Check it really is obfuscated on disk
</span><span class="pykeyword">print </span><span class="pyoperator">`</span><span class=
"pyname">open</span><span class="pyoperator">(</span><span class="pystring">"myobfudb"</span><span class=
"pyoperator">, </span><span class="pystring">"rb"</span><span class="pyoperator">).</span><span class=
"pyname">read</span><span class="pyoperator">()[:</span><span class="pynumber">20</span><span class="pyoperator">]`

</span><span class="pyoutput">   '\xf6\xf4\xe9\xcc\xd1\xc0\x85\xc3\xca\xd7\xc8\xc4\xd1\x85\x96\xa5\xa1\xa5\xa4\xa4'
</span>
<span class="pycomment"># And unobfuscating it
</span><span class="pykeyword">print </span><span class="pyoperator">`</span><span class=
"pyname">encryptme</span><span class="pyoperator">(</span><span class="pyname">open</span><span class=
"pyoperator">(</span><span class="pystring">"myobfudb"</span><span class="pyoperator">, </span><span class=
"pystring">"rb"</span><span class="pyoperator">).</span><span class="pyname">read</span><span class=
"pyoperator">()[:</span><span class="pynumber">20</span><span class="pyoperator">])`

</span><span class="pyoutput">   'SQLite format 3\x00\x04\x00\x01\x01'
</span>
<span class="pycomment"># Tidy up
</span><span class="pyname">obfudb</span><span class="pyoperator">.</span><span class="pyname">close</span><span class=
"pyoperator">()
</span><span class="pyname">os</span><span class="pyoperator">.</span><span class="pyname">remove</span><span class=
"pyoperator">(</span><span class="pystring">"myobfudb"</span><span class="pyoperator">)


</span><span class="pycomment">###
### Limits
###

# Print some limits
</span><span class="pykeyword">for </span><span class="pyname">limit </span><span class=
"pykeyword">in </span><span class="pyoperator">(</span><span class="pystring">"LENGTH"</span><span class=
"pyoperator">, </span><span class="pystring">"COLUMN"</span><span class="pyoperator">, </span><span class=
"pystring">"ATTACHED"</span><span class="pyoperator">):
    </span><span class="pyname">name</span><span class="pyoperator">=</span><span class=
"pystring">"SQLITE_LIMIT_"</span><span class="pyoperator">+</span><span class="pyname">limit
    maxname</span><span class="pyoperator">=</span><span class="pystring">"SQLITE_MAX_"</span><span class=
"pyoperator">+</span><span class="pyname">limit  </span><span class="pycomment"># compile time
    </span><span class="pyname">orig</span><span class="pyoperator">=</span><span class=
"pyname">connection</span><span class="pyoperator">.</span><span class="pyname">limit</span><span class=
"pyoperator">(</span><span class="pyname">getattr</span><span class="pyoperator">(</span><span class=
"pyname">apsw</span><span class="pyoperator">, </span><span class="pyname">name</span><span class="pyoperator">))
    </span><span class="pykeyword">print </span><span class="pyname">name</span><span class=
"pyoperator">, </span><span class="pyname">orig
    </span><span class="pycomment"># To get the maximum, set to 0x7fffffff and then read value back
    </span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">limit</span><span class="pyoperator">(</span><span class="pyname">getattr</span><span class=
"pyoperator">(</span><span class="pyname">apsw</span><span class="pyoperator">, </span><span class=
"pyname">name</span><span class="pyoperator">), </span><span class="pynumber">0x7fffffff</span><span class=
"pyoperator">)
    </span><span class="pyname">max</span><span class="pyoperator">=</span><span class=
"pyname">connection</span><span class="pyoperator">.</span><span class="pyname">limit</span><span class=
"pyoperator">(</span><span class="pyname">getattr</span><span class="pyoperator">(</span><span class=
"pyname">apsw</span><span class="pyoperator">, </span><span class="pyname">name</span><span class="pyoperator">))
    </span><span class="pykeyword">print </span><span class="pyname">maxname</span><span class=
"pyoperator">, </span><span class="pyname">max

</span><span class="pycomment"># Set limit for size of a string
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"create table testlimit(s)"</span><span class="pyoperator">)
</span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into testlimit values(?)"</span><span class="pyoperator">, ( </span><span class=
"pystring">"x"</span><span class="pyoperator">*</span><span class="pynumber">1024</span><span class=
"pyoperator">, )) </span><span class="pycomment"># 1024 char string
</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">limit</span><span class="pyoperator">(</span><span class="pyname">apsw</span><span class=
"pyoperator">.</span><span class="pyname">SQLITE_LIMIT_LENGTH</span><span class="pyoperator">, </span><span class=
"pynumber">1023</span><span class="pyoperator">) </span><span class="pycomment"># limit is now 1023
</span><span class="pykeyword">try</span><span class="pyoperator">:
    </span><span class="pyname">cursor</span><span class="pyoperator">.</span><span class=
"pyname">execute</span><span class="pyoperator">(</span><span class=
"pystring">"insert into testlimit values(?)"</span><span class="pyoperator">, ( </span><span class=
"pystring">"y"</span><span class="pyoperator">*</span><span class="pynumber">1024</span><span class="pyoperator">, ))
    </span><span class="pykeyword">print </span><span class="pystring">"string exceeding limit was inserted"
</span><span class="pykeyword">except </span><span class="pyname">apsw</span><span class=
"pyoperator">.</span><span class="pyname">TooBigError</span><span class="pyoperator">:
    </span><span class="pykeyword">print </span><span class="pystring">"Caught toobig exception"


</span><span class="pyoutput">   SQLITE_LIMIT_LENGTH 1000000000
   SQLITE_MAX_LENGTH 1000000000
   SQLITE_LIMIT_COLUMN 2000
   SQLITE_MAX_COLUMN 2000
   SQLITE_LIMIT_ATTACHED 10
   SQLITE_MAX_ATTACHED 10
   Caught toobig exception
</span>
<span class="pycomment">###
### Statistics
###

</span><span class="pykeyword">print </span><span class=
"pystring">"SQLite memory usage current %d max %d" </span><span class="pyoperator">% </span><span class=
"pyname">apsw</span><span class="pyoperator">.</span><span class="pyname">status</span><span class=
"pyoperator">(</span><span class="pyname">apsw</span><span class="pyoperator">.</span><span class=
"pyname">SQLITE_STATUS_MEMORY_USED</span><span class="pyoperator">)

</span><span class="pyoutput">   SQLite memory usage current 235024 max 306296
</span>
<span class="pycomment">###
### Cleanup
###

# We can close connections manually (useful if you want to catch exceptions)
# but you don't have to
</span><span class="pyname">connection</span><span class="pyoperator">.</span><span class=
"pyname">close</span><span class="pyoperator">(</span><span class="pyname">True</span><span class=
"pyoperator">)  </span><span class="pycomment"># force it since we want to exit</span></font>
<!--sourceend-->
</pre>
  </blockquote>

  <h1><a name="Building" id="Building">Building</a></h1>

  <p>You run <tt>setup.py</tt>.</p>

  <table cellspacing="5" cellpadding="5">
    <tr>
      <th>Command</th>

      <th>Result</th>
    </tr>

    <tr>
      <td valign="top"><code>python setup.py install</code></td>

      <td>Compiles APSW with default Python compiler and installs it into Python site library directory.</td>
    </tr>

    <tr>
      <td valign="top"><code>python&nbsp;setup.py&nbsp;build&nbsp;--compile=mingw32&nbsp;install</code></td>

      <td>On Windows this will use the free MinGW compiler instead of the Microsoft compilers.</td>
    </tr>

    <tr>
      <td valign="top"><code>python setup.py build</code></td>

      <td>Compiles the extension but doesn't install it. The resulting file will be in a <tt>build</tt> subdirectory.
      For example on a Linux 64 bit Python 2.5 installation the file is
      <tt>build/lib.linux-x86_64-2.5/apsw.so</tt></td>
    </tr>
  </table>

  <p>There are a number of APSW specific flags you can specify.</p>

  <table cellspacing="5" cellpadding="5">
    <tr>
      <td valign="top">
        <pre>
--fetch-sqlite
--fetch-sqlite=VER
</pre>
      </td>

      <td>Automatically downloads the latest or specified version of the SQLite amalgamation and uses it for the APSW
      extension. On non-Windows platforms it will also work out what compile flags SQLite needs (for example
      <tt>HAVE_USLEEP, HAVE_LOCALTIME_R</tt>). The amalgamation is the preferred way to use SQLite as you have total
      control over what components are included or excluded (see below) and have no dependencies on any existing
      libraries on your developer or deployment machines. You can set the environment variable <tt>http_proxy</tt> to
      control proxy usage for the download.</td>
    </tr>

    <tr>
      <td valign="top"><tt>--enable=ITEM</tt></td>

      <td>Enables a specific SQLite feature ITEM</td>
    </tr>

    <tr>
      <td valign="top"><tt>--enable=fts</tt></td>

      <td>Enables the <a href="http://www.sqlite.org/cvstrac/wiki?p=FtsUsage">full text search</a> extension. This flag
      only helps when using the amalgamation. If not using the amalgamation then you need to seperately ensure it is
      enabled in the SQLite install.</td>
    </tr>

    <tr>
      <td valign="top"><tt>--enable=rtree</tt></td>

      <td>Enables the spatial table <a href="http://en.wikipedia.org/wiki/R-tree">rtree</a> (<a href=
      "http://www.sqlite.org/cvstrac/fileview?f=sqlite/ext/rtree/README">README</a>). This flag only helps when using
      the amalgamation. If not using the amalgamation then you need to seperately ensure it is enabled in the SQLite
      install.</td>
    </tr>

    <tr>
      <td valign="top"><tt>--enable=icu</tt></td>

      <td>Enables the <a href="http://en.wikipedia.org/wiki/International_Components_for_Unicode">Internation
      Components for Unicode</a> extension (<a href=
      "http://www.sqlite.org/cvstrac/fileview?f=sqlite/ext/icu/README.txt">README</a>). Note that you must have the ICU
      libraries on your machine which setup will automatically try to find using <tt>icu-config</tt>. This flag only
      helps when using the amalgamation. If not using the amalgamation then you need to seperately ensure it is enabled
      in the SQLite install.</td>
    </tr>

    <tr>
      <td valign="top"><tt>--omit=ITEM</tt></td>

      <td>Causes various functionality to be omitted. For example <tt>--omit=load_extension</tt> will omit code to do
      with loading extensions. If using the amalgamation then this will omit the functionality from APSW and SQLite,
      otherwise the functionality will only be omitted from APSW.</td>
    </tr>
  </table>

  <h2><a name="Finding" id="Finding">Finding SQLite 3</a></h2>

  <p>SQLite 3 is needed during the build process. If you specify <code>--fetch-sqlite</code> anywhere on the setup.py
  command line then it will automatically fetch the current version of the SQLite amalgamation. You can manually
  specify the version, for example <code>--fetch-sqlite=3.6.1</code>. ).</p>

  <p>These methods are tried in order:</p>

  <dl>
    <dt><br />
    <a href="http://www.sqlite.org/cvstrac/wiki?p=TheAmalgamation">Amalgamation</a></dt>

    <dd>
      <p>The file <tt>sqlite3.c</tt> and then <tt>sqlite3/sqlite3.c</tt> is looked for. The SQLite code is then
      statically compiled into the APSW extension and is invisible to the rest of the process. There are no runtime
      library dependencies on SQLite as a result.</p>
    </dd>

    <dt><br />
    Local build</dt>

    <dd>
      <p>The header <tt>sqlite3/sqlite3.h</tt> and library <tt>sqlite3/libsqlite3.{a,so,dll}</tt> is looked for.</p>
    </dd>

    <dt><br />
    System</dt>

    <dd>
      <p>The default compiler include path (eg <tt>/usr/include</tt>) and library path (eg <tt>/usr/lib</tt>) are
      used.</p>
    </dd>
  </dl>

  <p>Note that if you compiled SQLite with any OMIT flags (eg <tt>SQLITE_OMIT_LOAD_EXTENSION</tt>) then you should
  include them in the <tt>setup.py</tt> command. For this example you would use <tt>setup.py --omit=load_extension</tt>
  to add the same flags.</p>

  <h2><a name="Recommended" id="Recommended">Recommended</a></h2>

  <p>These instructions show how to build automatically downloading and using the amalgamation. Any existing SQLite on
  your system is ignored at build time and runtime. (Note that you can even use APSW in the same process as a different
  SQLite is used by other libraries - this happens a lot on Mac.) You should follow these instructions with your
  current directory being where you extracted the APSW source to.</p>

  <dl>
    <dt><b>Windows</b></dt>
  </dl>
  <pre>
&gt; python setup.py build --compile=mingw32 install --fetch-sqlite     <font color=
"blue"># Leave out --compile=... flag if using Microsoft compiler</font>
&gt; python -c "import apsw ; print  apsw.sqlitelibversion(), apsw.apswversion()"
&gt; python test.py       <font color="blue"># optional - checks everything works correctly</font>

</pre>Note that there will be many warnings during the compilation step about sqlite3.c, <a href=
"http://sqlite.org/faq.html#q17">but they are harmless</a>.

  <dl>
    <dt><b>Mac/Linux/etc</b></dt>
  </dl>
  <pre>
$ python setup.py install --fetch-sqlite
$ python -c "import apsw ; print  apsw.sqlitelibversion(), apsw.apswversion()"     
$ python test.py       <font color="blue"># optional - checks everything works correctly</font>

</pre>Note that there will be many warnings during the compilation step about sqlite3.c, <a href=
"http://sqlite.org/faq.html#q17">but they are harmless</a>.

  <p>The extension just turns into a single file apsw.so (Linux/Mac) or apsw.pyd (Windows). You don't need to install
  it and can drop it into any directory that is more convenient for you and that your code can reach. To just do the
  build and not install, leave out <code>install</code> from the lines above and add <code>build</code> if it isn't
  already there.</p>

  <p>If you want to check that your build is correct then you can run the unit tests. Run <tt>tests.py</tt>. It will
  print the APSW file used, APSW and SQLite versions and then run lots of tests all of which should pass.</p>

  <h2><a name="testing" id="testing">Testing</a></h2>

  <p>SQLite itself is extensively tested. It has considerably more code dedicated to testing than makes up the actual
  database functionality.</p>

  <p>APSW includes a tests.py file which uses the standard Python testing modules to verify correct operation. New code
  is developed alongside the tests. Reported issues also have test cases to ensure the issue doesn't happen or doesn't
  happen again.</p>
  <pre>
$ <b>python tests.py</b>
                Python /usr/bin/python (2, 5, 2, 'final', 0)
Testing with APSW file /usr/lib/python2.5/site-packages/apsw.so
          APSW version 3.6.0-r1
    SQLite lib version 3.6.0
SQLite headers version 3006000
.................................................
----------------------------------------------------------------------
Ran 49 tests in 13.302s

OK
</pre>

  <p>The tests also ensure that as much APSW code as possible is executed including alternate paths through the code.
  95.5% of the APSW code is executed by the tests. If you checkout the APSW source then there is an script <a href=
  "http://code.google.com/p/apsw/source/browse/apsw/trunk/coverage.sh"><tt>coverage.sh</tt></a> that enables extra code
  that deliberately induces extra conditions such as memory allocation failures, SQLite returning undocumented error
  codes etc. That brings coverage up to 99.5% of the code.</p>

  <p>A memory checker <a href="http://valgrind.org/">Valgrind</a> is used while running the test suite. The test suite
  is run 150 times to makes any memory leaks or similar issues stand out. A checking version of Python is also used.
  See <a href="http://code.google.com/p/apsw/source/browse/apsw/trunk/valgrind.sh"><tt>valgrind.sh</tt></a> in the
  source.</p>

  <p>To ensure compatibility with the various Python versions, a script downloads and compiles all supported Python
  versions in both 2 byte and 4 byte Unicode character configurations against the APSW and SQLite supported versions
  running the tests. See <a href=
  "http://code.google.com/p/apsw/source/browse/apsw/trunk/megatest.py"><tt>megatest.py</tt></a> in the source.</p>

  <p>In short both SQLite and APSW have a lot of testing!</p>

  <h1><a name="APIReference" id="APIReference">API Reference</a></h1>

  <p>Everything you can do from the <a href="http://www.sqlite.org/c3ref/intro.html">SQLite 3 C API</a> you can do from
  Python. The documentation below notes which C API functions are called where you can get further details on what
  happens. The only functionality not implemented is <a href="http://www.sqlite.org/c3ref/vfs.html">VFS</a> because it
  is being changed for SQLite 3.6. Additionally <a href="http://sqlite.org/c3ref/profile.html">sqlite3_trace</a> is not
  wrapped but instead <a href="#tracers">tracers</a> are provided that have more functionality.</p>

  <p>Some functions are marked experimental in the SQLite API. These have also been made available, but as the SQLite
  documentation notes these functions may change form or disappear in future versions of SQLite. You can exclude these
  functions by commenting out the relevant line in the <code>setup.py</code> when building aspw.</p>

  <p>Various methods create functions, collations and set various hooks and handlers. To remove the relevant
  function/collation/hook/handler, pass in None as the callable method.</p>

  <h2><a name="module-methods" id="module-methods">Module methods</a></h2>

  <dl>
    <dt><strong>sqlitelibversion()</strong></dt>

    <dd>
      <p>Returns the version of the SQLite library as a string. This function calls <a href=
      "http://sqlite.org/c3ref/libversion.html">sqlite3_libversion</a>.</p>
    </dd>

    <dt><strong>apswversion()</strong></dt>

    <dd>
      <p>Returns the version of the APSW module.</p>
    </dd>

    <dt><strong>enablesharedcache(boolean)</strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/enable_shared_cache.html">sqlite3_enable_shared_cache</a>. This sets
      the <a href="http://www.sqlite.org/sharedcache.html">shared cache mode</a> which was introduced in SQLite
      3.3.</p>
    </dd>

    <dt><strong>createmodule("modulename", module_object)</strong></dt>

    <dd>
      <p>Registers a virtual table. See <a href="#VirtualTables">virtual tables</a> for more details.</p>
    </dd>

    <dt><strong>initialize()</strong> &amp; <strong>shutdown</strong></dt>

    <dd>
      <p>Calls the <a href="http://sqlite.org/c3ref/initialize.html">sqlite3_initialize/sqlite3_shutdown</a> functions.
      There is no need to manually call these functions. Note that it is a really bad idea to call shutdown unless you
      are absolutely sure all connections and cursors have been closed, deleted and garbage collected.</p>
    </dd>

    <dt><strong>randomness(bytes)</strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/randomness.html">sqlite3_randomness</a> to obtain <i>bytes</i> of
      random data.</p>
    </dd>

    <dt><strong>config(op [,args])</strong></dt>

    <dd>
      <p>Calls the <a href="http://sqlite.org/c3ref/config.html">sqlite3_config</a> function. Only the options
      SQLITE_CONFIG_SINGLETHREAD, SQLITE_CONFIG_MULTITHREAD, SQLITE_CONFIG_SERIALIZED and SQLITE_CONFIG_MEMSTATUS are
      supported.</p>
    </dd>

    <dt><strong>memoryused()</strong></dt>

    <dd>
      <p>Returns the amount of memory SQLite is currently using by calling <a href=
      "http://sqlite.org/c3ref/memory_highwater.html">sqlite3_memory_used</a>.</p>
    </dd>

    <dt><strong>memoryhighwater(reset=False)</strong></dt>

    <dd>
      <p>Returns the most amount of memory SQLite has used by calling <a href=
      "http://sqlite.org/c3ref/memory_highwater.html">sqlite3_memory_highwater</a>. If <code>reset</code> is not False
      then the counter is reset.</p>
    </dd>

    <dt><strong>softheaplimit(bytes)</strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/soft_heap_limit.html">sqlite3_soft_heap_limit</a> requesting a soft
      upper bounds on the amount of memory SQLite uses.</p>
    </dd>

    <dt><strong>releasememory(bytes)</strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/release_memory.html">sqlite3_release_memory</a> requesting SQLite free
      up to <i>bytes</i> bytes of memory. Returns how much was actually freed.</p>
    </dd>

    <dt><strong>status(op, reset=False)</strong></dt>

    <dd>
      <p>Returns a tuple of current and highwater values for various SQLite counters by calling <a href=
      "http://sqlite.org/c3ref/status.html">sqlite3_status</a>. If <code>reset</code> is not False then the highwater
      is reset to the current value.</p>
    </dd>

    <dt><a name="exceptionfor" id="exceptionfor"><strong>exceptionfor(code)</strong></a></dt>

    <dd>
      <p>Returns an exception instance corresponding to a SQLite error code, in particular intended for mapping
      <a href="http://www.sqlite.org/cvstrac/wiki?p=ExtendedResultCodes">extended result codes</a> to <a href=
      "#Exceptions">exceptions</a>. In addition to picking the right exception class, it also sets the
      <tt>extendedresult</tt> attribute on the instance. This function is useful for returning specific errors in your
      VFS implementation. An example usage is:</p>

      <blockquote>
        <pre>
 raise apsw.exceptionfor(SQLITE_IOERR_SHORT_READ)
</pre>
      </blockquote>
    </dd>

    <dt><strong>vfsnames()</strong></dt>

    <dd>
      <p>Returns a list of the names of the installed vfs modules, with the default being first. You can use this to
      confirm that your vfs is installed. It is also useful if you want to install your vfs as the default and need the
      name of the previous default to inherit from.</p>
    </dd>
  </dl>

  <h2><a name="Module_variables" id="Module_variables">Module variables</a></h2>

  <dl>
    <dt><strong>connection_hooks</strong></dt>

    <dd>
      <p>The purpose of the hooks is to allow the easy registration of functions, virtual tables or similar items with
      each Connection as it is created. The default value is an empty list. Whenever a Connection is created, each item
      in <code>apsw.connection_hooks</code> is invoked with a single parameter being the new Connection object. If the
      hook raises an exception then the creation of the Connection fails.</p>
    </dd>
  </dl>

  <h2><a name="Module_constants" id="Module_constants">Module constants</a></h2>

  <p>Note that the same values can be used in different contexts. For example SQLITE_OK and SQLITE_CREATE_INDEX both
  have a value of zero. For each group of constants there is also a mapping (dict) available that you can supply a
  string to and get the corresponding numeric value, or supply a numeric value and get the corresponding string. These
  can help improve diagnostics/logging, calling other modules etc. For example</p>

  <blockquote>
    <pre>
apsw.mapping_authorizer_function["SQLITE_READ"]=20
apsw.mapping_authorizer_function[20]="SQLITE_READ"

</pre>
  </blockquote>

  <dl>
    <dt><strong>SQLITE_VERSION_NUMBER</strong></dt>

    <dd>
      <p>This is the version of the SQLite library from the header file <tt>sqlite3.h</tt> at apsw compile time. It is
      expressed as an integer (eg 3003010 for SQLite 3.3.10).</p>
    </dd>

    <dt><strong><a href="http://sqlite.org/c3ref/c_deny.html">SQLITE_OK, SQLITE_DENY, SQLITE_IGNORE</a></strong></dt>

    <dd>
      <p>These values are returned from authorizer functions. Mapping is
      <code>apsw.mapping_authorizer_return</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_alter_table.html"><strong>SQLITE_CREATE_INDEX, SQLITE_CREATE_TABLE</strong>
    and 30 others</a></dt>

    <dd>
      <p>The values are passed to authorizer functions. You can see a complete list in the <a href=
      "http://sqlite.org/c3ref/set_authorizer.html">sqlite3_set_authorizer documentation</a>. Mapping is
      <code>apsw.mapping_authorizer_function</code></p>
    </dd>

    <dt><strong>SQLITE_INDEX_CONSTRAINT_EQ, SQLITE_INDEX_CONSTRAINT_GT</strong> and 4 others</dt>

    <dd>
      <p>These values are passed to the BestIndex method of <a href="#VirtualTables">virtual tables</a>. Mapping is
      <code>apsw.mapping_bestindex_constraints</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_ioerr_blocked.html"><strong>SQLITE_IOERR_READ, SQLITE_IOERR_FSYNC</strong>
    and 7 others</a></dt>

    <dd>
      <p>These are <a href="http://sqlite.org/c3ref/c_ioerr_blocked.html">extended result codes</a> which are provided
      in <a href="#Exceptions">exceptions</a>. Mapping is <code>apsw.mapping_extended_result_codes</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_abort.html"><strong>SQLITE_OK, SQLITE_ERROR, SQLITE_PERM</strong> and 22
    others</a></dt>

    <dd>
      <p>These are <a href="http://sqlite.org/c3ref/c_abort.html">SQLite result codes</a> which are provided in
      <a href="#Exceptions">exceptions</a>. Mapping is <code>apsw.mapping_result_codes</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_open_create.html"><strong>SQLITE_OPEN_READONLY, SQLITE_OPEN_CREATE</strong>
    and 10 others</a></dt>

    <dd>
      <p>These are used for <a href="http://sqlite.org/c3ref/open.html">opening the database</a> as well as the VFS.
      Mapping is <code>apsw.mapping_open_flags</code></p>
    </dd>

    <dt><a href="http://www.sqlite.org/c3ref/c_limit_attached.html"><strong>SQLITE_LIMIT_LENGTH,
    SQLITE_LIMIT_SQL_LENGTH</strong> and 8 others</a>. Mapping is <code>apsw.mapping_limits</code></dt>

    <dd>
      <p>These are used for getting or setting <a href="http://www.sqlite.org/c3ref/limit.html">run-time limits</a></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_config_getmalloc.html"><strong>SQLITE_CONFIG_SINGLETHREAD,
    SQLITE_CONFIG_MULTITHREAD</strong> and 9 others</a></dt>

    <dd>
      <p>These are used with <a href="http://sqlite.org/c3ref/config.html">sqlite3_config</a>. Mapping is
      <code>apsw.mapping_config</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_status_malloc_size.html"><strong>SQLITE_STATUS_MEMORY_USED,
    SQLITE_STATUS_PAGECACHE_USED</strong> and 4 others</a></dt>

    <dd>
      <p>These are used with <a href="http://sqlite.org/c3ref/status.html">sqlite3_status</a>. Mapping is
      <code>apsw.mapping_status</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_lock_exclusive.html"><strong>SQLITE_LOCK_NONE, SQLITE_LOCK_SHARED</strong>
    and 3 others</a></dt>

    <dd>
      <p>These are used with the <a href="http://sqlite.org/c3ref/io_methods.html">xLock/xUnlock</a> VFS file methods.
      Mapping is <code>apsw.mapping_locking_level</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_iocap_atomic.html"><strong>SQLITE_IOCAP_ATOMIC, SQLITE_IOCAP_ATOMIC512,
    SQLITE_IOCAP_ATOMIC1K</strong> and 8 others</a></dt>

    <dd>
      <p>These are used with the <a href="http://sqlite.org/c3ref/io_methods.html">xDeviceCharacteristics</a> VFS file
      method. Mapping is <code>apsw.mapping_device_characteristics</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_sync_dataonly.html"><strong>SQLITE_SYNC_NORMAL, SQLITE_SYNC_FULL</strong>
    and 1 other</a></dt>

    <dd>
      <p>These are used with the <a href="http://sqlite.org/c3ref/io_methods.html">xSync</a> VFS file method. Mapping
      is <code>apsw.mapping_sync</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_access_exists.html"><strong>SQLITE_ACCESS_EXISTS, SQLITE_ACCESS_READWRITE,
    SQLITE_ACCESS_READ</strong></a></dt>

    <dd>
      <p>These are used with the xAccess <a href="http://sqlite.org/c3ref/vfs.html">VFS method</a>. Mapping is
      <code>apsw.mapping_access</code>.</p>
    </dd>
  </dl>

  <h2><a name="Connection_class" id="Connection_class">Connection class</a></h2>

  <p>The connection class wraps a <code>sqlite3 pointer</code>.</p>

  <dl>
    <dt><strong>Connection(filename, flags=SQLITE_OPEN_READWRITE|SQLITE_OPEN_CREATE, vfs=None,
    statementcachesize=100)</strong></dt>

    <dd>
      <p>Opens an SQLite database named <code>filename</code>. (This calls <a href=
      "http://sqlite.org/c3ref/open.html">sqlite3_open_v2</a> behind the scenes.) If you don't supply a vfs then the
      default will be used. You can also set how many entries there are in the statement cache. You will generally want
      this to be the total number of distinct SQL statements you execute frequently.</p>
    </dd>

    <dt><strong>close(force=False)</strong></dt>

    <dd>
      <p>You must call this method when you are done with a Connection. Behind the scenes it calls <a href=
      "http://sqlite.org/c3ref/close.html">sqlite3_close</a>. It is ok to call this method multiple times. Note that
      this method can raise an exception. Some examples of when exceptions are raised:</p>

      <ul>
        <li>You have statements still executing (ie currently positioned at a row, with more statements to execute).
        Statements that have consumed all results will not hold up closing a Connection.</li>

        <li>You were in the middle of a transaction. SQLite will attempt to do a rollback and errors in your rollback
        hook will be passed back.</li>

        <li>Any virtual tables will be dropped/disconnected. Errors in your Disconnect/Destroy methods will be passed
        back.</li>
      </ul>

      <p>If <tt>force</tt> is True, then any executing cursors are forcibly closed.</p>
    </dd>

    <dt><strong>cursor()</strong></dt>

    <dd>
      <p>Creates a new <a href="#Cursor">cursor</a> object on this database.</p>
    </dd>

    <dt><strong>changes()</strong></dt>

    <dd>
      <p>This function returns the number of database rows that were changed (or inserted or deleted) by the most
      recently completed INSERT, UPDATE, or DELETE statement. (This calls <a href=
      "http://sqlite.org/c3ref/changes.html">sqlite3_changes</a>. Read that link for some additional notes.)</p>
    </dd>

    <dt><strong>totalchanges()</strong></dt>

    <dd>
      <p>This function returns the total number of database rows that have be modified, inserted, or deleted since the
      database connection was opened. (This calls <a href=
      "http://sqlite.org/c3ref/total_changes.html">sqlite3_total_changes</a>. Read that link for some additional
      notes.)</p>
    </dd>

    <dt><strong>last_insert_rowid()</strong></dt>

    <dd>
      <p>Returns the integer key of the most recent insert in the database. (This calls <a href=
      "http://sqlite.org/c3ref/last_insert_rowid.html">sqlite3_last_insert_rowid</a>.)</p>
    </dd>

    <dt><strong>complete(statement)</strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/complete.html">sqlite3_complete</a> which tells you if the input string
      comprises one or more complete SQL statements.</p>
    </dd>

    <dt><strong>setbusytimeout(milliseconds)</strong></dt>

    <dd>
      <p>Sets the busy timeout. (This calls <a href=
      "http://sqlite.org/c3ref/busy_timeout.html">sqlite3_busy_timeout</a>).</p>
    </dd>

    <dt><strong>setbusyhandler(callable)</strong></dt>

    <dd>
      <p>Sets the busy handler to callable. callable will be called with one integer argument which is the number of
      prior calls to the busy callback for the same lock. If the busy callback returns something that evaluates to
      False, then SQLite returns SQLITE_BUSY to the calling code.. If the callback returns something that evaluates to
      True, then SQLite tries to open the table again and the cycle repeats. (This calls <a href=
      "http://sqlite.org/c3ref/busy_handler.html">sqlite3_busy_handler</a>).</p>
    </dd>

    <dt><strong>interrupt()</strong></dt>

    <dd>
      <p>Causes any pending operations on the database to abort at the earliest opportunity. You can call this from any
      thread. (This calls <a href="http://sqlite.org/c3ref/interrupt.html">sqlite3_interrupt</a>).</p>
    </dd>

    <dt><a name="Connection_limit" id="Connection_limit"><strong>limit(id [, newval])</strong></a></dt>

    <dd>
      <p>If called with one parameter then the relevant limit is returned. If called with two then the limit is
      changed. Returns the old value of the limit. This calls <a href=
      "http://www.sqlite.org/c3ref/limit.html">sqlite3_limit</a>. For example
      <code>connection.limit(apsw.SQLITE_LIMIT_LENGTH, 1024)</code> would set the limit for blobs and strings to 1
      kilobyte. To find the maximum value, set the limit to 0x7fffffff and then call <tt>connection.limit</tt> again to
      see what value it was set to.</p>
    </dd>

    <dt><strong>createscalarfunction(name, callable, numargs=-1)</strong></dt>

    <dd>
      <p>Registers a scalar function. The callable will be called. You can specify how many arguments your function
      takes as the numargs parameter or supply -1 to take any amount. (This calls <a href=
      "http://sqlite.org/c3ref/create_function.html">sqlite3_create_function</a>).</p>
    </dd>

    <dt><strong>createaggregatefunction(name, factorycallback, numargs=-1)</strong></dt>

    <dd>
      <p>Registers an aggregate function. (This calls <a href=
      "http://sqlite.org/c3ref/create_function.html">sqlite3_create_function</a>.) You can specify how many arguments
      your function takes as the numargs parameter or supply -1 to take any amount. When the function is called by an
      SQL query, the factorycallback is called without any arguments. The factorycallback needs to return a tuple
      consisting of three 3 items.</p>

      <ul>
        <li>
          <p>a context object (of any type)</p>
        </li>

        <li>
          <p>a step function which is called for each row. The context object will be the first parameter, and the
          remaining parameters will be from the SQL statement. The return value is ignored - you supply it in
          final.</p>
        </li>

        <li>
          <p>a final function which is called at the end. The only parameter will be the context object. The value
          returned is set as the return for the function. It must be a valid SQLite type. Note that the final function
          is always called even if an exception was raised by the step function. This allows you to ensure any
          resources are cleaned up.</p>
        </li>
      </ul>
    </dd>

    <dt><strong>createcollation(name, callable)</strong></dt>

    <dd>
      <p>Creates a collation with the specified name and callable. The callable will be passed two string arguments. It
      should return -1 if the first is less than the second, 0 if they are equal and 1 and if the first is greater than
      the second. Note that this controls sorting (ORDER BY in SQL) so your comparisons don't affect other SQL
      operations. Read more about <a href="http://www.sqlite.org/datatype3.html#collation">SQLite's handling of
      collations.</a> (This calls <a href=
      "http://sqlite.org/c3ref/create_collation.html">sqlite3_create_collation</a>.) If there is an error in your
      Python code then 0 (ie items are equal) is returned.</p>
    </dd>

    <dt><strong>collationneeded(callable)</strong></dt>

    <dd>
      <p><tt>callable</tt> will be called if a statement requires a collation that hasn't been registered. Your
      callable will be passed two parameters. The first is the connection object. The second is the name of the
      collation. If you have the collation code available then call createcollation, else just return.</p>
    </dd>

    <dt><strong>setauthorizer(callable)</strong></dt>

    <dd>
      <p>The callable is invoked while SQL statements are being prepared. The intent is to allow applications to safely
      execute user entered SQL. The callable is called with 5 parameters:</p>

      <ul>
        <li>
          <p>an integer representing the operation (the constants are available on the apsw module - eg
          <code>apsw.SQLITE_CREATE_TABLE</code>.</p>
        </li>

        <li>
          <p>A string (or None) dependent on the operation</p>
        </li>

        <li>
          <p>Another string (or None) dependent on the operation</p>
        </li>

        <li>
          <p>The string name of the database (or None)</p>
        </li>

        <li>
          <p>Name of the innermost trigger or view doing the access (or None)</p>
        </li>
      </ul>

      <p>You should return <code>apsw.SQLITE_OK</code> to allow the operation or <code>apsw.SQLITE_DENY</code> or
      <code>apsw.SQLITE_IGNORE</code> as applicable. (SQLITE_DENY is returned if there is an error in your Python
      code).</p>

      <p>This calls <a href="http://sqlite.org/c3ref/set_authorizer.html">sqlite3_set_authorizer</a> which contains
      more detailed documentation.</p>
    </dd>

    <dt><strong>setupdatehook(callable)</strong></dt>

    <dd>
      <p>Sets a callable which is invoked during data changing. The callable takes four parameters:</p>

      <ul>
        <li>An integer whose value is one of apsw.SQLITE_INSERT, apsw.SQLITE_DELETE or apsw.SQLITE_UPDATE</li>

        <li>A string naming the database on which the operation is happening. (This will typically be <tt>main</tt>
        unless you used <a href="http://sqlite.org/lang_attach.html"><tt>ATTACH</tt></a></li>

        <li>A string naming the table on which the operation is happening.</li>

        <li>An integer with the rowid of the row that is changing.</li>
      </ul>

      <p>(This calls <a href="http://sqlite.org/c3ref/update_hook.html">sqlite3_update_hook</a>.)</p>
    </dd>

    <dt><strong>setrollbackhook(callable)</strong></dt>

    <dd>
      <p>Sets a callable which is invoked during a rollback. The callable takes no parameters and the return value is
      ignored. (This calls <a href="http://sqlite.org/c3ref/commit_hook.html">sqlite3_rollback_hook</a>.)</p>
    </dd>

    <dt><strong>setcommithook(callable)</strong> (SQLite 3 experimental feature)</dt>

    <dd>
      <p>Sets a callable which is invoked just before a commit. It should return zero for the commit to go ahead and
      non-zero for it to be turned into a rollback. In the case of an exception in your callable, a non-zero (ie
      rollback) value is returned. (This calls <a href=
      "http://sqlite.org/c3ref/commit_hook.html">sqlite3_commit_hook</a>.)</p>
    </dd>

    <dt><strong>setprofile(callable)</strong> (SQLite 3 experimental feature)</dt>

    <dd>
      <p>Sets a callable which is invoked at the end of execution of each statement and passed the statement string and
      how long it took to execute. (The execution time appears to be in nanoseconds.) Note that it is called only on
      completion. If for example you do a <tt>SELECT</tt> and only read the first result, then you won't reach the end
      of the statement.</p>

      <p>(This calls <tt>sqlite3_profile</tt> which is not documented on the SQLite web site. See the
      <tt>sqlite3.h</tt> header file for documentation.).</p>
    </dd>

    <dt><strong>setprogresshandler(callable, nsteps=20)</strong> (SQLite 3 experimental feature)</dt>

    <dd>
      <p>Sets a callable which is invoked every <i>nsteps</i> SQLite inststructions. The callable should return a
      non-zero value to abort or zero to continue. (If there is an error in your Python callable then non-zero will be
      returned). (This calls <a href="http://sqlite.org/c3ref/progress_handler.html">sqlite3_progress_handler</a> which
      has more detailed documentation).</p>
    </dd>

    <dt><strong>enableloadextension(bool)</strong> (SQLite 3 experimental feature)</dt>

    <dd>
      <p>Enables <a href="http://www.sqlite.org/cvstrac/wiki/wiki?p=LoadableExtensions">extension</a> loading which is
      disabled by default. Calls sqlite3_enable_load_extension. See note below about enabling extension loading.</p>
    </dd>

    <dt><strong>loadextension(filename, entrypoint=None)</strong> (SQLite 3 experimental feature)</dt>

    <dd>
      <p>Loads an <a href="http://www.sqlite.org/cvstrac/wiki/wiki?p=LoadableExtensions">extension</a> by calling
      sqlite3_load_extension. If you don't specify the entrypoint then SQLite uses a default of
      sqlite3_extension_init.</p>

      <p>Note that if you build SQLite on Unix then extension loading won't be built into SQLite by default. The
      details are in SQLite ticket <a href="http://www.sqlite.org/cvstrac/tktview?tn=2082">2082</a>. You need to edit
      <tt>setup.py</tt> if you enable extension loading.</p>
    </dd>

    <dt><strong><a name="filecontrol" id="filecontrol">filecontrol(op, pointer)</a></strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/file_control.html">sqlite3_file_control</a>. <i>op</i> should be a
      number with values below 100 reserved by SQLite. This is an example if how to pass a Python object using <a href=
      "http://docs.python.org/lib/module-ctypes.html">ctypes</a>.</p>
      <pre>
obj={"foo": 1, 2: 3}                 # object we want to pass
objwrap=ctypes.py_object(obj)        # objwrap must live before and after the call else
                                     # it gets garbage collected
connection.filecontrol(
         123,                        # our op code
         ctypes.addressof(objwrap))  # get pointer
</pre>

      <p>In your VFS file implementation, you turn the pointer back into a Python object like this:</p>
      <pre>
def xFileControl(self, op, pointer):
    if op==123:                      # our op code
        obj=ctypes.py_object.from_address(pointer).value
        # play with obj - you can use id() to verify it is the same
        print obj["foo"]
        obj["result"]="it worked"
    else:
        raise Exception("Unknown file control "+`op`)
</pre>
    </dd>

    <dt><strong>blobopen(databasename, tablename, columnname, rowid, flags)</strong></dt>

    <dd>Returns a new <a href="#blobio">blob</a>. The database name will be <tt>main</tt>, unless you want to refer to
    a database you <a href="http://www.sqlite.org/lang_attach.html">ATTACH</a>ed.</dd>
  </dl>

  <h2><a name="blobio" id="blobio">Blob I/O</a></h2>

  <p>Historically SQLite only let you access and create blobs in their entirity. For example to reading or writing a
  single byte from a blob required reading or writing the whole blob.</p>

  <p>SQLite now provides incremental blob access, with APSW exposing it as a file like object. Call Connection.blobopen
  to open a blob. <b>Note</b> that the underlying <a href="http://www.sqlite.org/c3ref/blob.html">SQLite blob apis</a>
  require offsets to be provided to each call, but the APSW blob object tracks that for you.</p>

  <dl>
    <dt><strong>close(force=False)</strong></dt>

    <dd>
      <p>Stops any further access to the blob. You should proactively call close as it will return errors that may
      correspond to earlier blob i/o. See <a href="http://www.sqlite.org/c3ref/blob_close.html">blob_close()</a> for
      more details. If you call any of the other methods on a closed blob then you will get a ValueError exception
      (this is the same as calling methods on a closed Python file object).</p>

      <p><i>force</i> currently has no effect and is present for compatibility with cursor objects.</p>
    </dd>

    <dt><strong>read([amount])</strong></dt>

    <dd>Reads amount of data requested, or till end of file, whichever is earlier. Attempting to read beyond the end of
    the blob returns the empty string, in the same manner as end of file on normal file objects.</dd>

    <dt><strong>write(data)</strong></dt>

    <dd>Writes the requested data. Note that you cannot make the blob larger or smaller. Normally you would create a
    zeroblob and then come back and fill it in with this method, as shown in the <a href=
    "#example-blobio">example</a>.</dd>

    <dt><strong>tell()</strong></dt>

    <dd>Returns the current position.</dd>

    <dt><strong>seek(offset, [whence])</strong></dt>

    <dd>Change the current position. If whence is omitted or zero, then the position is set to offset. If whence is 1
    then offset is added to the current position. If whence is 2 then offset is relative to the end of the blob.</dd>
  </dl>

  <h2><a name="Cursor" id="Cursor">Cursor class</a></h2>

  <p>The Cursor class creates and executes SQLite prepared statements.</p>

  <dl>
    <dt><strong>Cursor()</strong></dt>

    <dd>
      <p>You cannot create cursors directly. The are created by calling Connection.cursor().</p>
    </dd>

    <dt><strong>close(force=False)</strong></dt>

    <dd>
      <p>In general cursors are in a closed state, and you won't need to call this method. Calling while the cursor is
      already closed or if the Connection is closed will not result in errors. An open Cursor prevents closing of
      Connections. The circumstances in which they are not closed include:</p>

      <ul>
        <li>You haven't requested all the rows of available data (calling next() or using the cursor as an iterator
        will return more data)</li>

        <li>You got a recoverable error and can try again (eg SQLITE_BUDY)</li>

        <li>If force is False then you will get exceptions if there is remaining work to do be in the Cursor such as
        more statements to execute, more data from the executemany binding sequence etc. If force is True then all
        remaining work and state information will be discarded.</li>
      </ul>
    </dd>

    <dt><strong>getconnection()</strong></dt>

    <dd>
      <p>Returns the <a href="#Connection">Connection</a> object to which this cursor belongs.</p>
    </dd>

    <dt><strong>execute(statements, bindings=())</strong></dt>

    <dd>
      <p>Executes the statements using the supplied bindings. The bindings can be supplied as a tuple or as a dict.
      Execution returns when the first row is available or all statements have completed. The cursor object is returned
      which you can use as an iterator. (See <a href="#executionmodel">execution model</a> for more details. This
      function wraps <a href="http://sqlite.org/c3ref/prepare.html">sqlite3_prepare_v2</a> and <a href=
      "http://sqlite.org/c3ref/step.html">sqlite3_step</a>.)</p>
    </dd>

    <dt><strong>executemany(statements, sequenceofbindings=())</strong></dt>

    <dd>
      <p>Repeatedly executes statements using each element of sequenceofbindings for the bindings each time. Execution
      returns when the first row is available or all statements have completed. The cursor object is returned which you
      can use as an iterator. (See <a href="#executionmodel">execution model</a> for more details. This function runs
      in a loop on each member of sequenceofbindings and wraps <a href=
      "http://sqlite.org/c3ref/prepare.html">sqlite3_prepare_v2</a> and <a href=
      "http://sqlite.org/c3ref/step.html">sqlite3_step</a>.)</p>
    </dd>

    <dt><strong>next()</strong></dt>

    <dd>
      <p>The Cursor object is an iterator, and so you can use it in a for loop or similar situations. You can also
      explicitly call the <code>next()</code> method. This method returns a tuple of the contents of a returned row or
      raises StopIteration after all returned rows have been seen.</p>
    </dd>

    <dt><strong>getdescription()</strong></dt>

    <dd>
      <p>Returns a list describing each column in the current result set. Each item is a tuple of (column name,
      declared column type). You should only call this function while data is being returned such as when
      <code>next()</code> returns a row. This function calls <a href=
      "http://sqlite.org/c3ref/column_name.html">sqlite3_column_name</a> and <a href=
      "http://sqlite.org/c3ref/column_decltype.html">sqlite3_column_decltype</a>.</p>
    </dd>

    <dt><strong>setexectrace(callable)</strong><br />
    <strong>setrowtrace(callable)</strong><br />
    <strong>getexectrace()</strong><br />
    <strong>getrowtrace()</strong></dt>

    <dd>
      <p>Sets or gets the <a href="#tracers">tracers</a>.</p>
    </dd>
  </dl>

  <h2><a name="VirtualTables" id="VirtualTables">Virtual Tables</a></h2>

  <p><a href="http://www.sqlite.org/cvstrac/wiki?p=VirtualTables">Virtual Tables</a> are an experimental feature
  introduced in SQLite 3.3.7. They let a developer provide underlying table implementations, while still presenting a
  normal SQL interface to the user. The person writing SQL doesn't need to know or care that some of the tables come
  from elsewhere.</p>

  <p>Some examples of how you might use this:</p>

  <ul>
    <li>Translating to/from information stored in other formats (eg a csv/ini format file)</li>

    <li>Accessing the data remotely (eg you could make a table that backends into <a href=
    "http://www.josephson.org/projects/pyamazon/">Amazon's API</a></li>

    <li>Dynamic information (eg currently running processes, files and directories, objects in your program)</li>

    <li>Information that needs reformatting (eg if you have complex rules about how to convert strings to/from Unicode
    in the dataset)</li>

    <li>Information that isn't relationally correct (eg if you have data that has ended up with duplicate "unique" keys
    with code that dynamically corrects it)</li>

    <li>There are other examples on the <a href="http://www.sqlite.org/cvstrac/wiki?p=VirtualTables">SQLite
    page</a></li>
  </ul>

  <p>You need to have 3 types of object. A module, a virtual table and a cursor. These are documented below. You can
  also read the <a href="http://www.sqlite.org/cvstrac/wiki?p=VirtualTableMethods">SQLite C method documentation</a>.
  At the C, they are just one set of methods. At the Python/apsw level, they are split over the 3 types of object. The
  leading <tt><i>x</i></tt> is ommitted in Python. You can return SQLite error codes (eg <code>SQLITE_READONLY</code>)
  by raising the appropriate exceptions (eg <code>apsw.ReadOnlyError</code>).</p>

  <h3>Module</h3>

  <p>The module is used to create the virtual tables. Once you have a module object, you register it with a connection
  by calling <code>Connection.createmodule("modulename", module_object)</code>. To create the table, you use SQL:
  <code>CREATE <b>VIRTUAL</b> TABLE tablename USING modulename<i>(arg0, arg1, ...)</i></code></p>

  <dl>
    <dt><strong>Create(connection, modulename, databasename, tablename, *args)</strong></dt>

    <dd>
      <p>This is called when a table is first created on a connection. The optional args are passed from the SQL CREATE
      statement.</p>

      <p><b>Return</b> two items. The first item should be a string with SQL specifying the schema for the table. The
      second item is an Object that implements the table methods. Later methods in the Table and Cursor objects will
      reference the columns by number, starting at zero with column -1 being the rowid. Every row must have a unique
      unchanging integer rowid up to 64bit signed integer.</p>
    </dd>

    <dt><strong>Connect(connection, modulename, databasename, tablename, *args)</strong></dt>

    <dd>
      <p>Similar to Create, except it is called to establish a new connection to an existing table. The paramaters and
      return are the same. In general Create is called the first time a table is accessed and is where you are expect
      to do heavy initialisation work. Connect can take that initialized work and reuse it.</p>
    </dd>
  </dl>

  <h3>Table</h3>

  <p>The table contains knowledge of the indices, makes cursors and can perform transactions.</p>

  <dl>
    <dt><strong>Begin() Sync() Commit() Rollback()</strong> (optional)</dt>

    <dd>
      <p>These functions are used as part of transactions. At the time of writing they are undocumented in SQLite (see
      <a href=
      "http://www.sqlite.org/cvstrac/wiki?p=VirtualTableMethods">www.sqlite.org/cvstrac/wiki?p=VirtualTableMethods</a>.
      They do not take any arguments nor return anything. You do not have to provide these methods.</p>
    </dd>

    <dt><strong>Disconnect()</strong> (optional)<br />
    <strong>Destroy()</strong></dt>

    <dd>
      <p>These methods are the opposite of <code>Connect</code> and <code>Create</code> in the module implementation.
      They can be considered destructors for the virtual table instance. It is currently unclear how SQLite behaves if
      you return an error (<a href="http://www.sqlite.org/cvstrac/tktview?tn=2099">ticket 2099</a>). Note that SQLite
      does ignore errors in the Disconnect method. If you do have one, you will get an exception from the
      <code>close()</code> method, but the database will actually be closed.</p>
    </dd>

    <dt><strong>Open()</strong></dt>

    <dd>
      <p>Returns a new cursor object.</p>
    </dd>

    <dt><strong>Rename(newname)</strong> (optional)</dt>

    <dd>
      <p>Notification that the table will be given a new name. If you return without raising an exception, then SQLite
      renames the table (you don't have to do anything). If you raise an exception then the renaming is prevented.</p>
    </dd>

    <dt><strong>FindFunction(nfuncargs, funcname)</strong> <i>not implemented yet</i></dt>

    <dd>
      <p>Lets you provide an alternate function implementation for the table. This is currently not implemented in apsw
      because of incomplete information in SQLite to make it safe (<a href=
      "http://www.sqlite.org/cvstrac/tktview?tn=2095">ticket 2095</a>).</p>
    </dd>

    <dt><strong>UpdateDeleteRow(rowid)</strong></dt>

    <dd>
      <p>Requests deletion of the row with the specified id.</p>

      <p><b>Return</b> None (ignored)</p>
    </dd>

    <dt><strong>UpdateInsertRow(rowid, fields)</strong></dt>

    <dd>
      <p>Create a new row. fields is a tuple the same size as the number of columns in your table containing a value
      for each column. rowid is the rowid to give the row. If rowid is None then you must make up a rowid you want.</p>

      <p><b>Return</b> the new rowid (if rowid was None), else ignored</p>
    </dd>

    <dt><strong>UpdateChangeRow(rowid, newrowid, fields)</strong></dt>

    <dd>
      <p>Change an existing row of the table with the values in fields. fields is a tuple the same size as the number
      of columns in your table containing a value for each column. If newrowid is not the same as rowid then you also
      have to change the rowid (this would happen for a query like <code>UPDATE table SET rowid=rowid+100 WHERE
      ...</code>)</p>

      <p><b>Return</b> None (ignored)</p>
    </dd>

    <dt><strong>BestIndex(constraints, orderbys)</strong></dt>

    <dd>
      <blockquote>
        This is a complex method and even has its <a href=
        "http://www.sqlite.org/cvstrac/wiki?p=VirtualTableBestIndexMethod">own page</a> in the SQLite documentation. To
        get going initially, just return <code>None</code> and you will be fine. Implementing this method reduces the
        number of rows scanned in your table to satisfy queries, but only if you have an index or index like mechanism
        available.

        <p><b>Note</b> The implementation of this method differs slightly from the <a href=
        "http://www.sqlite.org/cvstrac/wiki?p=VirtualTableBestIndexMethod">SQLite documentation</a> for the C API. You
        are not passed "unusable" constraints. The argv/constraintarg positions are not off by one. In the C api, you
        have to return position 1 to get something passed to Filter in position 0. With the APSW implementation, you
        return position 0 to get Filter arg 0, position 1 to get Filter arg 1 etc.</p>
      </blockquote>

      <p>The purpose of this method is to ask if you have the ability to determine if a row meets certain constraints
      that doesn't involve visiting every row. An example constraint is <code>price&nbsp;&gt;&nbsp;74.99</code>. In a
      traditional SQL database, queries with constraints can be speeded up <a href=
      "http://www.sqlite.org/lang_createindex.html">with indices</a>. If you return None, then SQLite will visit every
      row in your table and evaluate the constraint itself. Your index choice returned from BestIndex will also be
      passed to the Filter method on your cursor object. Note that SQLite may call this method multiple times trying to
      find the most efficient way of answering a query. You will be passed the contraints as a sequence of tuples
      containing two items. The first item is the column number and the second item is the operation.</p>

      <blockquote>
        Example query: <code>select * from foo where price&gt;74.99 and quantity&lt;=10 and customer=="Acme
        Widgets"</code>.

        <p>If customer is column 0, price column 2 and quantity column 5, then constraints will be:</p>
        <pre>
   (2, apsw.SQLITE_INDEX_CONSTRAINT_GT),
   (5, apsw.SQLITE_INDEX_CONSTRAINT_LE),
   (0, apsw.SQLITE_INDEX_CONSTRAINT_EQ)

</pre>

        <p>Note that you do not get the value of the constraint (eg "Acme Widgets", 74.99 and 10 in this example).</p>
      </blockquote>

      <p>The first item you return is None if you don't have an appropriate index for any of the constraints and SQLite
      should iterate over every row. If you do have a suitable index then you return as the first item a sequence the
      same length as constraints with the members mapping to the constraints in order. Each item can be one of None, an
      integer or a tuple of an integer and a boolean.</p>

      <dl>
        <dt>None</dt>

        <dd>This means you have no index for that constraint. SQLite will have to iterate over every row for it.</dd>

        <dt>integer</dt>

        <dd>This is the argument number for the constraintargs being passed into the Filter function of your cursor
        (the values "Acme Widgets", 74.99 and 10 in the example).</dd>

        <dt>(integer, boolean)</dt>

        <dd>By default SQLite will check what you return. For example if you said that you had an index on price,
        SQLite will still check that each row you returned is greater than 74.99. If you set the boolean to False then
        SQLite won't do that double checking.</dd>
      </dl>

      <blockquote>
        Example query: <code>select * from foo where price&gt;74.99 and quantity&le;10 and customer=="Acme
        Widgets"</code>.

        <p>Customer is column 0, price column 2 and quantity column 5. You can index on customer equality and
        price.</p>

        <table border="1" cellspacing="5" cellpadding="5" summary="BestIndex example">
          <tr>
            <th>Constraints (in)</th>

            <th>Constraints used (out)</th>
          </tr>

          <tr>
            <td valign="top">
              <pre>
   (2, apsw.SQLITE_INDEX_CONSTRAINT_GT),
   (5, apsw.SQLITE_INDEX_CONSTRAINT_LE),
   (0, apsw.SQLITE_INDEX_CONSTRAINT_EQ)
</pre>
            </td>

            <td valign="top">
              <pre>
   1,
   None,
   0
</pre>
            </td>
          </tr>
        </table>
      </blockquote>

      <p>When your Filter method in the cursor is called, constraintarg[0] will be "Acme Widgets" (customer constraint
      value) and constraintarg[1] will be 74.99 (price constraint value). You can also return an index number (integer)
      and index string to use (SQLite attaches no significance to these values - they are passed as is to your
      Cursor.Filter method as a way for the BestIndex method to let the Cursor.Filter method know which of your indices
      or similar mechanism to use.</p>

      <p>The second argument to BestIndex is a sequence of orderbys because the query requested the results in a
      <a href="http://sqlite.org/lang_select.html">certain order</a>. If your data is already in that order then SQLite
      can give the results back as is. If not, then SQLite will have to sort the results first.</p>

      <blockquote>
        Example query: <code>select * from foo order by price desc, quantity asc</code>

        <p>Price is column 2, quantity column 5 so orderbys will be:</p>
        <pre>
  (2, True),  <font color="blue"># True means descending, False is ascending</font>
  (5, False)

</pre>
        <pre>


</pre>
      </blockquote>

      <p><b>Return</b> You should return up to 5 items. Items not present in the return have a default value.</p>

      <dl>
        <dt>0: constraints used (default None)</dt>

        <dd>This must either be None or a sequence the same length as constraints passed in. Each item should be as
        specified above saying if that constraint is used, and if so which constraintarg to make the value be in your
        Cursor.Filter function.</dd>

        <dt>1: index number (default zero)</dt>

        <dd>This value is passed as is to Cursor.Filter</dd>

        <dt>2: index string (default None)</dt>

        <dd>This value is passed as is to Cursor.Filter</dd>

        <dt>3: orderby consumed (default False)</dt>

        <dd>Return True if your output will be in exactly the same order as the orderbys passed in</dd>

        <dt>4: estimated cost (default a huge number)</dt>

        <dd>Approximately how many disk operations are needed to provide the results. SQLite uses the cost to optimise
        queries. For example if the query includes <code>A or B</code> and A has 2,000 operations and B has 100 then it
        is best to evaluate B before A.</dd>
      </dl>

      <blockquote>
        A complete example. Query is <code>select * from foo where price&gt;74.99 and quantity&lt;=10 and
        customer=="Acme Widgets" order by price desc, quantity asc</code>

        <p>Customer is column 0, price column 2 and quantity column 5. You can index on customer equality and
        price.</p>
        <pre>
<b>BestIndex</b>(constraints, orderbys)
 
<b>constraints</b>= ( (2, apsw.SQLITE_INDEX_CONSTRAINT_GT), 
                  (5, apsw.SQLITE_INDEX_CONSTRAINT_LE), 
                  (0, apsw.SQLITE_INDEX_CONSTRAINT_EQ)  )

<b>orderbys</b>= ( (2, True), (5, False) )

</pre>

        <p>You return</p>
        <pre>
( (1, None, 0),   <font color="blue"># constraints used</font>
  27,             <font color="blue"># index number</font>
  "idx_pr_cust",  <font color="blue"># index name</font>
  False,          <font color="blue"># results are not in orderbys order</font>
  1000            <font color="blue"># about 1000 disk operations to access index</font>
)

</pre>

        <p>Your Cursor.Filter method will be called with:</p>
        <pre>
27,              <font color="blue"># index number you returned</font>
"idx_pr_cust",   <font color="blue"># index name you returned</font>
"Acme Widgets",  <font color="blue"># constraintarg[0] - customer</font>  
74.99            <font color="blue"># constraintarg[1] - price </font>

</pre>
      </blockquote>

      <h3>Cursor</h3>

      <p>Cursors are created by the Open method in the table object. They iterate over rows returning desired
      values.</p>

      <dl>
        <dt><strong>Close()</strong></dt>

        <dd>
          <p>This is the destructor for the cursor. Note that you must cleanup. The method will not be called again if
          you raise an exception.</p>

          <p><b>Return</b> None (ignored)</p>
        </dd>

        <dt><strong>Filter(indexnum, indexstring, constraintargs)</strong></dt>

        <dd>
          <p>This method is always called first to initialize an iteration to the first row of the table. The arguments
          come from the BestIndex method in the table object with constraintargs being a tuple of the constraints you
          requested. If you always return None in BestIndex then indexnum will be zero, indexstring will be None and
          constraintargs will be empty).</p>

          <p><b>Return</b> None (ignored)</p>
        </dd>

        <dt><strong>Eof()</strong></dt>

        <dd>
          <p>Called to ask if we are at the end of the table. It is called after each call to Filter and Next.</p>

          <p><b>Return</b> True if the cursor is at a valid row of data, else False. Note that if you have an exception
          in this method, or do not provide it then False will be returned to SQLite.</p>
        </dd>

        <dt><strong>Next()</strong></dt>

        <dd>
          <p>Advance to the next row in the table.</p>

          <p><b>Return</b> None (ignored)</p>
        </dd>

        <dt><strong>Rowid()</strong></dt>

        <dd>
          <p><b>Return</b> the current rowid. This should be an integer up to 64 bits signed.</p>
        </dd>

        <dt><strong>Column(number)</strong></dt>

        <dd>
          <p>Requests the value of the specified column number. Column numbering starts at zero with -1 being the
          rowid.</p>

          <p><b>Return</b> the value in that column. It must be compatible with SQLite types (ie one of None, integer,
          float, string or buffer (blob))</p>
        </dd>
      </dl>

      <h3>Troubleshooting virtual tables</h3>

      <p>Virtual Tables are a recent addition to SQLite and haven't been widely used yet. They do work well if all your
      routines work perfectly.</p>

      <p>A big help is using the local variables recipe as described in <a href="#augmentedstacktraces">augmented stack
      traces</a> which will give you more details in errors. You may also find errors compounding. For example if you
      have an error in the Filter method of a cursor, SQLite then closes the cursor. If you also return an error in the
      Close method then the first error may mask the second or vice versa.</p>

      <p>Also note that SQLite may ignore responses from your methods if they don't make sense. For example in
      BestIndex, if you set multiple arguments to have the same constraintargs position then your Filter won't receive
      any constraintargs at all.</p>

      <h2><a name="VFS" id="VFS">VFS</a></h2>

      <p>SQLite has new functionality named <a href="http://sqlite.org/c3ref/vfs.html">VFS</a> which defines the
      interface between the SQLite core and the underlying operating system. The majority of the functionality deals
      with files. APSW exposes this functionality letting you provide your own routines. You can also <i>inherit</i>
      from an existing vfs making it easy to augment or override specific routines. For example you could obfuscate
      your database by XORing the data implemented by augmenting the read and write methods. The method names are
      exactly the same as SQLite uses making it easier to read the SQLite documentation, trouble tickets, web searches
      or mailing lists. The SQLite convention results in names like xAccess, xCurrentTime and xWrite.</p>

      <p>You can specify which VFS to use as a parameter to the module Connection constructor</p>
      <pre>
  db=apsw.Connection("file", vfs="myvfs")
</pre>

      <h3><a name="vfsexceptions" id="vfsexceptions">Exceptions and errors</a></h3>

      <p>To return an error from any routine you should raise an exception. The exception will be translated into the
      appropriate SQLite error code for SQLite. To return a specific SQLite error code use <code><a href=
      "#exceptionfor">apsw.exceptionfor(code)</a></code>. If the exception does not map to any specific error code then
      SQLITE_ERROR (which corresponds to <code>apsw.SQLError</code>) is returned to SQLite.</p>

      <p>The SQLite code that deals with VFS errors behaves in varying ways. Some routines have no way to return an
      error (eg xDlOpen just returns zero/NULL on being unable to load a library, xSleep has no error return
      parameter), others have any error values ignored (eg <a href=
      "http://www.sqlite.org/cvstrac/tktview?tn=3394">xCurrentTime</a>) and others are unified (eg almost any error in
      xWrite will be returned to the user as disk full error). Sometimes errors are ignored as they are harmless such
      as when a journal can't be deleted after a commit (the journal is marked as obsolete before being deleted).
      Simple operations such as opening a database can result in hundreds of different VFS function calls such as hot
      journals being detected, locking, and read/writes for playback/rollback.</p>

      <p>To avoid confusion with exceptions being raised in the VFS and exceptions from normal code to open Connections
      or execute SQL queries, VFS exceptions are not raised in the normal way. (If they were, only one could be raised
      and it would obscure whatever exceptions the Connection open or SQL query execute wanted to raise.) Instead the
      <tt>excepthook</tt> member of the VFS or VFSFile is called with a tuple of exception type, exception value and
      exception traceback. The default implementation of <tt>excepthook</tt> calls <code>sys.excepthook()</code> which
      under Python 2 shows the stack trace and under Python 3 merely prints the exception value. (If
      <tt>sys.excepthook</tt> fails then PyErr_Display() is called.)</p>

      <p>In normal VFS usage there will be no exceptions raised, or specific expected ones which APSW clears after
      noting them and returning the appropriate value back to SQLite. The exception hooking behaviour helps you find
      issues in your code or unexpected behaviour of the external environment. Remember that <a href=
      "#augmentedstacktraces">augmented stack traces</a> are available which significantly increase detail about the
      exceptions.</p>

      <p>As an example, lets say you have a divide by zero error in your xWrite routine. The table below shows what
      happens with time going down and across.</p>

      <table cellspacing="5" cellpadding="5">
        <tr>
          <th>Python query code</th>

          <th>SQLite and APSW C code</th>

          <th>Python VFS code</th>
        </tr>

        <tr>
          <td>cursor.execute("update table set foo=3")</td>

          <td></td>

          <td></td>
        </tr>

        <tr>
          <td></td>

          <td>SQLite code does query</td>

          <td></td>
        </tr>

        <tr>
          <td></td>

          <td></td>

          <td>Your VFS routines are called</td>
        </tr>

        <tr>
          <td></td>

          <td></td>

          <td>xWrite divides by zero</td>
        </tr>

        <tr>
          <td></td>

          <td></td>

          <td>&nbsp;&nbsp;VFS excepthook is called with ZeroDivision exception</td>
        </tr>

        <tr>
          <td></td>

          <td>SQLITE_ERROR (closest matching SQLite error code) is returned to SQLite by APSW</td>

          <td></td>
        </tr>

        <tr>
          <td></td>

          <td>SQLite error handling and recovery operates</td>

          <td>More VFS routines are called. Any exceptions in these routines will result in VFS excepthook being called
          with them.</td>
        </tr>

        <tr>
          <td></td>

          <td>SQLite code returns SQLITE_FULL to APSW</td>

          <td></td>
        </tr>

        <tr>
          <td></td>

          <td>APSW translates into <tt>apsw.FullError</tt> exception</td>

          <td></td>
        </tr>

        <tr>
          <td><tt>apsw.FullError</tt> exception received</td>

          <td></td>

          <td></td>
        </tr>
      </table>

      <h3>OS Interface</h3>

      <p>You can get an overview in the <a href="http://sqlite.org/c3ref/vfs.html">C documentation</a>. To create a VFS
      you must inherit from <code>apsw.VFS</code>.</p>

      <dl>
        <dt><strong>VFS(name, base=None, makedefault=False, maxpathname=1024, excepthook=hookfunction)</strong>
        (Constructor)</dt>

        <dd>
          <p>Registers the VFS using <i>name</i>. If <i>base</i> is not None then this VFS will inherit from an
          existing installed VFS. To inherit from the default, pass in the empty string. If <i>makedefault</i> is True
          then this VFS will be installed as the default for all future database opens. If excepthook is provided then
          it replaces the default one used as described in <a href="#vfsexceptions">VFS exceptions</a>.</p>
        </dd>

        <dt><strong>unregister()</strong></dt>

        <dd>
          <p>Unregisters the VFS making it unavailable to future database opens. You do not need to call this as the
          VFS is automatically unregistered by when the VFS has no more references or open datatabases using it. It is
          however useful to call if you have made your VFS be the default and wish to immediately make it be
          unavailable. It is safe to call this routine multiple times.</p>
        </dd>

        <dt><strong>excepthook</strong></dt>

        <dd>
          <p>The function called when unexpected exceptions happen in the VFS.</p>
        </dd>

        <dt><strong>xOpen(name, flags)</strong></dt>

        <dd>
          <p>This method should return a new file object. <i>flags</i> is a list of two integers, with item zero being
          flags in and item one being flags out. You should modify item one as appropriate, for example setting
          SQLITE_OPEN_READONLY if you opened the file read only.</p>
        </dd>

        <dt><strong>xDelete(name, syncdir)</strong></dt>

        <dd>
          <p>Delete the named file, and if <i>syncdir</i> is true then also sync the directory afterwards.</p>
        </dd>

        <dt><strong>xAccess(name, flag)</strong></dt>

        <dd>
          <p><i>name</i> is a file or directory that SQLite wants to check access permissions for as specified by the
          <a href="http://sqlite.org/c3ref/c_access_exists.html">flag</a>. Return True or False accordingly.</p>
        </dd>

        <dt><strong>xFullPathname(name)</strong></dt>

        <dd>
          <p>Return the absolute pathname for <i>name</i>. You can use <code>os.path.abspath</code> to do this.</p>
        </dd>

        <dt><strong>xDlOpen(name)</strong></dt>

        <dd>
          <p>Load the shared library. You should return a number which will be treated as a <code>void*</code>. On
          error you should return 0 (NULL). The number is passed as is to xDlSym/xDlClose so it can represent anything
          that is convenient for you (eg index into an array). You can use ctypes to load a library.</p>
          <pre>
def xDlOpen(name):
    return ctypes.cdll.LoadLibrary(name)._handle
</pre>
        </dd>

        <dt><strong>xDlSym(ptr, name)</strong></dt>

        <dd>
          <p>Returns the address of the named function which will be treated as a <code>void*</code>. On error you
          should return 0 (NULL). You can use ctypes:</p>
          <pre>
def xDlSym(ptr, name):
    return _ctypes.dlsym (ptr, name)  # Linux/Unix/Mac etc (note leading underscore)
    return ctypes.win32.kernel32.GetProcAddress (ptr, name)  # Windows
</pre>
        </dd>

        <dt><strong>xDlClose(ptr)</strong></dt>

        <dd>
          <p>Close/Unload the shared library. Use <code>_ctypes.dlclose</code> (Linux/Unix/Mac) or
          <code>_ctypes.FreeLibrary</code> (Windows).</p>
        </dd>

        <dt><strong>xDlError()</strong> (optional)</dt>

        <dd>
          <p>Return an error string describing the last error of xDlOpen or xDlSym. If you do not supply this routine
          then a generic message is used. To implement it, catch exceptions in xDlOpen/xDlSym, turn them into strings
          and return them in this routine. Note that the message may be truncated to 255 characters - see <a href=
          "http://www.sqlite.org/cvstrac/tktview?tn=3305">ticket 3305</a>. If you have an error or return None then the
          generic message will be used.</p>
        </dd>

        <dt><strong>xRandomness(numbytes)</strong></dt>

        <dd>
          <p>This method is called once when SQLite needs to seed the random number generator. It is called on the
          default VFS only. You can return less than the number of bytes requested including None. If you return more
          then the surplus is ignored. If you are inheriting, be aware that the Unix VFS implementation has a <a href=
          "http://www.sqlite.org/cvstrac/tktview?tn=3306">bug</a> where it will claim to provide no randomness.</p>
        </dd>

        <dt><strong>xSleep(microseconds)</strong></dt>

        <dd>
          <p>Pause execution on the thread for at least the specified number of microseconds (millionths of a second).
          You should return how many microseconds you actually requested the operating system to sleep for. This
          routine is typically called from the busy handler.</p>
        </dd>

        <dt><strong>xCurrentTime()</strong></dt>

        <dd>
          <p>Return the <a href="http://en.wikipedia.org/wiki/Julian_day">Julian Day Number</a> as a floating point
          number where the integer portion is the day and the fractional part is the time. Do not adjust for timezone
          (ie use <a href="http://en.wikipedia.org/wiki/Universal_Time">UTC</a>). Although SQLite allows for an error
          return, that is <a href="http://www.sqlite.org/cvstrac/tktview?tn=3394">ignored</a>.</p>
        </dd>

        <dt><strong>xGetLastError()</strong> (optional)</dt>

        <dd>
          <p>This method is to return text describing the last error that happened in this thread. If not implemented
          SQLite's more generic message is used. However the method is never called by SQLite as of 3.6.2.</p>
        </dd>
      </dl>

      <h3>File interface</h3>

      <p>You can get an overview in the <a href="http://sqlite.org/c3ref/io_methods.html">C documentation</a>.</p>

      <dl>
        <dt><strong>VFSFile(vfs, name, flags, excepthook=hookfunction)</strong> (Inheriting constructor)</dt>

        <dd>
          <p>If you want to inherit from an existing VFS then you must subclass <code>apsw.VFSFile</code> passing in
          the parameters above. If <i>vfs</i> is an empty string then the default VFS will be used. <i>flags</i> is a
          two item list with semantics documented in <code>xOpen</code> above. If excepthook is provided then it
          replaces the default one used as described in <a href="#vfsexceptions">VFS exceptions</a>.</p>
        </dd>

        <dt><strong>excepthook</strong></dt>

        <dd>
          <p>The function called when unexpected exceptions happen in the VFS file.</p>
        </dd>

        <dt><strong>xClose()</strong></dt>

        <dd>
          <p>Close the database. Note that even if you return an error you should still close the file.</p>
        </dd>

        <dt><strong>xRead(amount, offset)</strong></dt>

        <dd>
          <p>Read the specified amount of data starting at offset. You should make every effort to read all the data
          requested, or return an error. If you have the file open for non-blocking I/O or if signals happen then it is
          possible for the underlying operating system to do a partial read. You will need to request the remaining
          data. Except for empty files SQLite considers short reads to be a fatal error. Return the data as a string
          (Python 2), bytes (Python 3) or buffer (either Python version).</p>
        </dd>

        <dt><strong>xWrite(data, offset)</strong></dt>

        <dd>
          <p>Write the data starting at offset. You must write all the data requested, or return an error. If you have
          the file open for non-blocking I/O or if signals happen then it is possible for the underlying operating
          system to do a partial write. You will need to write the remaining data. The data will be a string (Python 2)
          or bytes (Python 3).</p>
        </dd>

        <dt><strong>xTruncate(size)</strong></dt>

        <dd>
          <p>Set the file length to <code>size</code> (which may be more or less than the current length).</p>
        </dd>

        <dt><strong>xSync(flags)</strong></dt>

        <dd>
          <p>Ensure data is on the disk platters (ie could survive a power failure immediately after the call returns)
          with the <a href="http://sqlite.org/c3ref/c_sync_dataonly.html">flags</a> detailing what needs to be
          synced.</p>
        </dd>

        <dt><strong>xFileSize()</strong></dt>

        <dd>
          <p>Return the size of the file in bytes.</p>
        </dd>

        <dt><strong>xLock(level)</strong></dt>

        <dd>
          <p>Increase the lock to the level specified which is one of the <a href=
          "http://sqlite.org/c3ref/c_lock_exclusive.html"><code>SQLITE_LOCK</code></a> family of constants. If you
          can't increase the lock level because someone else has locked it, then raise
          <code>apsw.BusyException</code>.</p>
        </dd>

        <dt><strong>xUnlock(level)</strong></dt>

        <dd>
          <p>Decrease the lock to the level specified which is one of the <a href=
          "http://sqlite.org/c3ref/c_lock_exclusive.html"><code>SQLITE_LOCK</code></a> family of constants.</p>
        </dd>

        <dt><strong>xCheckReservedLock()</strong></dt>

        <dd>
          <p>Returns True if any database connection (in this or another process) has a lock other than <a href=
          "http://sqlite.org/c3ref/c_lock_exclusive.html">SQLITE_LOCK_NONE or SQLITE_LOCK_SHARED</a>.</p>
        </dd>

        <dt><strong>xFileControl(op, ptr)</strong></dt>

        <dd>
          <p>Receives a <a href="http://sqlite.org/c3ref/file_control.html">file control</a> request. See <a href=
          "#filecontrol">Connection.filecontrol</a> for an example of how to pass a Python object to this routine.</p>
        </dd>

        <dt><strong>xSectorSize()</strong> (optional)</dt>

        <dd>
          <p>Return the native underlying sector size. SQLite uses this in determining the database page size. If you
          do not implement the function or have an error then 512 (the SQLite default) is returned.</p>
        </dd>

        <dt><strong>xDeviceCharacteristics()</strong> (optional)</dt>

        <dd>
          <p>Return <a href="http://sqlite.org/c3ref/c_iocap_atomic.html">I/O capabilities</a> (bitwise or appropriate
          values). If you do not implement the function or have an error then 0 (the SQLite default) is returned.</p>
        </dd>
      </dl>

      <h1><a name="Exceptions" id="Exceptions">Exceptions</a></h1>

      <p>All exception types have <code>apsw.Error</code> as a parent. The following exceptions can happen:</p>

      <dl>
        <dt>ThreadingViolationError</dt>

        <dd>
          <p>You have used an object concurrently in two threads. For example you may try to use the same cursor in two
          different threads at the same time, or tried to close the same connection in two threads at the same
          time.</p>
        </dd>

        <dt>IncompleteExecutionError</dt>

        <dd>
          <p>You have tried to start a new SQL execute call before executing all the previous ones. See the <a href=
          "#executionmodel">execution model</a> for more details.</p>
        </dd>

        <dt>ConnectionNotClosedError</dt>

        <dd>
          <p>This exception is no longer generated.</p>
        </dd>

        <dt>ConnectionClosedError</dt>

        <dd>
          <p>You have called close() on a Connection and then continued to use it.</p>
        </dd>

        <dt>BindingsError</dt>

        <dd>
          <p>There is an incorrect number of bindings when using tuples. Or you supplied a dictionary of bindings and
          not all bindings were named in the SQL statement. For example
          <code>select&nbsp;*&nbsp;from&nbsp;foo&nbsp;where&nbsp;x=:name&nbsp;and&nbsp;y=?</code>. You should either
          use colon name style or question mark style in a query but not both.</p>

          <p><b>Note</b> It is not considered an error to have missing keys in a dictionary. For example
          <code>cursor.execute("insert into foo values($a,:b,$c)", {'a': 1})</code> is perfectly valid (note <tt>b</tt>
          and <b>c</b> are not in the dict). For missing keys, None/NULL will be used. This is so you don't have to add
          lots of spurious values to the supplied dict. If your schema requires every column have a value, then SQLite
          will generate an error due to some values being None/NULL so that case will be caught.</p>
        </dd>

        <dt>ExecutionCompleteError</dt>

        <dd>
          <p>A statement is complete but you try to run it more anyway!</p>
        </dd>

        <dt>ExecTraceAbort</dt>

        <dd>
          <p>The <a href="#executiontracer">execution tracer</a> returned False so execution was aborted.</p>
        </dd>

        <dt>ExtensionLoadingError</dt>

        <dd>
          <p>An error happened loading an <a href=
          "http://www.sqlite.org/cvstrac/wiki/wiki?p=LoadableExtensions">extension</a>.</p>
        </dd>

        <dt>VFSNotImplementedError</dt>

        <dd>
          <p>A call cannot be made to an inherited VSF method as the VFS does not implement the method.</p>
        </dd>

        <dt>VFSFileClosedError</dt>

        <dt><br />
        The VFS file is closed so the operation cannot be performed.<br />
        <br /></dt>
      </dl>
    </dd>
  </dl>

  <p>The table lists which Exception classes correspond to which <a href="http://sqlite.org/c3ref/c_abort.html">SQLite
  error codes</a>. APSW runs with <a href="http://sqlite.org/c3ref/c_ioerr_blocked.html">extended result codes</a>
  turned on. If you get the <code>result</code> member of an exception instance then you will get the plain error code.
  The <code>extendedresult</code> member of an exception instance will get you the extended error code.</p>

  <blockquote>
    <!-- This is derived from exc_descriptors in the source -->

    <table cellpadding="5" cellspacing="5" border="0">
      <tr>
        <td valign="top">
          <table cellpadding="5" cellspacing="5" border="0" width="100%">
            <tr>
              <th colspan="2">General Errors</th>
            </tr>

            <tr>
              <td><code>SQLITE_ERROR</code></td>

              <td>SQLError</td>
            </tr>

            <tr>
              <td><code>SQLITE_MISMATCH</code></td>

              <td>MismatchError</td>
            </tr>

            <tr>
              <td colspan="2">&nbsp;</td>
            </tr>

            <tr>
              <th colspan="2">Internal Errors</th>
            </tr>

            <tr>
              <td><code><i>SQLITE_INTERNAL</i></code></td>

              <td>InternalError</td>
            </tr>

            <tr>
              <td><code>SQLITE_PROTOCOL</code></td>

              <td>ProtocolError</td>
            </tr>

            <tr>
              <td><code>SQLITE_MISUSE</code></td>

              <td>MisuseError</td>
            </tr>

            <tr>
              <td><code>SQLITE_RANGE</code></td>

              <td>RangeError</td>
            </tr>

            <tr>
              <td colspan="2">&nbsp;</td>
            </tr>

            <tr>
              <th colspan="2">Permissions etc</th>
            </tr>

            <tr>
              <td><code>SQLITE_PERM</code></td>

              <td>PermissionsError</td>
            </tr>

            <tr>
              <td><code>SQLITE_READONLY</code></td>

              <td>ReadOnlyError</td>
            </tr>

            <tr>
              <td><code>SQLITE_CANTOPEN</code></td>

              <td>CantOpenError</td>
            </tr>

            <tr>
              <td><code>SQLITE_AUTH</code></td>

              <td>AuthError</td>
            </tr>
          </table>
        </td>

        <td valign="top">
          <table cellpadding="5" cellspacing="5" border="0" width="100%">
            <tr>
              <th colspan="2">Abort/Busy/etc</th>
            </tr>

            <tr>
              <td><code>SQLITE_ABORT</code></td>

              <td>AbortError</td>
            </tr>

            <tr>
              <td><code>SQLITE_BUSY</code></td>

              <td>BusyError</td>
            </tr>

            <tr>
              <td><code>SQLITE_LOCKED</code></td>

              <td>LockedError</td>
            </tr>

            <tr>
              <td><code>SQLITE_INTERRUPT</code></td>

              <td>InterruptError</td>
            </tr>

            <tr>
              <td><code>SQLITE_SCHEMA</code></td>

              <td>SchemaChangeError</td>
            </tr>

            <tr>
              <td><code>SQLITE_CONSTRAINT</code></td>

              <td>ConstraintError</td>
            </tr>

            <tr>
              <td colspan="2">&nbsp;</td>
            </tr>

            <tr>
              <th colspan="2">Memory/Disk/etc</th>
            </tr>

            <tr>
              <td><code>SQLITE_NOMEM</code></td>

              <td>NoMemError</td>
            </tr>

            <tr>
              <td><code>SQLITE_IOERR</code></td>

              <td>IOError</td>
            </tr>

            <tr>
              <td><code>SQLITE_CORRUPT</code></td>

              <td>CorruptError</td>
            </tr>

            <tr>
              <td><code>SQLITE_FULL</code></td>

              <td>FullError</td>
            </tr>

            <tr>
              <td><code>SQLITE_TOOBIG</code></td>

              <td>TooBigError</td>
            </tr>

            <tr>
              <td><code>SQLITE_NOLFS</code></td>

              <td>NoLFSError</td>
            </tr>

            <tr>
              <td><code>SQLITE_EMPTY</code></td>

              <td>EmptyError</td>
            </tr>

            <tr>
              <td><code>SQLITE_FORMAT</code></td>

              <td>FormatError</td>
            </tr>

            <tr>
              <td><code>SQLITE_NOTADB</code></td>

              <td>NotADBError</td>
            </tr>
          </table>
        </td>
      </tr>
    </table>

    <p>Codes in <i>italics</i> are no longer used by SQLite.</p>
  </blockquote>

  <h2><a name="augmentedstacktraces" id="augmentedstacktraces">Augmented stack traces</a></h2>

  <p>When an exception occurs, Python does not include frames from non-Python code (ie the C code called from Python).
  This can make it more difficult to work out what was going on when an exception occurred for example when there are
  callbacks to collations, functions or virtual tables, triggers firing etc.</p>

  <p>This is an example showing the difference between the tracebacks you would have got with earlier versions of apsw
  and the augmented traceback.</p>

  <p><b>Code</b></p>
  <pre>
import apsw

def myfunc(x):
  1/0

con=apsw.Connection(":memory:")
con.createscalarfunction("foo", myfunc)
con.createscalarfunction("fam", myfunc)
cursor=con.cursor()
cursor.execute("create table bar(x,y,z);insert into bar values(1,2,3)")
cursor.execute("select foo(1) from bar")

</pre>

  <table cellpadding="3" cellspacing="3">
    <tr>
      <th>Original traceback</th>

      <th>Augmented traceback</th>
    </tr>

    <tr>
      <td valign="top">
        <pre>
Traceback (most recent call last):
  File "t.py", line 11, in &lt;module&gt;
    cursor.execute("select foo(1) from bar")
  File "t.py", line 4, in myfunc
    1/0
ZeroDivisionError: integer division or modulo by zero
</pre>
      </td>

      <td valign="top">
        <pre>
Traceback (most recent call last):
  File "t.py", line 11, in &lt;module&gt;
    cursor.execute("select foo(1) from bar")
  File "apsw.c", line 3412, in resetcursor
  File "apsw.c", line 1597, in user-defined-scalar-FOO
  File "t.py", line 4, in myfunc
    1/0
ZeroDivisionError: integer division or modulo by zero
</pre>
      </td>
    </tr>
  </table>

  <p>In the original traceback you can't even see that code in apsw was involved. The augmented traceback shows that
  there were indeed two function calls within apsw and gives you line numbers should you need to examine the code. Also
  note how you are told that the call was in <code>user-defined-scalar-FOO</code> (all function names are
  uppercased).</p>

  <p><i>But wait, there is more!!!</i> In order to further aid troubleshooting, the augmented stack traces make
  additional information available. Each frame in the traceback has local variables defined with more information. You
  can print out the variables using <a href="http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/52215">ASPN recipe
  52215</a>.</p>

  <blockquote>
    <p>In the recipe, the initial code in <code>print_exc_plus</code> is far more complicated than need be, and also
    won't work correctly with all tracebacks (it depends on f_prev being set which isn't always the case). Change the
    function to start like this:</p>

    <blockquote>
      <pre>
    tb = sys.exc_info()[2]
    stack = []
    
    while tb:
        stack.append(tb.tb_frame)
        tb = tb.tb_next

    traceback.print_exc()
    print "Locals by frame, innermost last"

</pre>
    </blockquote>
  </blockquote>

  <p>Here is a far more complex example from some <a href="#VirtualTables">virtual tables</a> code I was writing. The
  BestIndex method in my code had returned an incorrect value. The augmented traceback includes local variables using
  recipe 52215. I can see what was passed in to my method, what I returned and which item was erroneous. The original
  traceback is almost completely useless.</p>

  <table cellpadding="3" cellspacing="3">
    <tr>
      <th>Original traceback</th>
    </tr>

    <tr>
      <td valign="top">
        <pre>
Traceback (most recent call last):
  File "tests.py", line 1387, in testVtables
    cursor.execute(allconstraints)
TypeError: Bad constraint (#2) - it should be one of None, an integer or a tuple of an integer and a boolean
</pre>
      </td>
    </tr>

    <tr>
      <th>Augmented traceback with local variables</th>
    </tr>

    <tr>
      <td valign="top">
        <pre>
Traceback (most recent call last):
  File "tests.py", line 1387, in testVtables
    cursor.execute(allconstraints)
                VTable =  __main__.VTable
                   cur =  &lt;apsw.Cursor object at 0x988f30&gt;
                     i =  10
                  self =  testVtables (__main__.APSW)
        allconstraints =  select rowid,* from foo where rowid&gt;-1000 ....

  File "apsw.c", line 4050, in Cursor_execute.sqlite3_prepare
            Connection =  &lt;apsw.Connection object at 0x978800&gt;
             statement =  select rowid,* from foo where rowid&gt;-1000 ....

  File "apsw.c", line 2681, in VirtualTable.xBestIndex
                  self =  &lt;__main__.VTable instance at 0x98d8c0&gt;
                  args =  (((-1, 4), (0, 32), (1, 8), (2, 4), (3, 64)), ((2, False),))
                result =  ([4, (3,), [2, False], [1], [0]], 997, u'\xea', False)

  File "apsw.c", line 2559, in VirtualTable.xBestIndex.result_constraint
               indices =  [4, (3,), [2, False], [1], [0]]
                  self =  &lt;__main__.VTable instance at 0x98d8c0&gt;
                result =  ([4, (3,), [2, False], [1], [0]], 997, u'\xea', False)
            constraint =  (3,)

TypeError: Bad constraint (#2) - it should be one of None, an integer or a tuple of an integer and a boolean
</pre>
      </td>
    </tr>
  </table>

  <h1><a name="Types" id="Types">Types</a></h1>

  <p>Read about <a href="http://www.sqlite.org/datatype3.html">SQLite 3 types</a>. ASPW always maintains the correct
  type for values, and never converts them to something else. Note however that SQLite may convert types based on
  column affinity as described in that link. ASPW requires that all values supplied are one of the corresponding
  Python/SQLite types (or a subclass).</p>

  <ul>
    <li>
      <p>None in Python is NULL in SQLite</p>
    </li>

    <li>
      <p>Python int or long is INTEGER in SQLite. The value represented must fit within a 64 bit signed quantity (long
      long at the C level) or an exception is generated.</p>
    </li>

    <li>
      <p>Python's float type is used for REAL in SQLite. (At the C level they are both 8 byte quantities and there is
      no loss of precision).</p>
    </li>

    <li>
      <p>Python's string or unicode is used for TEXT in SQLite. (All text returned from SQLite is unicode.)</p>
    </li>

    <li>
      <p>Python's buffer class is used for BLOB in SQLite. In Python 3 the bytes type is used, also you can still
      supply buffers.</p>
    </li>
  </ul>

  <h1><a name="Unicode" id="Unicode">Unicode</a></h1>

  <p>All SQLite strings are Unicode. The actual binary representations can be UTF8, or UTF16 in either byte order. ASPW
  uses the UTF8 interface to SQLite which results in the binary string representation in your database defaulting to
  UTF8 as well. All this is totally transparent to your Python code.</p>

  <p>Everywhere strings are used (eg as database values, SQL statements, bindings names, user defined functions) you
  can use Unicode strings. You can also use the bare Python string class, and ASPW will automatically call the unicode
  converter if any non-ascii characters are present.</p>

  <p>When returning values from SQLite, ASPW always uses the Python unicode class.</p>

  <h1><a name="threading" id="threading">Multi-threading and re-entrancy</a></h1>

  <p>ASPW lets you use SQLite in multi-threaded programs and will let other threads execute while SQLite is working.
  (Technically the <a href="http://www.python.org/doc/2.3.4/api/threads.html">GIL</a> is released when <a href=
  "http://sqlite.org/c3ref/prepare.html">sqlite3_prepare_v2</a>, <a href=
  "http://sqlite.org/c3ref/step.html">sqlite3_step</a> or <a href=
  "http://sqlite.org/c3ref/open.html">sqlite3_open_v2</a> are running, as well as many other functions that could take
  more than a trivial amount of time. The GIL is re-acquired while user defined functions, collations and the various
  hooks/handlers run.)</p>

  <p>Note that you cannot use the same cursor object in multiple threads concurrently to execute statements. APSW will
  detect this and throw an exception. It is safe to use the object serially (eg calling <code>execute</code> in one
  thread and <code>next</code> in another. You also can't do things like try to close a Connection concurrently in two
  threads.</p>

  <p>If you have multiple threads and/or multiple programs accessing the same database then there may be contention for
  the file. SQLite will return SQLITE_BUSY which will be raised as BusyError. You can call Connection.setbusytimeout to
  set how long SQLite will retry for or Connection.setbusyhandler to install your own busy handler. Note that SQLite
  won't call the busy handler or timeout if it believes a deadlock has arisen. SQLite's locking and concurrency is
  described <a href="http://www.sqlite.org/lockingv3.html">here</a></p>

  <p>A cursor object can only be executing one query at a time. You cannot issue a new query from inside a trace
  function or from a user defined function or collation since these are called while executing a query. You can however
  make new cursors and use those without issue. You may want to remember the Connection object when you set your trace
  or user defined functions.</p>

  <h1><a name="tracers" id="tracers">Tracing</a></h1>

  <p>You can install tracers on a cursor as an easy way of seeing exactly what gets executed and what is returned. The
  tracers can also abort execution and cause different values to be returned. This is very useful for diagnostics and
  testing without having to modify your main code.</p>

  <p><b>Note</b>: You cannot issue new execute statements against the cursor your tracer was called from. If you would
  like to make more queries in the tracer then do them from a new cursor object.</p>

  <h2><a name="executiontracer" id="executiontracer">Execution Tracer</a></h2>

  <p>The execution tracer is called after an SQL statement has been prepared. (ie syntax errors will have caused an
  exception during preparation so you won't see them with a tracer). It is called with two arguments. The first is a
  string which is the SQL statement about to be executed, and the second is the bindings used for that statement (and
  can be None). If the return value evaluates to False/None then execution is aborted with an ExecTraceAbort exception.
  See the <a href="#example-exectrace">example above</a>.</p>

  <h2><a name="rowtracer" id="rowtracer">Row Tracer</a></h2>

  <p>The row tracer is called before each row is returned. The arguments are the items about to be returned. Whatever
  you return from the tracer is what is actually returned. If you return None then the whole row is skipped. See the
  <a href="#example-rowtrace">example above</a>.</p>

  <h1><a name="64bitpy25">64 bit hosts, Python 2.5+</a></h1>

  <p>Prior to Python 2.5, you were still limited to 32 bit quantities for items in Python such as the length of
  strings, number of items in a sequence etc. APSW will work correctly with those items in Python 2.5 and above that
  use 64 bits. Unfortunately SQLite is limited to 32 bit quantities for strings, blobs, number of columns etc even when
  compiled for 64 bit. Consequently you will get a TooBig exception from APSW which checks if strings/buffers longer
  than 1GB or 2GB (depends on internal storage) are used. See SQLite ticket <a href=
  "http://www.sqlite.org/cvstrac/tktview?tn=2125">2125</a> and <a href=
  "http://sqlite.org/cvstrac/tktview?tn=3246">3246</a>.</p>

  <h1><a name="executionmodel" id="executionmodel">Execution model</a></h1>

  <p>This section only matters if you give multiple SQL statements in one go to <code>cursor.execute()</code>.
  (Statements are seperated by semi-colons.)</p>

  <p>SQLite does execution in two steps. First a statement is prepared, which verifies the syntax, tables and fields
  and converts the statement into an internal representation. The prepared statement is then run. Execution stops when
  a row is available, there is an error or the statement is complete.</p>

  <p>The <code>cursor.execute()</code> method automatically does the preparing and starts execution. If none of the
  statements return rows then execution will go to the end. If a row is returned then you need to call cursor.next() to
  get the row values. Execution will resume as necessary to satisfy <code>next()</code> calls.</p>

  <p>However this means that if you don't read the rows returned then the rest of your statements won't be executed.
  APSW will detect unexecuted previous statements and generate an exception. For example:</p>

  <blockquote>
    <pre>
&gt;&gt;&gt; cursor.execute("select * from foo ; create table bar(x,y,z)")
&gt;&gt;&gt; cursor.execute("create table bam(x,y,z)")
Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in ?
apsw.IncompleteExecutionError: Error: there are still remaining sql statements to execute

</pre>
  </blockquote>

  <p>Because I didn't read the results of <code>select * from foo</code> then the following create table command didn't
  have a chance to get executed. On the next execute that condition is detected and an exception raised.</p>

  <h1><a name="dbapinotes" id="dbapinotes">DBAPI notes</a></h1>

  <p>DBAPI is defined in <a href="http://www.python.org/peps/pep-0249.html">PEP 249</a>. This section desribes how APSW
  complies or differs from it.</p>

  <h2><a name="dbapimodiface" id="dbapimodiface">Module Interface</a></h2>

  <p>There is no connect method. Use the Connection constructor instead, which only takes one parameter - the name of
  the database.</p>

  <p>The Connection object and any cursors must all be used in the same thread they were allocated from. You cannot use
  them in different threads even if you protect them with mutexes.</p>

  <p>Three different paramstyles are supported. You can use qmark ('... WHERE name=?'), numeric ('... WHERE name=?4')
  and named ('... WHERE name=:name' or '... WHERE name=$name'). Note that SQLite numbers parameters from one not
  zero.</p>

  <p>The DBAPI exceptions are not used.</p>

  <h2><a name="dpapiconnectioniface" id="dpapiconnectioniface">Connection Objects</a></h2>

  <p>There are no commit or rollback methods. You should use cursor.execute("COMMIT") etc. The <a href=
  "http://www.sqlite.org/lockingv3.html">SQLite documentation</a> has more details.</p>

  <p>Several methods that are defined in DBAPI to be on the cursor are instead on the Connection object, since this is
  where SQLite actually stores the information. Doing operations in any other cursor attached to the same Connection
  object does update their values, and this makes you aware of that.</p>

  <h2><a name="dbapicursoriface" id="dbapicursoriface">Cursor Objects</a></h2>

  <p>Use getdescription() instead of description. This information is only obtained on request.</p>

  <p>There is no rowcount.</p>

  <p>callproc is not implemented as SQLite doesn't support stored procedures.</p>

  <p>execute returns the Cursor object and you can use it as an iterator to get the results (if any).</p>

  <p>executemany returns the Cursor object and you can use it as an iterator to get the results (if any).</p>

  <p>fetchone is not available. Use the cursor as an iterator, or call next() which raises StopIteration when there are
  no more results.</p>

  <p>fetchmany is not available. Call next() for however many results you want.</p>

  <p>fetchall is not available. Call next() or use a list comprehension such as <code>[row for row in
  cursor.execute("....")]</code>.</p>

  <p>nextset is not applicable or implemented.</p>

  <p>arraysize is not available as fetchmany isn't.</p>

  <p>Neither setinputsizes or setoutputsize are applicable or implemented.</p>

  <h2><a name="dpapitypes" id="dpapitypes">Type objects</a></h2>

  <p>None of the date or time methods are available since SQLite 3 does not have a native date or time type.</p>

  <p>Use the standard Python buffer class for BLOBs.</p>

  <h2><a name="dbapiextensions" id="dbapiextensions">Optional DB API Extensions</a></h2>

  <p>rownumber is not available.</p>

  <p>Exception classes are not available as attributes of Connection.</p>

  <p>Use Cursor.getconnection() to get the associated Connection object.</p>

  <p>scroll and messages are not available.</p>

  <p>The Cursor object supports the iterator protocol and this is the only way of getting information back.</p>

  <p>To get the last inserted row id, call <code>Connection.last_insert_rowid()</code>. That stores the id from the
  last insert on any Cursor associated with the the Connection. You can also add <code>select
  last_insert_rowid()</code> to the end of your execute statements.</p>

  <p>There is no errorhandler attribute.</p>

  <h1><a name="pysqlitediffs" id="pysqlitediffs">pysqlite differences</a></h1>

  <p><a href="http://pysqlite.org/">pysqlite</a> already provides a DBAPI compliant wrapper over SQLite 2 and 3. APSW
  only wraps SQLite 3. I suggest using APSW when you want to directly use SQLite and its functionality or are using
  your code to deal with database independence rather than DBAPI.</p>

  <p>APSW has the following enhancements/differences over pysqlite 2 (wrapping SQLite 3):</p>

  <ul>
    <li>APSW gives all functionality of SQLite including <a href="#VirtualTables">virtual tables</a></li>

    <li>APSW is a single file for the extension, apsw.pyd on Windows and apsw.so on Unix/Mac. There are no other files
    needed and the build instructions show you how to include SQLite statically in this file. You can put this file
    anywhere your Python session can reach. pysqlite is one binary file and several .py files, all of which need to be
    available.</li>

    <li>
      <p>*Nothing* happens behind your back. By default pysqlite tries to manage transactions by parsing your SQL for
      you, but you can turn it off. This can result in very unexpected behaviour with pysqlite.</p>
    </li>

    <li>
      <p>SQLite's Manifest typing is used, which limits values to being supplied as integer (32/64 bit), string
      (utf8/unicode), double, null/None and BLOB. (An exception happens if you don't supply values in one of the
      supported types.) APSW doesn't do any type conversion or co-ercion. Note that SQLite will under <a href=
      "http://www.sqlite.org/datatype3.html">some circumstances</a>. pysqlite does have a mechanism for <a href=
      "http://initd.org/pub/software/pysqlite/doc/usage-guide.html#using-adapters-to-store-additional-python-types-in-sqlite-databases">
      marshalling your own types</a> but you'll need to be careful if sharing the database with code in another
      language.</p>
    </li>

    <li>
      <p>APSW <b>always</b> handles Unicode correctly (this was one of the major reasons for writing it in the first
      place). pysqlite has since fixed many of its issues but you are still <a href=
      "http://initd.org/tracker/pysqlite/ticket/153">stuck with some</a>.</p>
    </li>

    <li>
      <p>You can use semi-colons at the end of commands and you can have multiple commands in the execute string in
      APSW. There are no restrictions on the type of commands used. For example this will work fine in APSW but is not
      allowed in pysqlite:</p>

      <blockquote>
        <pre>
import apsw 
con=apsw.Connection(":memory:") 
cur=con.cursor() 
for row in cur.execute("create table foo(x,y,z);insert into foo values (?,?,?);" 
                       "insert into foo values(?,?,?);select * from foo;drop table foo;" 
                       "create table bar(x,y);insert into bar values(?,?);" 
                       "insert into bar values(?,?);select * from bar;", 
                       (1,2,3,4,5,6,7,8,9,10)): 
                           print row
        

</pre>

        <p>And the output as you would expect:</p>
        <pre>
<b>$</b> python test.py 
(1, 2, 3) 
(4, 5, 6) 
(7, 8) 
(9, 10)

</pre>
      </blockquote>
    </li>

    <li>
      <p>The cursor object is an iterator and returns itself from execute. (The latest SQLite has now copied this
      feature).</p>
    </li>

    <li>
      <p><code>cursor.executemany()</code> also works with statements that return data such as selects, and you can
      have multiple statements.</p>
    </li>

    <li>pysqlite swallows exceptions in your callbacks making it far harder to debug problems. That also prevents you
    from raising exceptions in your callbacks to be handled in your code that called SQLite. pysqlite does let you turn
    on printing of tracebacks, but that is a poor substitute. apsw does the right thing as demonstrated by this
    example.

      <blockquote>
        <table border="1px" cellpadding="5" cellspacing="5">
          <tr>
            <th>pysqlite</th>

            <th>apsw</th>
          </tr>

          <tr>
            <td valign="top">
              <pre>
from pysqlite2 import dbapi2 as sqlite
def badfunc(t):
    return 1/0

con = sqlite.connect(":memory:")
con.create_function("badfunc", 1, badfunc)
cur = con.cursor()
cur.execute("select badfunc(3)")
</pre>
            </td>

            <td valign="top">
              <pre>
import apsw
def badfunc(t):
    return 1/0

con = apsw.Connection(":memory:")
con.createscalarfunction("badfunc", badfunc, 1)
cur = con.cursor()
cur.execute("select badfunc(3)")
</pre>
            </td>
          </tr>

          <tr>
            <td valign="top">
              <pre>
C:\temp&gt;python func.py
Traceback (most recent call last):
  File "func.py", line 8, in ?
    cur.execute("select badfunc(3)")
pysqlite2.dbapi2.OperationalError: user-defined function raised exception
</pre>
            </td>

            <td valign="top">
              <pre>
C:\temp&gt;python afunc.py
Traceback (most recent call last):
  File "t.py", line 8, in &lt;module&gt;
    cur.execute("select badfunc(3)")
  File "apsw.c", line 3660, in resetcursor
  File "apsw.c", line 1871, in user-defined-scalar-BADFUNC
  File "t.py", line 3, in badfunc
    return 1/0
</pre>
            </td>
          </tr>
        </table>
      </blockquote>
    </li>

    <li>APSW has enhanced debuggability. More details are available than just what is printed out when exceptions
    happen like above. See <a href="#augmentedstacktraces">augmented stack traces</a>. If you forget to close a
    Connection then you get a traceback of where the problem is (interceptable via <code>sys.excepthook</code>) and are
    also told where Connection was allocated.</li>

    <li>
      <p>You can implement tracers and other hooks in Python.</p>
    </li>

    <li>
      <p>The APSW test suite is larger and tests more functionality. Code coverage by the test suite is 95.9%. pysqlite
      is good at 81% for C code although there are several places that coverage can be improved. I haven't measured
      code coverage for pysqlite's Python code.</p>
    </li>
  </ul>

  <h1><a name="copyrightlicense" id="copyrightlicense">Copyright and License</a></h1>

  <p>Copyright (C) 2004-2008 Roger Binns <a href="mailto:rogerb@rogerbinns.com">rogerb@rogerbinns.com</a></p>

  <p>This software is provided 'as-is', without any express or implied warranty. In no event will the authors be held
  liable for any damages arising from the use of this software.</p>

  <p>Permission is granted to anyone to use this software for any purpose, including commercial applications, and to
  alter it and redistribute it freely, subject to the following restrictions:</p>

  <blockquote>
    <ol>
      <li>
        <p>The origin of this software must not be misrepresented; you must not claim that you wrote the original
        software. If you use this software in a product, an acknowledgment in the product documentation would be
        appreciated but is not required.</p>
      </li>

      <li>
        <p>Altered source versions must be plainly marked as such, and must not be misrepresented as being the original
        software.</p>
      </li>

      <li>
        <p>This notice may not be removed or altered from any source distribution.</p>
      </li>
    </ol>
  </blockquote>

  <h1><a name="verhistory" id="verhistory">Version History</a></h1>

  <h2><a name="363r1">3.6.3-r1</a></h2>

  <p>You can now write your own <a href="#VFS">VFS</a> in Python. You can also inherit from an existing VFS making it
  easy to augment or override small bits of behaviour without having to code everything else. See the <a href=
  "#example-vfs">example</a> where database files are obfuscated by XORing their contents.</p>

  <p><code>setup.py</code> now takes an optional <code>--fetch-sqlite[=ver]</code> argument to automatically download
  and use the latest SQLite amalgamation (or a specified version). On non-Windows platforms it will also work out what
  compile flags SQLite needs (for example <tt>HAVE_USLEEP, HAVE_LOCALTIME_R</tt>). Several other options to
  <code>setup.py</code> are also available to control enabling/omitting certains features and functionality. See
  <a href="#Building">building</a> for further details.</p>

  <p>APSW checks that SQLite was compiled to be <a href="http://sqlite.org/c3ref/threadsafe.html">threadsafe</a>.</p>

  <p>Added new constants:</p>

  <ul>
    <li>SQLITE_IOERR_ACCESS, SQLITE_IOERR_CHECKRESERVEDLOCK and SQLITE_IOERR_LOCK extended result codes</li>

    <li>SQLITE_OPEN_NOMUTEX and SQLITE_OPEN_FULLMUTEX open flags</li>

    <li>Several new SQLITE_CONFIG and SQLITE_STATUS codes</li>
  </ul>

  <p>Wrapped several new SQLite apis:</p>

  <ul>
    <li><a href="http://sqlite.org/c3ref/config.html">sqlite3_config</a></li>

    <li><a href="http://sqlite.org/c3ref/initialize.html">sqlite3_initialize/sqlite3_shutdown</a></li>

    <li><a href="http://sqlite.org/c3ref/memory_highwater.html">sqlite3_memory_used/sqlite3_memory_highwater</a></li>

    <li><a href="http://sqlite.org/c3ref/status.html">sqlite3_status</a></li>

    <li><a href="http://sqlite.org/c3ref/soft_heap_limit.html">sqlite3_soft_heap_limit</a></li>

    <li><a href="http://sqlite.org/c3ref/release_memory.html">sqlite3_release_memory</a></li>

    <li><a href="http://sqlite.org/c3ref/randomness.html">sqlite3_randomness</a></li>
  </ul>

  <p>The following experimental apis are not wrapped as there is nothing useful you can do with them (yet):</p>

  <ul>
    <li><a href="http://www.sqlite.org/c3ref/db_config.html">sqlite3_db_config</a></li>

    <li><a href="http://www.sqlite.org/c3ref/db_status.html">sqlite3_db_status</a></li>
  </ul>

  <p>Restored prior behaviour regarding Python ints and longs returning int for numbers fitting in signed 32 bit. This
  only affects Python 2 as Python 3 uses long exclusively. Thanks to Joe Pham for reporting this as <a href=
  "http://code.google.com/p/apsw/issues/detail?id=24">issue 24</a>.</p>

  <h2><a name="359r2">3.5.9-r2</a></h2>

  <p>APSW now works with Python 3 (you need 3.0b1 or later).</p>

  <p>(<a href="http://code.google.com/p/apsw/issues/detail?id=17">Issue 17</a>) Removed the <tt>SQLITE_MAX_*</tt>
  constants since they could be unreliable (eg APSW can't tell what a shared library was compiled with). A workaround
  is documented in the <a href="#Connection_limit">Connection.limit</a> section.</p>

  <h2><a name="359r1">3.5.9-r1</a></h2>

  <p>APSW is now hosted at <a href="http://code.google.com/p/apsw">http://code.google.com/p/apsw</a>.</p>

  <p>You can use this with SQLite 3.5.9 onwards.</p>

  <p>SQLite now provides the source all <a href="http://www.sqlite.org/cvstrac/wiki?p=TheAmalgamation">amalgamated</a>
  into one file which improves performance and makes compilation and linking of SQLite far easier. The build
  instructions are updated.</p>

  <ul>
    <li>SQLITE_COPY authorizer code and SQLITE_PROTOCOL error code are no longer used by SQLite, but the values are
    left in apsw for backwards compatibility</li>

    <li>SQLITE_IOERR_DELETE, SQLITE_IOERR_BLOCKED and SQLITE_IOERR_NOMEM added</li>

    <li>Connection.interrupt can be called from any thread</li>

    <li>SQLite has implementation limits on string and blob lengths (roughly constrained to fitting within a signed 32
    bit integer - less than 2GB) which weren't checked. Using a 64 bit Python 2.5+ (as I do) it would have been
    possible to destroy memory and crash the program. Consequently APSW has length checks to ensure it doesn't happen.
    SQLite now has further <a href="http://www.sqlite.org/limits.html">limits checking</a> which cover other things as
    well such as maximum number of virtual machine opcodes, maximum number of variables etc. These are very useful if
    you are taking in SQL statements from elsewhere. Call Connection.limit()</li>

    <li>A rename method was added for virtual tables.</li>

    <li>SQLite 3.5 removed the requirement that all operations on a connection be done in the same thread. Consequently
    all code that enforced the restriction has been removed from APSW.</li>

    <li>You no longer have to call close() for connections. This was previously a requirement to ensure that the
    correct thread was used. It is however still a good idea to do so since you can catch exceptions when close() is
    called but not if you let the destructor do the closing.</li>

    <li>SQLite now has incremental <a href="#blobio">blob I/O</a></li>

    <li><a href="http://code.google.com/p/apsw/issues/detail?id=4">Issue 4</a> which could lead to generic error
    messages was fixed in SQLite 3.5.9.</li>

    <li>Fixed <a href="http://code.google.com/p/apsw/issues/detail?id=1">Issue 1</a> error in example code for virtual
    tables which caused filename errors on Windows.</li>

    <li>Fixed <a href="http://code.google.com/p/apsw/issues/detail?id=15">Issue 15</a> releasing the GIL around calls
    to sqlite3_prepare.</li>

    <li>Fixed <a href="http://code.google.com/p/apsw/issues/detail?id=7">Issue 7</a> ensuring that extension module
    filenames are converted to utf8.</li>

    <li>Use the sqlite3_open_v2 interface which allows specifying which vfs to use. This release does not allow you to
    write your own vfs as the SQLite vfs interface is being changed for SQLite 3.6.</li>

    <li>Used new SQLite functions that keep track of when virtual tables and collations are no longer used so they can
    be released. Previously APSW also had to keep track duplicating effort.</li>

    <li>Improved test coverage a few more percent.</li>

    <li>The statement cache now defaults to the same number of entries as pysqlite (100). You can however specify more
    or less as needed.</li>

    <li>collationneeded was implemented.</li>
  </ul>

  <h2><a name="3313r1">3.3.13-r1</a></h2>

  <p>As of this release, APSW is now co-hosted with pysqlite meaning there is one site to go to for your Python SQLite
  bindings. Start at <a href="http://initd.org/tracker/pysqlite/wiki/">http://initd.org/tracker/pysqlite/wiki</a></p>

  <p>You can use this with SQLite 3.3.13 onwards. There were no API changes in SQLite 3.3.10 to 3.3.13 although some
  internal bugs were fixed and the 3.3.13 release is recommended over the earlier version.</p>

  <p>Thanks to Ed Pasma for highlighting these issues.</p>

  <ul>
    <li><tt>Connection.interrupt</tt> can be safely called from any thread.</li>

    <li>Empty statements or those consisting entirely of whitespace do not cause misuse errors (internally SQLite
    started returned NULL pointers for those statements, and sqlite3_step didn't like being passed the NULL
    pointer).</li>

    <li>Changed special handling of SQLITE_BUSY error to be the same as other errors. The special handling previously
    let you restart on receiving busy, but also hung onto statements which could result in other statements getting
    busy errors.</li>
  </ul>

  <h2><a name="3310r1">3.3.10-r1</a></h2>

  <p>You can use this with SQLite 3.3.10 onwards.</p>

  <ul>
    <li>Added a statement cache that works in conjunction with the sqlite3_prepare_v2 API. A few issues were exposed in
    SQLite and hence you must use SQLite 3.3.10 or later.</li>
  </ul>

  <h2><a name="339r1">3.3.9-r1</a></h2>

  <p>You can use this with SQLite 3.3.9 onwards.</p>

  <ul>
    <li>SQLite added <a href="http://sqlite.org/c3ref/prepare.html">sqlite3_prepare_v2</a> API. The net effect of this
    API update is that you will not get SQLITE_SCHEMA any more. SQLite will handle it internally.</li>
  </ul>

  <h2><a name="338r1">3.3.8-r1</a></h2>

  <p>You can use this with SQLite 3.3.8 onwards. There was an incompatible API change for virtual tables in SQLite
  3.3.8.</p>

  <ul>
    <li>Virtual tables updated for new api</li>

    <li>You must call close() on connections. You can also call close on cursors, but it usually isn't necessary.</li>

    <li>All strings are returned as unicode</li>

    <li>PyErr_WriteUnraisable was used for errors in destructors. Unfortunately it is almost completely useless, merely
    printing str() of the object and exception. This doesn't help in finding where in your code the issue arose so you
    could fix it. An internal APSW implementation generates a traceback and calls <code>sys.excepthook</code>, the
    default implementation of which prints the exception and the traceback to sys.stderr. <b>Note</b> the line number
    reported in the traceback is often off by 1. This is because the destructors run "between" lines of code and so the
    following line is reported as the current location.</li>

    <li>Authorizer codes SQLITE_CREATE_VTABLE, SQLITE_DROP_VTABLE and SQLITE_FUNCTION added.</li>

    <li>SQLite <a href="http://www.sqlite.org/cvstrac/wiki?p=ExtendedResultCodes">extended result codes</a> are
    available - see <a href="#Exceptions">Exceptions</a> for more detail.</li>

    <li><a href="#Module_variables">Connection hooks</a> added so you can easily register functions, virtual tables or
    similar items with each Connection as it is created.</li>

    <li>Added <a href="#Module_constants">mapping dicts</a> which makes it easy to map the various constants between
    strings and ints.</li>
  </ul>

  <h2><a name="337r1">3.3.7-r1</a></h2>

  <p><i>Never released as 3.3.8 came along</i></p>

  <p>You can use this release against SQLite 3.3.7. There were no changes in the SQLite 3.3.6 API from 3.3.5. In SQLite
  3.3.7 an API was added that allowed removing a chunk of duplicate code. Also added were <a href=
  "http://www.sqlite.org/cvstrac/wiki?p=VirtualTables">Virtual Tables</a> and loading of external modules (shared
  libraries). APSW had the following changes:</p>

  <ul>
    <li>Even more test cases added (you can't have too many tests :-)</li>

    <li>When exceptions occur, dummy frames are added to the traceback in the C code. This makes it a lot easier to
    tell why code was called if you encounter an exception. See <a href="#augmentedstacktraces">augmented stack
    traces</a> for details.</li>

    <li>String values (traditional and Unicode) work correctly if they have embedded NULL characters (ie not truncated
    at the NULL).</li>

    <li>You can load SQLite shared library extensions.</li>
  </ul>

  <h2><a name="335r1">3.3.5-r1</a></h2>

  <p>You can use this release against any release of SQLite 3 from 3.3.5 onwards. A bug was also fixed when reporting
  an error during the cleanup of an aggregate function if there had also been an error in the step function.
  (PyErr_WriteUnraisable(NULL) crashed on some versions of Python but not others.)</p>

  <p>SQLite added several functions for returning metadata about result column sets. You have to compile SQLite with
  <tt>SQLITE_ENABLE_COLUMN_METADATA</tt> to get them. This is not the default for SQLite. I don't believe these are
  generally useful except in some corner cases and so they aren't wrapped. However please shout if you do need them.
  Note that <tt>cursor.getdescription</tt> will already give you generally useful information. (Also see the <a href=
  "http://sqlite.org/pragma.html">pragmas</a>).</p>

  <p>The test code has been converted into using the unittest module. Run <tt>python tests.py -v</tt> to get the tests
  run. There should be no errors.</p>

  <p>Updated code to work correctly with new Py_ssize_t introduced in Python 2.5. See <a href="#64bitpy25">64 bit
  hosts, Python 2.5</a> for more details on how Python and SQLite handle 64 bit sized items.</p>

  <p>The following functions were added to SQLite and are wrapped. They are all functions defined on the <a href=
  "#Connection">Connection</a> object.</p>

  <ul>
    <li><a href="http://sqlite.org/capi3ref.html#sqlite3_update_hook">sqlite3_update_hook</a></li>

    <li><a href="http://sqlite.org/capi3ref.html#sqlite3_rollback_hook">sqlite3_rollback_hook</a></li>

    <li><a href="http://sqlite.org/capi3ref.html#sqlite3_enable_shared_cache">sqlite3_enable_shared_cache</a> (Module
    level method)</li>

    <li><a href="http://sqlite.org/capi3ref.html#sqlite3_get_autocommit">sqlite3_get_autocommit</a> (Connection level
    method)</li>

    <li>sqlite3_profile (experimental, not documented on SQLite site) This callback is run at the end of each statement
    execution telling you how long it took)</li>
  </ul>

  <p>The following functions were added/changed in SQLite C API but are not useful to be wrapped.</p>

  <ul>
    <li>sqlite3_value_numeric_type (query if a result is numeric)</li>

    <li><a href="http://sqlite.org/capi3ref.html#sqlite3_global_recover">sqlite3_global_recover</a> (already
    deprecated)</li>

    <li><a href="http://sqlite.org/capi3ref.html#sqlite3_release_memory">sqlite3_release_memory</a> (requires
    non-default compile flag)</li>

    <li><a href="http://sqlite.org/capi3ref.html#sqlite3_soft_heap_limit">sqlite3_soft_heap_limit</a> (requires
    non-default compile flag)</li>

    <li><a href="http://sqlite.org/capi3ref.html#sqlite3_db_handle">sqlite3_db_handle</a> (use
    cursor.getconnection())</li>
  </ul>

  <h2><a name="327r1">3.2.7-r1</a></h2>

  <p>You can use this release against any release of SQLite 3.</p>

  <p>SQLite 3.2.7 has several bug fixes. The undocumented experimental function <code>sqlite3_profile</code> was added,
  but it not present in apsw yet.</p>

  <ul>
    <li>The author of pysqlite has improved it considerably since APSW was originally written. The differences section
    has been updated to reflect those improvements in pysqlite.</li>

    <li>SQLITE_INTERNAL and SQLITE_NOTFOUND error codes are not used according to 3.2.7 header file. They are still
    present in APSW for backwards compatibility.</li>

    <li>Changed the build instructions so configure is run on non-Windows platforms.</li>

    <li>Fixed a bug caused by an overly helpful error message trying to tell you how many bindings you supplied that
    crashed if you didn't supply any.</li>

    <li>Changed when an error in the step function for an aggregate is reported due to limitations in SQLite.</li>
  </ul>

  <h2><a name="322r1">3.2.2-r1</a></h2>

  <p>You can use this release against any release of SQLite 3.</p>

  <p>SQLite 3.2.2 API removed <code>sqlite3_global_recover</code>. That function was not wrapped in APSW. Note that
  SQLite 3.2.2 contains a bug fix that applies when you use 64 bit integer primary keys (32 bit ints are fine).</p>

  <h2><a name="321r1">3.2.1-r1</a></h2>

  <p>You can use this release against any release of SQLite 3.</p>

  <ul>
    <li>There are no changes in APSW except to correct an error in the example code (collations are registered against
    the connection not the cursor)</li>
  </ul>

  <p>SQLite 3.2.1 had one addition in the stable C API, which was a new function named
  <code>sqlite3_global_recover</code>. That function is not applicable for wrapping in APSW.</p>

  <h2><a name="313r1">3.1.3-r1</a></h2>

  <p>You can use this release against any release of SQLite 3.</p>

  <ul>
    <li>The text string returned by apsw.Error used to say "apsw.APSWException" and has been changed to "apsw.Error".
    This is purely cosmetic and helps make clear what the class is. (The old string was what the original class name
    was in an earlier version of the code.)</li>

    <li>Added <code>SQLITE_ALTER_TABLE</code> and <code>SQLITE_REINDEX</code> constants for the authorizer function.
    (These constants were introduced in SQLite 3.1.3).</li>

    <li>Changed various C++-isms into standard C (eg // comments and the placing of some CHECK_THREAD macro calls)</li>

    <li>Added module level function <code>apswversion</code> which returns the version of APSW.</li>
  </ul>

  <p>SQLite 3.1.3 had no changes in the stable C API other than what is mentioned above. There were some new
  experimental functions added which are not currently documented on the SQLite website, which are not wrapped by APSW.
  Please contact me if you believe they will remain in SQLite and you would like them wrapped:</p>

  <ul>
    <li><code>sqlite3_sleep</code> An alternative function which sleeps for a specified number of milliseconds can be
    provided. By default SQLite just uses the standard operating system call.</li>

    <li><code>sqlite3_expired</code> This function is internal to statement execution. It would apply to the
    implementation of Cursor.executemany and could in theory provide a marginal improvement in performance.</li>

    <li>A global variable <code>sqlite3_temp_directory</code> can be used before any databases are opened to set where
    temporary files are created. By default SQLite just uses the standard operating system mechanisms.</li>
  </ul>

  <h2><a name="308r3">3.0.8-r3</a></h2>

  <p>There are no functional changes. The only changes were to correct some variable names in the example code (they
  were cut and pasted from the test code which used different names) and to make the source zip file extract its
  contents into a sub-directory which is the more typical way of packaging that sort of thing.</p>

  <h2><a name="308r2">3.0.8-r2</a></h2>

  <p>All remaining functionality in the C API for SQLite 3.0.8 is now available.</p>

  <p>Finished this documentation.</p>

  <h2><a name="308r1">3.0.8-r1</a></h2>

  <p>Initial release</p>
  <hr />
</body>
</html>
