<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta name="generator" content="HTML Tidy for Linux (vers 6 November 2007), see www.w3.org" />

  <title>APSW - Another Python SQLite Wrapper</title>
  <style type="text/css">
/*<![CDATA[*/
  body { 
  font-family: verdana, arial, helvetica, sans-serif;
  margin: 20px;
  background-color: #ffcc99;
  padding: 7px;
  }
  .pynumber    { color: #0080C0;}
  .pyoperator  { color: #0000C0;}
  .pystring    { color: #004080;}
  .pycomment   { color: #008000;}
  .pyname      { color: #000000;}
  .pyerror     { color: #FF8080;}
  .pykeyword   { color: #C00000;}
  .pytext      { color: #000000;}
  .pyoutput    { color: #0000FF;}

  }
  /*]]>*/
  </style>
</head>

<body>
  <h1 class="notoc">APSW - Another Python SQLite Wrapper</h1>

  <p><font size="-1">apsw-3.6.3-r1 10th October 2008</font> (Use with SQLite 3.6.2 or later, Python 2.3 or later
  including Python 3)</p>

  <p>APSW provides an SQLite 3 wrapper that provides the thinnest layer over <a href="http://www.sqlite.org">SQLite
  3</a> possible. Everything you can do from the <a href="http://www.sqlite.org/c3ref/intro.html">C API</a> to SQLite
  3, you can do from Python. Although APSW looks vaguely similar to the <a href=
  "http://www.python.org/peps/pep-0249.html">DBAPI</a>, it is <a href="#dbapinotes">not compliant</a> with that API and
  instead works the way SQLite 3 does. (<a href="http://www.pysqlite.org">pysqlite</a> is DBAPI compliant - <a href=
  "#pysqlitediffs">differences between apsw and pysqlite 2</a>).</p>

  <h1 class="notoc">Table of contents</h1>

  <table cellspacing="5" cellpadding="5" summary="Table of contents">
    <tr>
      <td valign="top">
        <!--toc-->

        <ul>
          <li>
            <a href="#Download">Download</a>

            <ul>
              <li><a href="#Source">Source and binaries</a></li>

              <li><a href="#Sourcecode">Source code control</a></li>
            </ul>
          </li>

          <li><a href="#SQLiteVersionCompatibilityAndBenchmarking">SQLite version compatibility and
          benchmarking</a></li>

          <li><a href="#Example">Example</a></li>

          <li>
            <a href="#Building">Building</a>

            <ul>
              <li><a href="#Finding">Finding SQLite 3</a></li>

              <li><a href="#Recommended">Recommended</a></li>

              <li><a href="#testing">Testing</a></li>
            </ul>
          </li>

          <li>
            <a href="#APIReference">API Reference</a>

            <ul>
              <li><a href="#module-methods">Module methods</a></li>

              <li><a href="#Module_variables">Module variables</a></li>

              <li><a href="#Module_constants">Module constants</a></li>

              <li><a href="#Connection_class">Connection class</a></li>

              <li><a href="#blobio">Blob I/O</a></li>

              <li><a href="#Cursor">Cursor class</a></li>

              <li><a href="#VirtualTables">Virtual Tables</a></li>

              <li><a href="#VFS">VFS</a></li>
            </ul>
          </li>

          <li>
            <a href="#Exceptions">Exceptions</a>

            <ul>
              <li><a href="#augmentedstacktraces">Augmented stack traces</a></li>
            </ul>
          </li>

          <li><a href="#Types">Types</a></li>

          <li><a href="#Unicode">Unicode</a></li>

          <li><a href="#threading">Multi-threading and re-entrancy</a></li>

          <li>
            <a href="#tracers">Tracing</a>

            <ul>
              <li><a href="#executiontracer">Execution Tracer</a></li>

              <li><a href="#rowtracer">Row Tracer</a></li>
            </ul>
          </li>

          <li><a href="#x64bitpy25">64 bit hosts, Python 2.5+</a></li>

          <li><a href="#executionmodel">Execution model</a></li>
        </ul>
      </td>

      <td valign="top">
        <ul>
          <li>
            <a href="#dbapinotes">DBAPI notes</a>

            <ul>
              <li><a href="#dbapimodiface">Module Interface</a></li>

              <li><a href="#dpapiconnectioniface">Connection Objects</a></li>

              <li><a href="#dbapicursoriface">Cursor Objects</a></li>

              <li><a href="#dpapitypes">Type objects</a></li>

              <li><a href="#dbapiextensions">Optional DB API Extensions</a></li>
            </ul>
          </li>

          <li><a href="#pysqlitediffs">pysqlite differences</a></li>

          <li><a href="#copyrightlicense">Copyright and License</a></li>

          <li>
            <a href="#verhistory">Version History</a>

            <ul>
              <li><a href="#v363r1">3.6.3-r1</a></li>

              <li><a href="#v359r2">3.5.9-r2</a></li>

              <li><a href="#v359r1">3.5.9-r1</a></li>

              <li><a href="#v3313r1">3.3.13-r1</a></li>

              <li><a href="#v3310r1">3.3.10-r1</a></li>

              <li><a href="#v339r1">3.3.9-r1</a></li>

              <li><a href="#v338r1">3.3.8-r1</a></li>

              <li><a href="#v337r1">3.3.7-r1</a></li>

              <li><a href="#v335r1">3.3.5-r1</a></li>

              <li><a href="#v327r1">3.2.7-r1</a></li>

              <li><a href="#v322r1">3.2.2-r1</a></li>

              <li><a href="#v321r1">3.2.1-r1</a></li>

              <li><a href="#v313r1">3.1.3-r1</a></li>

              <li><a href="#v308r3">3.0.8-r3</a></li>

              <li><a href="#v308r2">3.0.8-r2</a></li>

              <li><a href="#v308r1">3.0.8-r1</a></li>
            </ul>
          </li>
        </ul><!--endtoc-->
      </td>
    </tr>
  </table>



  <h1><a name="APIReference" id="APIReference">API Reference</a></h1>

  <p>Everything you can do from the <a href="http://www.sqlite.org/c3ref/intro.html">SQLite 3 C API</a> you can do from
  Python. The documentation below notes which C API functions are called where you can get further details on what
  happens. The only functionality not implemented is <a href="http://www.sqlite.org/c3ref/vfs.html">VFS</a> because it
  is being changed for SQLite 3.6. Additionally <a href="http://sqlite.org/c3ref/profile.html">sqlite3_trace</a> is not
  wrapped but instead <a href="#tracers">tracers</a> are provided that have more functionality.</p>

  <p>Some functions are marked experimental in the SQLite API. These have also been made available, but as the SQLite
  documentation notes these functions may change form or disappear in future versions of SQLite. You can exclude these
  functions by commenting out the relevant line in the <code>setup.py</code> when building aspw.</p>

  <p>Various methods create functions, collations and set various hooks and handlers. To remove the relevant
  function/collation/hook/handler, pass in None as the callable method.</p>

  <h2><a name="module-methods" id="module-methods">Module methods</a></h2>

  <dl>
    <dt><strong>sqlitelibversion()</strong></dt>

    <dd>
      <p>Returns the version of the SQLite library as a string. This function calls <a href=
      "http://sqlite.org/c3ref/libversion.html">sqlite3_libversion</a>.</p>
    </dd>

    <dt><strong>apswversion()</strong></dt>

    <dd>
      <p>Returns the version of the APSW module.</p>
    </dd>

    <dt><strong>enablesharedcache(boolean)</strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/enable_shared_cache.html">sqlite3_enable_shared_cache</a>. This sets
      the <a href="http://www.sqlite.org/sharedcache.html">shared cache mode</a> which was introduced in SQLite
      3.3.</p>
    </dd>

    <dt><strong>createmodule("modulename", module_object)</strong></dt>

    <dd>
      <p>Registers a virtual table. See <a href="#VirtualTables">virtual tables</a> for more details.</p>
    </dd>

    <dt><strong>initialize()</strong> &amp; <strong>shutdown</strong></dt>

    <dd>
      <p>Calls the <a href="http://sqlite.org/c3ref/initialize.html">sqlite3_initialize/sqlite3_shutdown</a> functions.
      There is no need to manually call these functions. Note that it is a really bad idea to call shutdown unless you
      are absolutely sure all connections and cursors have been closed, deleted and garbage collected.</p>
    </dd>

    <dt><strong>randomness(bytes)</strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/randomness.html">sqlite3_randomness</a> to obtain <i>bytes</i> of
      random data.</p>
    </dd>

    <dt><strong>config(op [,args])</strong></dt>

    <dd>
      <p>Calls the <a href="http://sqlite.org/c3ref/config.html">sqlite3_config</a> function. Only the options
      SQLITE_CONFIG_SINGLETHREAD, SQLITE_CONFIG_MULTITHREAD, SQLITE_CONFIG_SERIALIZED and SQLITE_CONFIG_MEMSTATUS are
      supported.</p>
    </dd>

    <dt><strong>memoryused()</strong></dt>

    <dd>
      <p>Returns the amount of memory SQLite is currently using by calling <a href=
      "http://sqlite.org/c3ref/memory_highwater.html">sqlite3_memory_used</a>.</p>
    </dd>

    <dt><strong>memoryhighwater(reset=False)</strong></dt>

    <dd>
      <p>Returns the most amount of memory SQLite has used by calling <a href=
      "http://sqlite.org/c3ref/memory_highwater.html">sqlite3_memory_highwater</a>. If <code>reset</code> is not False
      then the counter is reset.</p>
    </dd>

    <dt><strong>softheaplimit(bytes)</strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/soft_heap_limit.html">sqlite3_soft_heap_limit</a> requesting a soft
      upper bounds on the amount of memory SQLite uses.</p>
    </dd>

    <dt><strong>releasememory(bytes)</strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/release_memory.html">sqlite3_release_memory</a> requesting SQLite free
      up to <i>bytes</i> bytes of memory. Returns how much was actually freed.</p>
    </dd>

    <dt><strong>status(op, reset=False)</strong></dt>

    <dd>
      <p>Returns a tuple of current and highwater values for various SQLite counters by calling <a href=
      "http://sqlite.org/c3ref/status.html">sqlite3_status</a>. If <code>reset</code> is not False then the highwater
      is reset to the current value.</p>
    </dd>

    <dt><a name="exceptionfor" id="exceptionfor"><strong>exceptionfor(code)</strong></a></dt>

    <dd>
      <p>Returns an exception instance corresponding to a SQLite error code, in particular intended for mapping
      <a href="http://www.sqlite.org/cvstrac/wiki?p=ExtendedResultCodes">extended result codes</a> to <a href=
      "#Exceptions">exceptions</a>. In addition to picking the right exception class, it also sets the
      <tt>extendedresult</tt> attribute on the instance. This function is useful for returning specific errors in your
      VFS implementation. An example usage is:</p>

      <blockquote>
        <pre>
 raise apsw.exceptionfor(SQLITE_IOERR_SHORT_READ)
</pre>
      </blockquote>
    </dd>

    <dt><strong>vfsnames()</strong></dt>

    <dd>
      <p>Returns a list of the names of the installed vfs modules, with the default being first. You can use this to
      confirm that your vfs is installed. It is also useful if you want to install your vfs as the default and need the
      name of the previous default to inherit from.</p>
    </dd>
  </dl>

  <h2><a name="Module_variables" id="Module_variables">Module variables</a></h2>

  <dl>
    <dt><strong>connection_hooks</strong></dt>

    <dd>
      <p>The purpose of the hooks is to allow the easy registration of functions, virtual tables or similar items with
      each Connection as it is created. The default value is an empty list. Whenever a Connection is created, each item
      in <code>apsw.connection_hooks</code> is invoked with a single parameter being the new Connection object. If the
      hook raises an exception then the creation of the Connection fails.</p>
    </dd>
  </dl>

  <h2><a name="Module_constants" id="Module_constants">Module constants</a></h2>

  <p>Note that the same values can be used in different contexts. For example SQLITE_OK and SQLITE_CREATE_INDEX both
  have a value of zero. For each group of constants there is also a mapping (dict) available that you can supply a
  string to and get the corresponding numeric value, or supply a numeric value and get the corresponding string. These
  can help improve diagnostics/logging, calling other modules etc. For example</p>

  <blockquote>
    <pre>
apsw.mapping_authorizer_function["SQLITE_READ"]=20
apsw.mapping_authorizer_function[20]="SQLITE_READ"

</pre>
  </blockquote>

  <dl>
    <dt><strong>SQLITE_VERSION_NUMBER</strong></dt>

    <dd>
      <p>This is the version of the SQLite library from the header file <tt>sqlite3.h</tt> at apsw compile time. It is
      expressed as an integer (eg 3003010 for SQLite 3.3.10).</p>
    </dd>

    <dt><strong><a href="http://sqlite.org/c3ref/c_deny.html">SQLITE_OK, SQLITE_DENY, SQLITE_IGNORE</a></strong></dt>

    <dd>
      <p>These values are returned from authorizer functions. Mapping is
      <code>apsw.mapping_authorizer_return</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_alter_table.html"><strong>SQLITE_CREATE_INDEX, SQLITE_CREATE_TABLE</strong>
    and 30 others</a></dt>

    <dd>
      <p>The values are passed to authorizer functions. You can see a complete list in the <a href=
      "http://sqlite.org/c3ref/set_authorizer.html">sqlite3_set_authorizer documentation</a>. Mapping is
      <code>apsw.mapping_authorizer_function</code></p>
    </dd>

    <dt><strong>SQLITE_INDEX_CONSTRAINT_EQ, SQLITE_INDEX_CONSTRAINT_GT</strong> and 4 others</dt>

    <dd>
      <p>These values are passed to the BestIndex method of <a href="#VirtualTables">virtual tables</a>. Mapping is
      <code>apsw.mapping_bestindex_constraints</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_ioerr_blocked.html"><strong>SQLITE_IOERR_READ, SQLITE_IOERR_FSYNC</strong>
    and 7 others</a></dt>

    <dd>
      <p>These are <a href="http://sqlite.org/c3ref/c_ioerr_blocked.html">extended result codes</a> which are provided
      in <a href="#Exceptions">exceptions</a>. Mapping is <code>apsw.mapping_extended_result_codes</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_abort.html"><strong>SQLITE_OK, SQLITE_ERROR, SQLITE_PERM</strong> and 22
    others</a></dt>

    <dd>
      <p>These are <a href="http://sqlite.org/c3ref/c_abort.html">SQLite result codes</a> which are provided in
      <a href="#Exceptions">exceptions</a>. Mapping is <code>apsw.mapping_result_codes</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_open_create.html"><strong>SQLITE_OPEN_READONLY, SQLITE_OPEN_CREATE</strong>
    and 10 others</a></dt>

    <dd>
      <p>These are used for <a href="http://sqlite.org/c3ref/open.html">opening the database</a> as well as the VFS.
      Mapping is <code>apsw.mapping_open_flags</code></p>
    </dd>

    <dt><a href="http://www.sqlite.org/c3ref/c_limit_attached.html"><strong>SQLITE_LIMIT_LENGTH,
    SQLITE_LIMIT_SQL_LENGTH</strong> and 8 others</a>. Mapping is <code>apsw.mapping_limits</code></dt>

    <dd>
      <p>These are used for getting or setting <a href="http://www.sqlite.org/c3ref/limit.html">run-time limits</a></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_config_getmalloc.html"><strong>SQLITE_CONFIG_SINGLETHREAD,
    SQLITE_CONFIG_MULTITHREAD</strong> and 9 others</a></dt>

    <dd>
      <p>These are used with <a href="http://sqlite.org/c3ref/config.html">sqlite3_config</a>. Mapping is
      <code>apsw.mapping_config</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_status_malloc_size.html"><strong>SQLITE_STATUS_MEMORY_USED,
    SQLITE_STATUS_PAGECACHE_USED</strong> and 4 others</a></dt>

    <dd>
      <p>These are used with <a href="http://sqlite.org/c3ref/status.html">sqlite3_status</a>. Mapping is
      <code>apsw.mapping_status</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_lock_exclusive.html"><strong>SQLITE_LOCK_NONE, SQLITE_LOCK_SHARED</strong>
    and 3 others</a></dt>

    <dd>
      <p>These are used with the <a href="http://sqlite.org/c3ref/io_methods.html">xLock/xUnlock</a> VFS file methods.
      Mapping is <code>apsw.mapping_locking_level</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_iocap_atomic.html"><strong>SQLITE_IOCAP_ATOMIC, SQLITE_IOCAP_ATOMIC512,
    SQLITE_IOCAP_ATOMIC1K</strong> and 8 others</a></dt>

    <dd>
      <p>These are used with the <a href="http://sqlite.org/c3ref/io_methods.html">xDeviceCharacteristics</a> VFS file
      method. Mapping is <code>apsw.mapping_device_characteristics</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_sync_dataonly.html"><strong>SQLITE_SYNC_NORMAL, SQLITE_SYNC_FULL</strong>
    and 1 other</a></dt>

    <dd>
      <p>These are used with the <a href="http://sqlite.org/c3ref/io_methods.html">xSync</a> VFS file method. Mapping
      is <code>apsw.mapping_sync</code></p>
    </dd>

    <dt><a href="http://sqlite.org/c3ref/c_access_exists.html"><strong>SQLITE_ACCESS_EXISTS, SQLITE_ACCESS_READWRITE,
    SQLITE_ACCESS_READ</strong></a></dt>

    <dd>
      <p>These are used with the xAccess <a href="http://sqlite.org/c3ref/vfs.html">VFS method</a>. Mapping is
      <code>apsw.mapping_access</code>.</p>
    </dd>
  </dl>

  <h2><a name="Connection_class" id="Connection_class">Connection class</a></h2>

  <p>The connection class wraps a <code>sqlite3 pointer</code>.</p>

  <dl>
    <dt><strong>Connection(filename, flags=SQLITE_OPEN_READWRITE|SQLITE_OPEN_CREATE, vfs=None,
    statementcachesize=100)</strong></dt>

    <dd>
      <p>Opens an SQLite database named <code>filename</code>. (This calls <a href=
      "http://sqlite.org/c3ref/open.html">sqlite3_open_v2</a> behind the scenes.) If you don't supply a vfs then the
      default will be used. You can also set how many entries there are in the statement cache. You will generally want
      this to be the total number of distinct SQL statements you execute frequently.</p>
    </dd>

    <dt><strong>close(force=False)</strong></dt>

    <dd>
      <p>You must call this method when you are done with a Connection. Behind the scenes it calls <a href=
      "http://sqlite.org/c3ref/close.html">sqlite3_close</a>. It is ok to call this method multiple times. Note that
      this method can raise an exception. Some examples of when exceptions are raised:</p>

      <ul>
        <li>You have statements still executing (ie currently positioned at a row, with more statements to execute).
        Statements that have consumed all results will not hold up closing a Connection.</li>

        <li>You were in the middle of a transaction. SQLite will attempt to do a rollback and errors in your rollback
        hook will be passed back.</li>

        <li>Any virtual tables will be dropped/disconnected. Errors in your Disconnect/Destroy methods will be passed
        back.</li>
      </ul>

      <p>If <tt>force</tt> is True, then any executing cursors are forcibly closed.</p>
    </dd>

    <dt><strong>cursor()</strong></dt>

    <dd>
      <p>Creates a new <a href="#Cursor">cursor</a> object on this database.</p>
    </dd>

    <dt><strong>changes()</strong></dt>

    <dd>
      <p>This function returns the number of database rows that were changed (or inserted or deleted) by the most
      recently completed INSERT, UPDATE, or DELETE statement. (This calls <a href=
      "http://sqlite.org/c3ref/changes.html">sqlite3_changes</a>. Read that link for some additional notes.)</p>
    </dd>

    <dt><strong>totalchanges()</strong></dt>

    <dd>
      <p>This function returns the total number of database rows that have be modified, inserted, or deleted since the
      database connection was opened. (This calls <a href=
      "http://sqlite.org/c3ref/total_changes.html">sqlite3_total_changes</a>. Read that link for some additional
      notes.)</p>
    </dd>

    <dt><strong>last_insert_rowid()</strong></dt>

    <dd>
      <p>Returns the integer key of the most recent insert in the database. (This calls <a href=
      "http://sqlite.org/c3ref/last_insert_rowid.html">sqlite3_last_insert_rowid</a>.)</p>
    </dd>

    <dt><strong>complete(statement)</strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/complete.html">sqlite3_complete</a> which tells you if the input string
      comprises one or more complete SQL statements.</p>
    </dd>

    <dt><strong>setbusytimeout(milliseconds)</strong></dt>

    <dd>
      <p>Sets the busy timeout. (This calls <a href=
      "http://sqlite.org/c3ref/busy_timeout.html">sqlite3_busy_timeout</a>).</p>
    </dd>

    <dt><strong>setbusyhandler(callable)</strong></dt>

    <dd>
      <p>Sets the busy handler to callable. callable will be called with one integer argument which is the number of
      prior calls to the busy callback for the same lock. If the busy callback returns something that evaluates to
      False, then SQLite returns SQLITE_BUSY to the calling code.. If the callback returns something that evaluates to
      True, then SQLite tries to open the table again and the cycle repeats. (This calls <a href=
      "http://sqlite.org/c3ref/busy_handler.html">sqlite3_busy_handler</a>).</p>
    </dd>

    <dt><strong>interrupt()</strong></dt>

    <dd>
      <p>Causes any pending operations on the database to abort at the earliest opportunity. You can call this from any
      thread. (This calls <a href="http://sqlite.org/c3ref/interrupt.html">sqlite3_interrupt</a>).</p>
    </dd>

    <dt><a name="Connection_limit" id="Connection_limit"><strong>limit(id [, newval])</strong></a></dt>

    <dd>
      <p>If called with one parameter then the relevant limit is returned. If called with two then the limit is
      changed. Returns the old value of the limit. This calls <a href=
      "http://www.sqlite.org/c3ref/limit.html">sqlite3_limit</a>. For example
      <code>connection.limit(apsw.SQLITE_LIMIT_LENGTH, 1024)</code> would set the limit for blobs and strings to 1
      kilobyte. To find the maximum value, set the limit to 0x7fffffff and then call <tt>connection.limit</tt> again to
      see what value it was set to.</p>
    </dd>

    <dt><strong>createscalarfunction(name, callable, numargs=-1)</strong></dt>

    <dd>
      <p>Registers a scalar function. The callable will be called. You can specify how many arguments your function
      takes as the numargs parameter or supply -1 to take any amount. (This calls <a href=
      "http://sqlite.org/c3ref/create_function.html">sqlite3_create_function</a>).</p>
    </dd>

    <dt><strong>createaggregatefunction(name, factorycallback, numargs=-1)</strong></dt>

    <dd>
      <p>Registers an aggregate function. (This calls <a href=
      "http://sqlite.org/c3ref/create_function.html">sqlite3_create_function</a>.) You can specify how many arguments
      your function takes as the numargs parameter or supply -1 to take any amount. When the function is called by an
      SQL query, the factorycallback is called without any arguments. The factorycallback needs to return a tuple
      consisting of three 3 items.</p>

      <ul>
        <li>
          <p>a context object (of any type)</p>
        </li>

        <li>
          <p>a step function which is called for each row. The context object will be the first parameter, and the
          remaining parameters will be from the SQL statement. The return value is ignored - you supply it in
          final.</p>
        </li>

        <li>
          <p>a final function which is called at the end. The only parameter will be the context object. The value
          returned is set as the return for the function. It must be a valid SQLite type. Note that the final function
          is always called even if an exception was raised by the step function. This allows you to ensure any
          resources are cleaned up.</p>
        </li>
      </ul>
    </dd>

    <dt><strong>createcollation(name, callable)</strong></dt>

    <dd>
      <p>Creates a collation with the specified name and callable. The callable will be passed two string arguments. It
      should return -1 if the first is less than the second, 0 if they are equal and 1 and if the first is greater than
      the second. Note that this controls sorting (ORDER BY in SQL) so your comparisons don't affect other SQL
      operations. Read more about <a href="http://www.sqlite.org/datatype3.html#collation">SQLite's handling of
      collations.</a> (This calls <a href=
      "http://sqlite.org/c3ref/create_collation.html">sqlite3_create_collation</a>.) If there is an error in your
      Python code then 0 (ie items are equal) is returned.</p>
    </dd>

    <dt><strong>collationneeded(callable)</strong></dt>

    <dd>
      <p><tt>callable</tt> will be called if a statement requires a collation that hasn't been registered. Your
      callable will be passed two parameters. The first is the connection object. The second is the name of the
      collation. If you have the collation code available then call createcollation, else just return.</p>
    </dd>

    <dt><strong>setauthorizer(callable)</strong></dt>

    <dd>
      <p>The callable is invoked while SQL statements are being prepared. The intent is to allow applications to safely
      execute user entered SQL. The callable is called with 5 parameters:</p>

      <ul>
        <li>
          <p>an integer representing the operation (the constants are available on the apsw module - eg
          <code>apsw.SQLITE_CREATE_TABLE</code>.</p>
        </li>

        <li>
          <p>A string (or None) dependent on the operation</p>
        </li>

        <li>
          <p>Another string (or None) dependent on the operation</p>
        </li>

        <li>
          <p>The string name of the database (or None)</p>
        </li>

        <li>
          <p>Name of the innermost trigger or view doing the access (or None)</p>
        </li>
      </ul>

      <p>You should return <code>apsw.SQLITE_OK</code> to allow the operation or <code>apsw.SQLITE_DENY</code> or
      <code>apsw.SQLITE_IGNORE</code> as applicable. (SQLITE_DENY is returned if there is an error in your Python
      code).</p>

      <p>This calls <a href="http://sqlite.org/c3ref/set_authorizer.html">sqlite3_set_authorizer</a> which contains
      more detailed documentation.</p>
    </dd>

    <dt><strong>setupdatehook(callable)</strong></dt>

    <dd>
      <p>Sets a callable which is invoked during data changing. The callable takes four parameters:</p>

      <ul>
        <li>An integer whose value is one of apsw.SQLITE_INSERT, apsw.SQLITE_DELETE or apsw.SQLITE_UPDATE</li>

        <li>A string naming the database on which the operation is happening. (This will typically be <tt>main</tt>
        unless you used <a href="http://sqlite.org/lang_attach.html"><tt>ATTACH</tt></a></li>

        <li>A string naming the table on which the operation is happening.</li>

        <li>An integer with the rowid of the row that is changing.</li>
      </ul>

      <p>(This calls <a href="http://sqlite.org/c3ref/update_hook.html">sqlite3_update_hook</a>.)</p>
    </dd>

    <dt><strong>setrollbackhook(callable)</strong></dt>

    <dd>
      <p>Sets a callable which is invoked during a rollback. The callable takes no parameters and the return value is
      ignored. (This calls <a href="http://sqlite.org/c3ref/commit_hook.html">sqlite3_rollback_hook</a>.)</p>
    </dd>

    <dt><strong>setcommithook(callable)</strong> (SQLite 3 experimental feature)</dt>

    <dd>
      <p>Sets a callable which is invoked just before a commit. It should return zero for the commit to go ahead and
      non-zero for it to be turned into a rollback. In the case of an exception in your callable, a non-zero (ie
      rollback) value is returned. (This calls <a href=
      "http://sqlite.org/c3ref/commit_hook.html">sqlite3_commit_hook</a>.)</p>
    </dd>

    <dt><strong>setprofile(callable)</strong> (SQLite 3 experimental feature)</dt>

    <dd>
      <p>Sets a callable which is invoked at the end of execution of each statement and passed the statement string and
      how long it took to execute. (The execution time appears to be in nanoseconds.) Note that it is called only on
      completion. If for example you do a <tt>SELECT</tt> and only read the first result, then you won't reach the end
      of the statement.</p>

      <p>(This calls <tt>sqlite3_profile</tt> which is not documented on the SQLite web site. See the
      <tt>sqlite3.h</tt> header file for documentation.).</p>
    </dd>

    <dt><strong>setprogresshandler(callable, nsteps=20)</strong> (SQLite 3 experimental feature)</dt>

    <dd>
      <p>Sets a callable which is invoked every <i>nsteps</i> SQLite inststructions. The callable should return a
      non-zero value to abort or zero to continue. (If there is an error in your Python callable then non-zero will be
      returned). (This calls <a href="http://sqlite.org/c3ref/progress_handler.html">sqlite3_progress_handler</a> which
      has more detailed documentation).</p>
    </dd>

    <dt><strong>enableloadextension(bool)</strong> (SQLite 3 experimental feature)</dt>

    <dd>
      <p>Enables <a href="http://www.sqlite.org/cvstrac/wiki/wiki?p=LoadableExtensions">extension</a> loading which is
      disabled by default. Calls sqlite3_enable_load_extension. See note below about enabling extension loading.</p>
    </dd>

    <dt><strong>loadextension(filename, entrypoint=None)</strong> (SQLite 3 experimental feature)</dt>

    <dd>
      <p>Loads an <a href="http://www.sqlite.org/cvstrac/wiki/wiki?p=LoadableExtensions">extension</a> by calling
      sqlite3_load_extension. If you don't specify the entrypoint then SQLite uses a default of
      sqlite3_extension_init.</p>

      <p>Note that if you build SQLite on Unix then extension loading won't be built into SQLite by default. The
      details are in SQLite ticket <a href="http://www.sqlite.org/cvstrac/tktview?tn=2082">2082</a>. You need to edit
      <tt>setup.py</tt> if you enable extension loading.</p>
    </dd>

    <dt><strong><a name="filecontrol" id="filecontrol">filecontrol(op, pointer)</a></strong></dt>

    <dd>
      <p>Calls <a href="http://sqlite.org/c3ref/file_control.html">sqlite3_file_control</a>. <i>op</i> should be a
      number with values below 100 reserved by SQLite. This is an example if how to pass a Python object using <a href=
      "http://docs.python.org/lib/module-ctypes.html">ctypes</a>.</p>
      <pre>
obj={"foo": 1, 2: 3}                 # object we want to pass
objwrap=ctypes.py_object(obj)        # objwrap must live before and after the call else
                                     # it gets garbage collected
connection.filecontrol(
         123,                        # our op code
         ctypes.addressof(objwrap))  # get pointer
</pre>

      <p>In your VFS file implementation, you turn the pointer back into a Python object like this:</p>
      <pre>
def xFileControl(self, op, pointer):
    if op==123:                      # our op code
        obj=ctypes.py_object.from_address(pointer).value
        # play with obj - you can use id() to verify it is the same
        print obj["foo"]
        obj["result"]="it worked"
    else:
        raise Exception("Unknown file control "+`op`)
</pre>
    </dd>

    <dt><strong>sqlite3pointer()</strong></dt>

    <dd>
      <p>Returns the underlying <a href="http://sqlite.org/c3ref/sqlite3.html">sqlite3</a> pointer for the connection.
      This method is useful if there are other C level libraries in the same process and you want them to use the APSW
      connection handle. The value is returned as a number using <a href=
      "http://docs.python.org/c-api/long.html?highlight=pylong_fromvoidptr#PyLong_FromVoidPtr">PyLong_FromVoidPtr</a>
      under the hood. You should also ensure that you hang on to the Connection object for as long as the other
      libraries are using the handle or increment the reference count on it. It is also a very good idea to call
      <tt>apsw.sqlitelibversion()</tt> and ensure it is the same as the other libraries.</p>
    </dd>

    <dt><strong>blobopen(databasename, tablename, columnname, rowid, flags)</strong></dt>

    <dd>
      <p>Returns a new <a href="#blobio">blob</a>. The database name will be <tt>main</tt>, unless you want to refer to
      a database you <a href="http://www.sqlite.org/lang_attach.html">ATTACH</a>ed.</p>
    </dd>
  </dl>

  <h2><a name="blobio" id="blobio">Blob I/O</a></h2>

  <p>Historically SQLite only let you access and create blobs in their entirity. For example to reading or writing a
  single byte from a blob required reading or writing the whole blob.</p>

  <p>SQLite now provides incremental blob access, with APSW exposing it as a file like object. Call Connection.blobopen
  to open a blob. <b>Note</b> that the underlying <a href="http://www.sqlite.org/c3ref/blob.html">SQLite blob apis</a>
  require offsets to be provided to each call, but the APSW blob object tracks that for you.</p>

  <dl>
    <dt><strong>close(force=False)</strong></dt>

    <dd>
      <p>Stops any further access to the blob. You should proactively call close as it will return errors that may
      correspond to earlier blob i/o. See <a href="http://www.sqlite.org/c3ref/blob_close.html">blob_close()</a> for
      more details. If you call any of the other methods on a closed blob then you will get a ValueError exception
      (this is the same as calling methods on a closed Python file object).</p>

      <p><i>force</i> currently has no effect and is present for compatibility with cursor objects.</p>
    </dd>

    <dt><strong>read([amount])</strong></dt>

    <dd>Reads amount of data requested, or till end of file, whichever is earlier. Attempting to read beyond the end of
    the blob returns the empty string, in the same manner as end of file on normal file objects.</dd>

    <dt><strong>write(data)</strong></dt>

    <dd>Writes the requested data. Note that you cannot make the blob larger or smaller. Normally you would create a
    zeroblob and then come back and fill it in with this method, as shown in the <a href=
    "#example-blobio">example</a>.</dd>

    <dt><strong>tell()</strong></dt>

    <dd>Returns the current position.</dd>

    <dt><strong>seek(offset, [whence])</strong></dt>

    <dd>Change the current position. If whence is omitted or zero, then the position is set to offset. If whence is 1
    then offset is added to the current position. If whence is 2 then offset is relative to the end of the blob.</dd>
  </dl>

  <h2><a name="Cursor" id="Cursor">Cursor class</a></h2>

  <p>The Cursor class creates and executes SQLite prepared statements.</p>

  <dl>
    <dt><strong>Cursor()</strong></dt>

    <dd>
      <p>You cannot create cursors directly. The are created by calling Connection.cursor().</p>
    </dd>

    <dt><strong>close(force=False)</strong></dt>

    <dd>
      <p>In general cursors are in a closed state, and you won't need to call this method. Calling while the cursor is
      already closed or if the Connection is closed will not result in errors. An open Cursor prevents closing of
      Connections. The circumstances in which they are not closed include:</p>

      <ul>
        <li>You haven't requested all the rows of available data (calling next() or using the cursor as an iterator
        will return more data)</li>

        <li>You got a recoverable error and can try again (eg SQLITE_BUDY)</li>

        <li>If force is False then you will get exceptions if there is remaining work to do be in the Cursor such as
        more statements to execute, more data from the executemany binding sequence etc. If force is True then all
        remaining work and state information will be discarded.</li>
      </ul>
    </dd>

    <dt><strong>getconnection()</strong></dt>

    <dd>
      <p>Returns the <a href="#Connection">Connection</a> object to which this cursor belongs.</p>
    </dd>

    <dt><strong>execute(statements, bindings=())</strong></dt>

    <dd>
      <p>Executes the statements using the supplied bindings. The bindings can be supplied as a tuple or as a dict.
      Execution returns when the first row is available or all statements have completed. The cursor object is returned
      which you can use as an iterator. (See <a href="#executionmodel">execution model</a> for more details. This
      function wraps <a href="http://sqlite.org/c3ref/prepare.html">sqlite3_prepare_v2</a> and <a href=
      "http://sqlite.org/c3ref/step.html">sqlite3_step</a>.)</p>
    </dd>

    <dt><strong>executemany(statements, sequenceofbindings=())</strong></dt>

    <dd>
      <p>Repeatedly executes statements using each element of sequenceofbindings for the bindings each time. Execution
      returns when the first row is available or all statements have completed. The cursor object is returned which you
      can use as an iterator. (See <a href="#executionmodel">execution model</a> for more details. This function runs
      in a loop on each member of sequenceofbindings and wraps <a href=
      "http://sqlite.org/c3ref/prepare.html">sqlite3_prepare_v2</a> and <a href=
      "http://sqlite.org/c3ref/step.html">sqlite3_step</a>.)</p>
    </dd>

    <dt><strong>next()</strong></dt>

    <dd>
      <p>The Cursor object is an iterator, and so you can use it in a for loop or similar situations. You can also
      explicitly call the <code>next()</code> method. This method returns a tuple of the contents of a returned row or
      raises StopIteration after all returned rows have been seen.</p>
    </dd>

    <dt><strong>getdescription()</strong></dt>

    <dd>
      <p>Returns a list describing each column in the current result set. Each item is a tuple of (column name,
      declared column type). You should only call this function while data is being returned such as when
      <code>next()</code> returns a row. This function calls <a href=
      "http://sqlite.org/c3ref/column_name.html">sqlite3_column_name</a> and <a href=
      "http://sqlite.org/c3ref/column_decltype.html">sqlite3_column_decltype</a>.</p>
    </dd>

    <dt><strong>setexectrace(callable)</strong><br />
    <strong>setrowtrace(callable)</strong><br />
    <strong>getexectrace()</strong><br />
    <strong>getrowtrace()</strong></dt>

    <dd>
      <p>Sets or gets the <a href="#tracers">tracers</a>.</p>
    </dd>
  </dl>

  <h2><a name="VirtualTables" id="VirtualTables">Virtual Tables</a></h2>

  <p><a href="http://www.sqlite.org/cvstrac/wiki?p=VirtualTables">Virtual Tables</a> are an experimental feature
  introduced in SQLite 3.3.7. They let a developer provide underlying table implementations, while still presenting a
  normal SQL interface to the user. The person writing SQL doesn't need to know or care that some of the tables come
  from elsewhere.</p>

  <p>Some examples of how you might use this:</p>

  <ul>
    <li>Translating to/from information stored in other formats (eg a csv/ini format file)</li>

    <li>Accessing the data remotely (eg you could make a table that backends into <a href=
    "http://www.josephson.org/projects/pyamazon/">Amazon's API</a></li>

    <li>Dynamic information (eg currently running processes, files and directories, objects in your program)</li>

    <li>Information that needs reformatting (eg if you have complex rules about how to convert strings to/from Unicode
    in the dataset)</li>

    <li>Information that isn't relationally correct (eg if you have data that has ended up with duplicate "unique" keys
    with code that dynamically corrects it)</li>

    <li>There are other examples on the <a href="http://www.sqlite.org/cvstrac/wiki?p=VirtualTables">SQLite
    page</a></li>
  </ul>

  <p>You need to have 3 types of object. A module, a virtual table and a cursor. These are documented below. You can
  also read the <a href="http://www.sqlite.org/cvstrac/wiki?p=VirtualTableMethods">SQLite C method documentation</a>.
  At the C, they are just one set of methods. At the Python/apsw level, they are split over the 3 types of object. The
  leading <tt><i>x</i></tt> is ommitted in Python. You can return SQLite error codes (eg <code>SQLITE_READONLY</code>)
  by raising the appropriate exceptions (eg <code>apsw.ReadOnlyError</code>).</p>

  <h3>Module</h3>

  <p>The module is used to create the virtual tables. Once you have a module object, you register it with a connection
  by calling <code>Connection.createmodule("modulename", module_object)</code>. To create the table, you use SQL:
  <code>CREATE <b>VIRTUAL</b> TABLE tablename USING modulename<i>(arg0, arg1, ...)</i></code></p>

  <dl>
    <dt><strong>Create(connection, modulename, databasename, tablename, *args)</strong></dt>

    <dd>
      <p>This is called when a table is first created on a connection. The optional args are passed from the SQL CREATE
      statement.</p>

      <p><b>Return</b> two items. The first item should be a string with SQL specifying the schema for the table. The
      second item is an Object that implements the table methods. Later methods in the Table and Cursor objects will
      reference the columns by number, starting at zero with column -1 being the rowid. Every row must have a unique
      unchanging integer rowid up to 64bit signed integer.</p>
    </dd>

    <dt><strong>Connect(connection, modulename, databasename, tablename, *args)</strong></dt>

    <dd>
      <p>Similar to Create, except it is called to establish a new connection to an existing table. The paramaters and
      return are the same. In general Create is called the first time a table is accessed and is where you are expect
      to do heavy initialisation work. Connect can take that initialized work and reuse it.</p>
    </dd>
  </dl>

  <h3>Table</h3>

  <p>The table contains knowledge of the indices, makes cursors and can perform transactions.</p>

  <dl>
    <dt><strong>Begin() Sync() Commit() Rollback()</strong> (optional)</dt>

    <dd>
      <p>These functions are used as part of transactions. At the time of writing they are undocumented in SQLite (see
      <a href=
      "http://www.sqlite.org/cvstrac/wiki?p=VirtualTableMethods">www.sqlite.org/cvstrac/wiki?p=VirtualTableMethods</a>.
      They do not take any arguments nor return anything. You do not have to provide these methods.</p>
    </dd>

    <dt><strong>Disconnect()</strong> (optional)<br />
    <strong>Destroy()</strong></dt>

    <dd>
      <p>These methods are the opposite of <code>Connect</code> and <code>Create</code> in the module implementation.
      They can be considered destructors for the virtual table instance. It is currently unclear how SQLite behaves if
      you return an error (<a href="http://www.sqlite.org/cvstrac/tktview?tn=2099">ticket 2099</a>). Note that SQLite
      does ignore errors in the Disconnect method. If you do have one, you will get an exception from the
      <code>close()</code> method, but the database will actually be closed.</p>
    </dd>

    <dt><strong>Open()</strong></dt>

    <dd>
      <p>Returns a new cursor object.</p>
    </dd>

    <dt><strong>Rename(newname)</strong> (optional)</dt>

    <dd>
      <p>Notification that the table will be given a new name. If you return without raising an exception, then SQLite
      renames the table (you don't have to do anything). If you raise an exception then the renaming is prevented.</p>
    </dd>

    <dt><strong>FindFunction(nfuncargs, funcname)</strong> <i>not implemented yet</i></dt>

    <dd>
      <p>Lets you provide an alternate function implementation for the table. This is currently not implemented in apsw
      because of incomplete information in SQLite to make it safe (<a href=
      "http://www.sqlite.org/cvstrac/tktview?tn=2095">ticket 2095</a>).</p>
    </dd>

    <dt><strong>UpdateDeleteRow(rowid)</strong></dt>

    <dd>
      <p>Requests deletion of the row with the specified id.</p>

      <p><b>Return</b> None (ignored)</p>
    </dd>

    <dt><strong>UpdateInsertRow(rowid, fields)</strong></dt>

    <dd>
      <p>Create a new row. fields is a tuple the same size as the number of columns in your table containing a value
      for each column. rowid is the rowid to give the row. If rowid is None then you must make up a rowid you want.</p>

      <p><b>Return</b> the new rowid (if rowid was None), else ignored</p>
    </dd>

    <dt><strong>UpdateChangeRow(rowid, newrowid, fields)</strong></dt>

    <dd>
      <p>Change an existing row of the table with the values in fields. fields is a tuple the same size as the number
      of columns in your table containing a value for each column. If newrowid is not the same as rowid then you also
      have to change the rowid (this would happen for a query like <code>UPDATE table SET rowid=rowid+100 WHERE
      ...</code>)</p>

      <p><b>Return</b> None (ignored)</p>
    </dd>

    <dt><strong>BestIndex(constraints, orderbys)</strong></dt>

    <dd>
      <blockquote>
        This is a complex method and even has its <a href=
        "http://www.sqlite.org/cvstrac/wiki?p=VirtualTableBestIndexMethod">own page</a> in the SQLite documentation. To
        get going initially, just return <code>None</code> and you will be fine. Implementing this method reduces the
        number of rows scanned in your table to satisfy queries, but only if you have an index or index like mechanism
        available.

        <p><b>Note</b> The implementation of this method differs slightly from the <a href=
        "http://www.sqlite.org/cvstrac/wiki?p=VirtualTableBestIndexMethod">SQLite documentation</a> for the C API. You
        are not passed "unusable" constraints. The argv/constraintarg positions are not off by one. In the C api, you
        have to return position 1 to get something passed to Filter in position 0. With the APSW implementation, you
        return position 0 to get Filter arg 0, position 1 to get Filter arg 1 etc.</p>
      </blockquote>

      <p>The purpose of this method is to ask if you have the ability to determine if a row meets certain constraints
      that doesn't involve visiting every row. An example constraint is <code>price&nbsp;&gt;&nbsp;74.99</code>. In a
      traditional SQL database, queries with constraints can be speeded up <a href=
      "http://www.sqlite.org/lang_createindex.html">with indices</a>. If you return None, then SQLite will visit every
      row in your table and evaluate the constraint itself. Your index choice returned from BestIndex will also be
      passed to the Filter method on your cursor object. Note that SQLite may call this method multiple times trying to
      find the most efficient way of answering a query. You will be passed the contraints as a sequence of tuples
      containing two items. The first item is the column number and the second item is the operation.</p>

      <blockquote>
        Example query: <code>select * from foo where price&gt;74.99 and quantity&lt;=10 and customer=="Acme
        Widgets"</code>.

        <p>If customer is column 0, price column 2 and quantity column 5, then constraints will be:</p>
        <pre>
   (2, apsw.SQLITE_INDEX_CONSTRAINT_GT),
   (5, apsw.SQLITE_INDEX_CONSTRAINT_LE),
   (0, apsw.SQLITE_INDEX_CONSTRAINT_EQ)

</pre>

        <p>Note that you do not get the value of the constraint (eg "Acme Widgets", 74.99 and 10 in this example).</p>
      </blockquote>

      <p>The first item you return is None if you don't have an appropriate index for any of the constraints and SQLite
      should iterate over every row. If you do have a suitable index then you return as the first item a sequence the
      same length as constraints with the members mapping to the constraints in order. Each item can be one of None, an
      integer or a tuple of an integer and a boolean.</p>

      <dl>
        <dt>None</dt>

        <dd>This means you have no index for that constraint. SQLite will have to iterate over every row for it.</dd>

        <dt>integer</dt>

        <dd>This is the argument number for the constraintargs being passed into the Filter function of your cursor
        (the values "Acme Widgets", 74.99 and 10 in the example).</dd>

        <dt>(integer, boolean)</dt>

        <dd>By default SQLite will check what you return. For example if you said that you had an index on price,
        SQLite will still check that each row you returned is greater than 74.99. If you set the boolean to False then
        SQLite won't do that double checking.</dd>
      </dl>

      <blockquote>
        Example query: <code>select * from foo where price&gt;74.99 and quantity&le;10 and customer=="Acme
        Widgets"</code>.

        <p>Customer is column 0, price column 2 and quantity column 5. You can index on customer equality and
        price.</p>

        <table border="1" cellspacing="5" cellpadding="5" summary="BestIndex example">
          <tr>
            <th>Constraints (in)</th>

            <th>Constraints used (out)</th>
          </tr>

          <tr>
            <td valign="top">
              <pre>
   (2, apsw.SQLITE_INDEX_CONSTRAINT_GT),
   (5, apsw.SQLITE_INDEX_CONSTRAINT_LE),
   (0, apsw.SQLITE_INDEX_CONSTRAINT_EQ)
</pre>
            </td>

            <td valign="top">
              <pre>
   1,
   None,
   0
</pre>
            </td>
          </tr>
        </table>
      </blockquote>

      <p>When your Filter method in the cursor is called, constraintarg[0] will be "Acme Widgets" (customer constraint
      value) and constraintarg[1] will be 74.99 (price constraint value). You can also return an index number (integer)
      and index string to use (SQLite attaches no significance to these values - they are passed as is to your
      Cursor.Filter method as a way for the BestIndex method to let the Cursor.Filter method know which of your indices
      or similar mechanism to use.</p>

      <p>The second argument to BestIndex is a sequence of orderbys because the query requested the results in a
      <a href="http://sqlite.org/lang_select.html">certain order</a>. If your data is already in that order then SQLite
      can give the results back as is. If not, then SQLite will have to sort the results first.</p>

      <blockquote>
        Example query: <code>select * from foo order by price desc, quantity asc</code>

        <p>Price is column 2, quantity column 5 so orderbys will be:</p>
        <pre>
  (2, True),  <font color="blue"># True means descending, False is ascending</font>
  (5, False)

</pre>
        <pre>


</pre>
      </blockquote>

      <p><b>Return</b> You should return up to 5 items. Items not present in the return have a default value.</p>

      <dl>
        <dt>0: constraints used (default None)</dt>

        <dd>This must either be None or a sequence the same length as constraints passed in. Each item should be as
        specified above saying if that constraint is used, and if so which constraintarg to make the value be in your
        Cursor.Filter function.</dd>

        <dt>1: index number (default zero)</dt>

        <dd>This value is passed as is to Cursor.Filter</dd>

        <dt>2: index string (default None)</dt>

        <dd>This value is passed as is to Cursor.Filter</dd>

        <dt>3: orderby consumed (default False)</dt>

        <dd>Return True if your output will be in exactly the same order as the orderbys passed in</dd>

        <dt>4: estimated cost (default a huge number)</dt>

        <dd>Approximately how many disk operations are needed to provide the results. SQLite uses the cost to optimise
        queries. For example if the query includes <code>A or B</code> and A has 2,000 operations and B has 100 then it
        is best to evaluate B before A.</dd>
      </dl>

      <blockquote>
        A complete example. Query is <code>select * from foo where price&gt;74.99 and quantity&lt;=10 and
        customer=="Acme Widgets" order by price desc, quantity asc</code>

        <p>Customer is column 0, price column 2 and quantity column 5. You can index on customer equality and
        price.</p>
        <pre>
<b>BestIndex</b>(constraints, orderbys)
 
<b>constraints</b>= ( (2, apsw.SQLITE_INDEX_CONSTRAINT_GT), 
                  (5, apsw.SQLITE_INDEX_CONSTRAINT_LE), 
                  (0, apsw.SQLITE_INDEX_CONSTRAINT_EQ)  )

<b>orderbys</b>= ( (2, True), (5, False) )

</pre>

        <p>You return</p>
        <pre>
( (1, None, 0),   <font color="blue"># constraints used</font>
  27,             <font color="blue"># index number</font>
  "idx_pr_cust",  <font color="blue"># index name</font>
  False,          <font color="blue"># results are not in orderbys order</font>
  1000            <font color="blue"># about 1000 disk operations to access index</font>
)

</pre>

        <p>Your Cursor.Filter method will be called with:</p>
        <pre>
27,              <font color="blue"># index number you returned</font>
"idx_pr_cust",   <font color="blue"># index name you returned</font>
"Acme Widgets",  <font color="blue"># constraintarg[0] - customer</font>  
74.99            <font color="blue"># constraintarg[1] - price </font>

</pre>
      </blockquote>

      <h3>Cursor</h3>

      <p>Cursors are created by the Open method in the table object. They iterate over rows returning desired
      values.</p>

      <dl>
        <dt><strong>Close()</strong></dt>

        <dd>
          <p>This is the destructor for the cursor. Note that you must cleanup. The method will not be called again if
          you raise an exception.</p>

          <p><b>Return</b> None (ignored)</p>
        </dd>

        <dt><strong>Filter(indexnum, indexstring, constraintargs)</strong></dt>

        <dd>
          <p>This method is always called first to initialize an iteration to the first row of the table. The arguments
          come from the BestIndex method in the table object with constraintargs being a tuple of the constraints you
          requested. If you always return None in BestIndex then indexnum will be zero, indexstring will be None and
          constraintargs will be empty).</p>

          <p><b>Return</b> None (ignored)</p>
        </dd>

        <dt><strong>Eof()</strong></dt>

        <dd>
          <p>Called to ask if we are at the end of the table. It is called after each call to Filter and Next.</p>

          <p><b>Return</b> True if the cursor is at a valid row of data, else False. Note that if you have an exception
          in this method, or do not provide it then False will be returned to SQLite.</p>
        </dd>

        <dt><strong>Next()</strong></dt>

        <dd>
          <p>Advance to the next row in the table.</p>

          <p><b>Return</b> None (ignored)</p>
        </dd>

        <dt><strong>Rowid()</strong></dt>

        <dd>
          <p><b>Return</b> the current rowid. This should be an integer up to 64 bits signed.</p>
        </dd>

        <dt><strong>Column(number)</strong></dt>

        <dd>
          <p>Requests the value of the specified column number. Column numbering starts at zero with -1 being the
          rowid.</p>

          <p><b>Return</b> the value in that column. It must be compatible with SQLite types (ie one of None, integer,
          float, string or buffer (blob))</p>
        </dd>
      </dl>

      <h3>Troubleshooting virtual tables</h3>

      <p>Virtual Tables are a recent addition to SQLite and haven't been widely used yet. They do work well if all your
      routines work perfectly.</p>

      <p>A big help is using the local variables recipe as described in <a href="#augmentedstacktraces">augmented stack
      traces</a> which will give you more details in errors. You may also find errors compounding. For example if you
      have an error in the Filter method of a cursor, SQLite then closes the cursor. If you also return an error in the
      Close method then the first error may mask the second or vice versa.</p>

      <p>Also note that SQLite may ignore responses from your methods if they don't make sense. For example in
      BestIndex, if you set multiple arguments to have the same constraintargs position then your Filter won't receive
      any constraintargs at all.</p>

      <h2><a name="VFS" id="VFS">VFS</a></h2>

      <p>SQLite has new functionality named <a href="http://sqlite.org/c3ref/vfs.html">VFS</a> which defines the
      interface between the SQLite core and the underlying operating system. The majority of the functionality deals
      with files. APSW exposes this functionality letting you provide your own routines. You can also <i>inherit</i>
      from an existing vfs making it easy to augment or override specific routines. For example you could obfuscate
      your database by XORing the data implemented by augmenting the read and write methods. The method names are
      exactly the same as SQLite uses making it easier to read the SQLite documentation, trouble tickets, web searches
      or mailing lists. The SQLite convention results in names like xAccess, xCurrentTime and xWrite.</p>

      <p>You can specify which VFS to use as a parameter to the module Connection constructor</p>
      <pre>
  db=apsw.Connection("file", vfs="myvfs")
</pre>

      <h3><a name="vfsexceptions" id="vfsexceptions">Exceptions and errors</a></h3>

      <p>To return an error from any routine you should raise an exception. The exception will be translated into the
      appropriate SQLite error code for SQLite. To return a specific SQLite error code use <code><a href=
      "#exceptionfor">apsw.exceptionfor(code)</a></code>. If the exception does not map to any specific error code then
      SQLITE_ERROR (which corresponds to <code>apsw.SQLError</code>) is returned to SQLite.</p>

      <p>The SQLite code that deals with VFS errors behaves in varying ways. Some routines have no way to return an
      error (eg xDlOpen just returns zero/NULL on being unable to load a library, xSleep has no error return
      parameter), others have any error values ignored (eg <a href=
      "http://www.sqlite.org/cvstrac/tktview?tn=3394">xCurrentTime</a>) and others are unified (eg almost any error in
      xWrite will be returned to the user as disk full error). Sometimes errors are ignored as they are harmless such
      as when a journal can't be deleted after a commit (the journal is marked as obsolete before being deleted).
      Simple operations such as opening a database can result in hundreds of different VFS function calls such as hot
      journals being detected, locking, and read/writes for playback/rollback.</p>

      <p>To avoid confusion with exceptions being raised in the VFS and exceptions from normal code to open Connections
      or execute SQL queries, VFS exceptions are not raised in the normal way. (If they were, only one could be raised
      and it would obscure whatever exceptions the Connection open or SQL query execute wanted to raise.) Instead the
      <tt>excepthook</tt> member of the VFS or VFSFile is called with a tuple of exception type, exception value and
      exception traceback. The default implementation of <tt>excepthook</tt> calls <code>sys.excepthook()</code> which
      under Python 2 shows the stack trace and under Python 3 merely prints the exception value. (If
      <tt>sys.excepthook</tt> fails then PyErr_Display() is called.)</p>

      <p>In normal VFS usage there will be no exceptions raised, or specific expected ones which APSW clears after
      noting them and returning the appropriate value back to SQLite. The exception hooking behaviour helps you find
      issues in your code or unexpected behaviour of the external environment. Remember that <a href=
      "#augmentedstacktraces">augmented stack traces</a> are available which significantly increase detail about the
      exceptions.</p>

      <p>As an example, lets say you have a divide by zero error in your xWrite routine. The table below shows what
      happens with time going down and across.</p>

      <table cellspacing="5" cellpadding="5" summary="Exceptions example">
        <tr>
          <th>Python query code</th>

          <th>SQLite and APSW C code</th>

          <th>Python VFS code</th>
        </tr>

        <tr>
          <td>cursor.execute("update table set foo=3")</td>

          <td></td>

          <td></td>
        </tr>

        <tr>
          <td></td>

          <td>SQLite code does query</td>

          <td></td>
        </tr>

        <tr>
          <td></td>

          <td></td>

          <td>Your VFS routines are called</td>
        </tr>

        <tr>
          <td></td>

          <td></td>

          <td>xWrite divides by zero</td>
        </tr>

        <tr>
          <td></td>

          <td></td>

          <td>&nbsp;&nbsp;VFS excepthook is called with ZeroDivision exception</td>
        </tr>

        <tr>
          <td></td>

          <td>SQLITE_ERROR (closest matching SQLite error code) is returned to SQLite by APSW</td>

          <td></td>
        </tr>

        <tr>
          <td></td>

          <td>SQLite error handling and recovery operates</td>

          <td>More VFS routines are called. Any exceptions in these routines will result in VFS excepthook being called
          with them.</td>
        </tr>

        <tr>
          <td></td>

          <td>SQLite code returns SQLITE_FULL to APSW</td>

          <td></td>
        </tr>

        <tr>
          <td></td>

          <td>APSW translates into <tt>apsw.FullError</tt> exception</td>

          <td></td>
        </tr>

        <tr>
          <td><tt>apsw.FullError</tt> exception received</td>

          <td></td>

          <td></td>
        </tr>
      </table>

      <h3>OS Interface</h3>

      <p>You can get an overview in the <a href="http://sqlite.org/c3ref/vfs.html">C documentation</a>. To create a VFS
      you must inherit from <code>apsw.VFS</code>.</p>

      <dl>
        <dt><strong>VFS(name, base=None, makedefault=False, maxpathname=1024, excepthook=hookfunction)</strong>
        (Constructor)</dt>

        <dd>
          <p>Registers the VFS using <i>name</i>. If <i>base</i> is not None then this VFS will inherit from an
          existing installed VFS. To inherit from the default, pass in the empty string. If <i>makedefault</i> is True
          then this VFS will be installed as the default for all future database opens. If excepthook is provided then
          it replaces the default one used as described in <a href="#vfsexceptions">VFS exceptions</a>.</p>
        </dd>

        <dt><strong>unregister()</strong></dt>

        <dd>
          <p>Unregisters the VFS making it unavailable to future database opens. You do not need to call this as the
          VFS is automatically unregistered by when the VFS has no more references or open datatabases using it. It is
          however useful to call if you have made your VFS be the default and wish to immediately make it be
          unavailable. It is safe to call this routine multiple times.</p>
        </dd>

        <dt><strong>excepthook</strong></dt>

        <dd>
          <p>The function called when unexpected exceptions happen in the VFS.</p>
        </dd>

        <dt><strong>xOpen(name, flags)</strong></dt>

        <dd>
          <p>This method should return a new file object. <i>flags</i> is a list of two integers, with item zero being
          flags in and item one being flags out. You should modify item one as appropriate, for example setting
          SQLITE_OPEN_READONLY if you opened the file read only.</p>
        </dd>

        <dt><strong>xDelete(name, syncdir)</strong></dt>

        <dd>
          <p>Delete the named file, and if <i>syncdir</i> is true then also sync the directory afterwards.</p>
        </dd>

        <dt><strong>xAccess(name, flag)</strong></dt>

        <dd>
          <p><i>name</i> is a file or directory that SQLite wants to check access permissions for as specified by the
          <a href="http://sqlite.org/c3ref/c_access_exists.html">flag</a>. Return True or False accordingly.</p>
        </dd>

        <dt><strong>xFullPathname(name)</strong></dt>

        <dd>
          <p>Return the absolute pathname for <i>name</i>. You can use <code>os.path.abspath</code> to do this.</p>
        </dd>

        <dt><strong>xDlOpen(name)</strong></dt>

        <dd>
          <p>Load the shared library. You should return a number which will be treated as a <code>void*</code>. On
          error you should return 0 (NULL). The number is passed as is to xDlSym/xDlClose so it can represent anything
          that is convenient for you (eg index into an array). You can use ctypes to load a library.</p>
          <pre>
def xDlOpen(name):
    return ctypes.cdll.LoadLibrary(name)._handle
</pre>
        </dd>

        <dt><strong>xDlSym(ptr, name)</strong></dt>

        <dd>
          <p>Returns the address of the named function which will be treated as a <code>void*</code>. On error you
          should return 0 (NULL). You can use ctypes:</p>
          <pre>
def xDlSym(ptr, name):
    return _ctypes.dlsym (ptr, name)  # Linux/Unix/Mac etc (note leading underscore)
    return ctypes.win32.kernel32.GetProcAddress (ptr, name)  # Windows
</pre>
        </dd>

        <dt><strong>xDlClose(ptr)</strong></dt>

        <dd>
          <p>Close/Unload the shared library. Use <code>_ctypes.dlclose</code> (Linux/Unix/Mac) or
          <code>_ctypes.FreeLibrary</code> (Windows).</p>
        </dd>

        <dt><strong>xDlError()</strong> (optional)</dt>

        <dd>
          <p>Return an error string describing the last error of xDlOpen or xDlSym. If you do not supply this routine
          then a generic message is used. To implement it, catch exceptions in xDlOpen/xDlSym, turn them into strings
          and return them in this routine. Note that the message may be truncated to 255 characters - see <a href=
          "http://www.sqlite.org/cvstrac/tktview?tn=3305">ticket 3305</a>. If you have an error or return None then the
          generic message will be used.</p>
        </dd>

        <dt><strong>xRandomness(numbytes)</strong></dt>

        <dd>
          <p>This method is called once when SQLite needs to seed the random number generator. It is called on the
          default VFS only. You can return less than the number of bytes requested including None. If you return more
          then the surplus is ignored. If you are inheriting, be aware that the Unix VFS implementation has a <a href=
          "http://www.sqlite.org/cvstrac/tktview?tn=3306">bug</a> where it will claim to provide no randomness.</p>
        </dd>

        <dt><strong>xSleep(microseconds)</strong></dt>

        <dd>
          <p>Pause execution on the thread for at least the specified number of microseconds (millionths of a second).
          You should return how many microseconds you actually requested the operating system to sleep for. This
          routine is typically called from the busy handler.</p>
        </dd>

        <dt><strong>xCurrentTime()</strong></dt>

        <dd>
          <p>Return the <a href="http://en.wikipedia.org/wiki/Julian_day">Julian Day Number</a> as a floating point
          number where the integer portion is the day and the fractional part is the time. Do not adjust for timezone
          (ie use <a href="http://en.wikipedia.org/wiki/Universal_Time">UTC</a>). Although SQLite allows for an error
          return, that is <a href="http://www.sqlite.org/cvstrac/tktview?tn=3394">ignored</a>.</p>
        </dd>

        <dt><strong>xGetLastError()</strong> (optional)</dt>

        <dd>
          <p>This method is to return text describing the last error that happened in this thread. If not implemented
          SQLite's more generic message is used. However the method is never called by SQLite as of 3.6.2.</p>
        </dd>
      </dl>

      <h3>File interface</h3>

      <p>You can get an overview in the <a href="http://sqlite.org/c3ref/io_methods.html">C documentation</a>.</p>

      <dl>
        <dt><strong>VFSFile(vfs, name, flags, excepthook=hookfunction)</strong> (Inheriting constructor)</dt>

        <dd>
          <p>If you want to inherit from an existing VFS then you must subclass <code>apsw.VFSFile</code> passing in
          the parameters above. If <i>vfs</i> is an empty string then the default VFS will be used. <i>flags</i> is a
          two item list with semantics documented in <code>xOpen</code> above. If excepthook is provided then it
          replaces the default one used as described in <a href="#vfsexceptions">VFS exceptions</a>.</p>
        </dd>

        <dt><strong>excepthook</strong></dt>

        <dd>
          <p>The function called when unexpected exceptions happen in the VFS file.</p>
        </dd>

        <dt><strong>xClose()</strong></dt>

        <dd>
          <p>Close the database. Note that even if you return an error you should still close the file.</p>
        </dd>

        <dt><strong>xRead(amount, offset)</strong></dt>

        <dd>
          <p>Read the specified amount of data starting at offset. You should make every effort to read all the data
          requested, or return an error. If you have the file open for non-blocking I/O or if signals happen then it is
          possible for the underlying operating system to do a partial read. You will need to request the remaining
          data. Except for empty files SQLite considers short reads to be a fatal error. Return the data as a string
          (Python 2), bytes (Python 3) or buffer (either Python version).</p>
        </dd>

        <dt><strong>xWrite(data, offset)</strong></dt>

        <dd>
          <p>Write the data starting at offset. You must write all the data requested, or return an error. If you have
          the file open for non-blocking I/O or if signals happen then it is possible for the underlying operating
          system to do a partial write. You will need to write the remaining data. The data will be a string (Python 2)
          or bytes (Python 3).</p>
        </dd>

        <dt><strong>xTruncate(size)</strong></dt>

        <dd>
          <p>Set the file length to <code>size</code> (which may be more or less than the current length).</p>
        </dd>

        <dt><strong>xSync(flags)</strong></dt>

        <dd>
          <p>Ensure data is on the disk platters (ie could survive a power failure immediately after the call returns)
          with the <a href="http://sqlite.org/c3ref/c_sync_dataonly.html">flags</a> detailing what needs to be
          synced.</p>
        </dd>

        <dt><strong>xFileSize()</strong></dt>

        <dd>
          <p>Return the size of the file in bytes.</p>
        </dd>

        <dt><strong>xLock(level)</strong></dt>

        <dd>
          <p>Increase the lock to the level specified which is one of the <a href=
          "http://sqlite.org/c3ref/c_lock_exclusive.html"><code>SQLITE_LOCK</code></a> family of constants. If you
          can't increase the lock level because someone else has locked it, then raise
          <code>apsw.BusyException</code>.</p>
        </dd>

        <dt><strong>xUnlock(level)</strong></dt>

        <dd>
          <p>Decrease the lock to the level specified which is one of the <a href=
          "http://sqlite.org/c3ref/c_lock_exclusive.html"><code>SQLITE_LOCK</code></a> family of constants.</p>
        </dd>

        <dt><strong>xCheckReservedLock()</strong></dt>

        <dd>
          <p>Returns True if any database connection (in this or another process) has a lock other than <a href=
          "http://sqlite.org/c3ref/c_lock_exclusive.html">SQLITE_LOCK_NONE or SQLITE_LOCK_SHARED</a>.</p>
        </dd>

        <dt><strong>xFileControl(op, ptr)</strong></dt>

        <dd>
          <p>Receives a <a href="http://sqlite.org/c3ref/file_control.html">file control</a> request. See <a href=
          "#filecontrol">Connection.filecontrol</a> for an example of how to pass a Python object to this routine.</p>
        </dd>

        <dt><strong>xSectorSize()</strong> (optional)</dt>

        <dd>
          <p>Return the native underlying sector size. SQLite uses this in determining the database page size. If you
          do not implement the function or have an error then 512 (the SQLite default) is returned.</p>
        </dd>

        <dt><strong>xDeviceCharacteristics()</strong> (optional)</dt>

        <dd>
          <p>Return <a href="http://sqlite.org/c3ref/c_iocap_atomic.html">I/O capabilities</a> (bitwise or appropriate
          values). If you do not implement the function or have an error then 0 (the SQLite default) is returned.</p>
        </dd>
      </dl>



</body>
</html>
